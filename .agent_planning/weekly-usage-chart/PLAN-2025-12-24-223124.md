# Sprint Plan: Weekly Usage Chart

**Generated**: 2025-12-24-223124
**Source**: STATUS-20251224.md (dashboard-parity)
**Epic**: brandon-fryslie_claude-code-proxy-loz
**Topic**: weekly-usage-chart

---

## Sprint Goal

Add a 7-day stacked bar chart showing daily token usage with per-model breakdowns, matching the old dashboard's weekly chart implementation.

---

## Scope

### In Scope
- 7-day (Sunday-Saturday) bar chart component
- Stacked model segments (Opus/Sonnet/Haiku) with distinct colors
- Hover tooltips showing per-model token breakdown
- Average line indicator across the week
- Y-axis with formatted labels (K/M notation)
- Integration with existing `/api/stats` endpoint
- Responsive styling consistent with new dashboard design
- Week boundary calculation (Sunday-Saturday)

### Out of Scope
- Date navigation controls (separate epic: date-navigation-filtering)
- Request count display (focus on token usage only)
- Per-hour breakdown (that's the hourly chart, already exists)
- Export/download functionality
- Animation/transitions
- Model filtering (separate epic: model-filter-dropdown)

---

## Context from STATUS Report

**From STATUS-20251224.md, Section: "Old Dashboard Feature Inventory"**:
> **Usage Dashboard** | `UsageDashboard.tsx` (451 LOC + CSS) | Weekly + hourly charts, model breakdown

**From Section: "Stats Flow"**:
> **Old Dashboard**:
> 1. Week boundaries: Calculate Sunday-Saturday
> 2. Parallel fetch: `/api/stats`, `/api/stats/hourly`, `/api/stats/models`
> 3. Smart refetch: Same week? Only hourly. New week? Fetch all.
> 4. Custom CSS charts with stacked model breakdowns

**From Section: "Feature Gap Analysis - Critical Gaps"**:
> | **Week-Aware Navigation** | ✅ | ❌ | Medium | Medium - date boundary logic |

**Key Implementation Details** (lines 55-180 of `UsageDashboard.tsx`):
- Uses `useMemo` to process daily stats into 7-day week view
- Calculates Sunday-Saturday boundaries from `selectedDate`
- Stacks Opus/Sonnet/Haiku segments proportionally
- Shows "THIS WEEK" label or date range for past weeks
- Average line positioned at mean tokens/day (excluding zero days)
- Hover shows per-model breakdown with color-coded dots

---

## Work Items

### 1. Create WeeklyChart Component

**Status**: Not Started
**Complexity**: Medium
**Dependencies**: None
**Spec Reference**: UsageDashboard.tsx lines 55-311 • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Port the weekly chart rendering logic from old dashboard's `UsageDashboard.tsx` to a new standalone component in the new dashboard. The component will render a 7-day bar chart with stacked model segments.

#### Acceptance Criteria
- [ ] Component accepts `DashboardStats` type with `dailyStats` array
- [ ] Component accepts `selectedDate` prop for week calculation
- [ ] Renders exactly 7 bars (Sunday through Saturday)
- [ ] Each bar shows stacked segments for Opus (purple), Sonnet (blue), Haiku (green)
- [ ] Bar height scales proportionally to max tokens in the week
- [ ] Empty days show minimum 4% height bar (matching old dashboard)
- [ ] Y-axis displays 3 labels: max, 50%, and 0
- [ ] Token values formatted with K/M notation (e.g., "2.5M")

#### Technical Notes
- Use CSS Grid or Flexbox for bar layout (avoid Recharts for consistency with old dashboard)
- Model color constants: Opus `#9333ea`, Sonnet `#3b82f6`, Haiku `#10b981`
- Calculate stacked heights: `(modelTokens / totalDayTokens) * barHeightPercent`
- Extract model tokens using key search: `modelKeys.find(k => k.includes('opus'))`

---

### 2. Implement Week Boundary Logic

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None
**Spec Reference**: UsageDashboard.tsx lines 67-90 • **Status Reference**: STATUS-20251224.md "Stats Flow"

#### Description
Create a utility function to calculate Sunday-Saturday week boundaries for any given date, matching the old dashboard's behavior.

#### Acceptance Criteria
- [ ] Function accepts a Date object and returns `{ weekStart: Date, weekEnd: Date }`
- [ ] `weekStart` is always Sunday at 00:00:00
- [ ] `weekEnd` is always Saturday at 23:59:59
- [ ] Works correctly across month boundaries
- [ ] Works correctly across year boundaries
- [ ] Tested with dates in different weeks
- [ ] Returns local timezone dates (not UTC)

#### Technical Notes
- Algorithm: `weekStart.setDate(selectedDate.getDate() - selectedDate.getDay())`
- Place in `lib/utils.ts` for reusability
- Used by both chart rendering and API fetching logic

---

### 3. Add Hover Tooltips with Model Breakdown

**Status**: Not Started
**Complexity**: Medium
**Dependencies**: Work Item #1 (Create WeeklyChart Component)
**Spec Reference**: UsageDashboard.tsx lines 265-294 • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Implement hover functionality showing per-model token breakdown when user hovers over a day bar.

#### Acceptance Criteria
- [ ] Tooltip appears on mouse enter, disappears on mouse leave
- [ ] Shows day name (e.g., "Mon", "Tue")
- [ ] Lists each model with non-zero tokens
- [ ] Each model shows: colored dot + label + formatted token count
- [ ] Shows total tokens for the day at bottom
- [ ] Tooltip positioned above/below bar to avoid clipping
- [ ] Only shows for days with data (tokens > 0)
- [ ] Tooltip remains visible while hovering over it

#### Technical Notes
- Use React state: `const [hoveredDay, setHoveredDay] = useState<number | null>(null)`
- Position tooltip with absolute positioning relative to bar container
- Color dots using same model color constants
- Tooltip styling: white background, border, shadow, rounded corners

---

### 4. Add Average Line Indicator

**Status**: Not Started
**Complexity**: Low
**Dependencies**: Work Item #1 (Create WeeklyChart Component)
**Spec Reference**: UsageDashboard.tsx lines 154-157, 299-309 • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Display a horizontal line showing the average daily tokens across the week, excluding days with zero usage.

#### Acceptance Criteria
- [ ] Line positioned at correct height based on average calculation
- [ ] Average calculated excluding days with zero tokens
- [ ] "avg" label displayed on the line
- [ ] Line spans full chart width
- [ ] Line only shown if `avgDayTokens > 0`
- [ ] Visually distinct (dashed or dotted line)
- [ ] Does not obscure bar data

#### Technical Notes
- Calculate: `avgDayTokens = sum(tokens) / daysWithData.length`
- Position: `bottom: ${(avgDayTokens / maxDayTokens) * 100}%`
- Use CSS for line styling (border-top with dashed style)

---

### 5. Implement Week Label Logic

**Status**: Not Started
**Complexity**: Low
**Dependencies**: Work Item #2 (Implement Week Boundary Logic)
**Spec Reference**: UsageDashboard.tsx lines 120-151 • **Status Reference**: STATUS-20251224.md "Stats Flow"

#### Description
Display dynamic week label showing "THIS WEEK" for current week or date range for past weeks.

#### Acceptance Criteria
- [ ] Shows "THIS WEEK" when week contains today
- [ ] Shows "Nov 22 - 28" format for past weeks (same month)
- [ ] Shows "Nov 22 - Dec 5" format when crossing months
- [ ] Uses short month names (Jan, Feb, Mar...)
- [ ] Label updates when week changes
- [ ] Always shows date range for non-current weeks

#### Technical Notes
- Check if week contains today: `days.some(day => day.isToday)`
- Parse dates as local (not UTC) to avoid timezone shifts
- Format: `firstDay.toLocaleDateString('en-US', { month: 'short' })`

---

### 6. Integrate with Usage Page

**Status**: Not Started
**Complexity**: Low
**Dependencies**: All previous work items
**Spec Reference**: dashboard/src/pages/Usage.tsx • **Status Reference**: STATUS-20251224.md "New Dashboard Feature Inventory"

#### Description
Replace or augment the existing Usage page charts with the new WeeklyChart component.

#### Acceptance Criteria
- [ ] WeeklyChart component imported and rendered in Usage.tsx
- [ ] Component receives data from existing `useWeeklyStats()` hook
- [ ] Chart displays correctly within page layout
- [ ] Maintains responsive behavior
- [ ] No layout shifts when loading
- [ ] Loading state shows placeholder or skeleton
- [ ] Error state displays user-friendly message
- [ ] Chart updates when data refetches

#### Technical Notes
- Usage page already fetches `/api/stats` data via TanStack Query
- Verify `dailyStats` shape matches expected `DashboardStats` type
- May need to transform API response to match old dashboard format
- Consider showing both Recharts (for new features) and custom chart (for parity)

---

## Dependencies

### External Dependencies
- None (all APIs already exist)

### Internal Dependencies
- `lib/types.ts` - `DashboardStats` type definition
- `lib/api.ts` - `useWeeklyStats()` hook
- `lib/utils.ts` - Date utilities (to be created)

### API Dependencies
- `GET /api/stats?start=...&end=...` - Already implemented
- Response includes `dailyStats` with per-model breakdown

---

## Risks

### Medium Risk: CSS Chart vs Recharts Consistency
**Issue**: New dashboard uses Recharts library, old uses custom CSS charts. Mixing styles may look inconsistent.

**Mitigation**:
- Use same colors/fonts as Recharts components
- Add Tailwind classes for consistency
- Review with designer/stakeholder before finalizing

**Fallback**: Build weekly chart using Recharts BarChart with stacked bars

### Low Risk: Model Name Variations
**Issue**: Backend may return different model name formats (e.g., "claude-opus-4" vs "opus-4-5").

**Mitigation**:
- Use substring matching: `model.includes('opus')`
- Add test coverage for various model name formats
- Document expected formats in code comments

---

## Testing Strategy

### Unit Tests
- [ ] Week boundary calculation with various dates
- [ ] Average calculation with mixed zero/non-zero days
- [ ] Model color selection for various model names
- [ ] Token formatting (1234 → "1.2K", 1234567 → "1.2M")
- [ ] Tooltip show/hide logic

### Integration Tests
- [ ] Chart renders with real API data
- [ ] Chart updates when date changes
- [ ] Hover interactions work correctly
- [ ] No errors with empty data

### Visual Tests
- [ ] Compare side-by-side with old dashboard
- [ ] Verify colors match model conventions
- [ ] Check tooltip positioning at edges
- [ ] Test responsive behavior at various widths

---

## Definition of Done

See `DOD-2025-12-24-223124.md` for complete acceptance criteria checklist.

---

## Estimated Complexity

**Overall**: MEDIUM

**Breakdown**:
- Component creation: ~150 LOC (porting from 451 LOC original)
- Week logic: ~30 LOC
- Tooltips: ~50 LOC
- Average line: ~20 LOC
- Week label: ~30 LOC
- Integration: ~20 LOC
- Tests: ~100 LOC
- **Total**: ~400 LOC

**Confidence**: HIGH - direct port of existing, working code
