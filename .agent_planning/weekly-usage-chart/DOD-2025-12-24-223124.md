# Definition of Done: Weekly Usage Chart

**Generated**: 2025-12-24-223124
**Plan**: PLAN-2025-12-24-223124.md
**Epic**: brandon-fryslie_claude-code-proxy-loz

---

## Sprint Scope

This sprint delivers:
1. WeeklyChart component with stacked model breakdown
2. Week boundary calculation utilities
3. Interactive hover tooltips
4. Average line indicator
5. Dynamic week labels
6. Integration with Usage page

Deferred: Date navigation controls (separate epic), model filtering UI

---

## Acceptance Criteria

### WeeklyChart Component
- [ ] Accepts `DashboardStats` with `dailyStats` prop
- [ ] Accepts `selectedDate` prop
- [ ] Renders 7 bars (Sunday-Saturday)
- [ ] Stacked segments: Opus (purple #9333ea), Sonnet (blue #3b82f6), Haiku (green #10b981)
- [ ] Bar heights scale to max tokens
- [ ] Empty days show minimum 4% bar
- [ ] Y-axis shows max, 50%, 0 labels
- [ ] Token values use K/M notation

### Week Boundary Logic
- [ ] Function returns `{ weekStart: Date, weekEnd: Date }`
- [ ] `weekStart` always Sunday 00:00:00
- [ ] `weekEnd` always Saturday 23:59:59
- [ ] Works across month boundaries
- [ ] Works across year boundaries
- [ ] Returns local timezone (not UTC)
- [ ] Placed in `lib/utils.ts`

### Hover Tooltips
- [ ] Tooltip appears on mouse enter
- [ ] Tooltip disappears on mouse leave
- [ ] Shows day name (Mon, Tue, etc)
- [ ] Lists models with non-zero tokens
- [ ] Each model: colored dot + label + token count
- [ ] Shows total tokens at bottom
- [ ] Positioned to avoid clipping
- [ ] Only shows for days with data
- [ ] Remains visible while hovering

### Average Line
- [ ] Positioned at correct height
- [ ] Excludes zero-token days from calculation
- [ ] Shows "avg" label
- [ ] Spans full chart width
- [ ] Only shown if avgDayTokens > 0
- [ ] Visually distinct (dashed/dotted)
- [ ] Does not obscure bars

### Week Label
- [ ] Shows "THIS WEEK" for current week
- [ ] Shows "Nov 22 - 28" for same-month ranges
- [ ] Shows "Nov 22 - Dec 5" when crossing months
- [ ] Uses short month names
- [ ] Updates when week changes
- [ ] Always shows range for past weeks

### Integration
- [ ] Component imported in Usage.tsx
- [ ] Receives data from useWeeklyStats()
- [ ] Displays correctly in page layout
- [ ] Responsive behavior maintained
- [ ] Loading state shows placeholder
- [ ] Error state shows message
- [ ] Updates on data refetch
- [ ] No console errors

### Testing
- [ ] Unit tests for week boundary calculation
- [ ] Unit tests for average calculation
- [ ] Unit tests for model color selection
- [ ] Unit tests for token formatting
- [ ] Integration test with API data
- [ ] Visual comparison with old dashboard
- [ ] Hover interactions tested
- [ ] Responsive behavior verified

### Code Quality
- [ ] TypeScript types defined
- [ ] No eslint warnings
- [ ] Component documented with JSDoc
- [ ] Follows new dashboard styling patterns
- [ ] Accessible (ARIA labels where needed)

---

## Implementation Checklist

### Phase 1: Core Component
- [ ] Create `components/charts/WeeklyChart.tsx`
- [ ] Add week boundary util in `lib/utils.ts`
- [ ] Implement 7-bar layout with CSS
- [ ] Add Y-axis labels
- [ ] Add model color constants

### Phase 2: Data Integration
- [ ] Process dailyStats into 7-day array
- [ ] Calculate stacked heights per model
- [ ] Implement token formatting
- [ ] Calculate max tokens for scaling

### Phase 3: Interactivity
- [ ] Add hover state management
- [ ] Create tooltip component
- [ ] Implement per-model breakdown display
- [ ] Position tooltips correctly

### Phase 4: Polish
- [ ] Add average line calculation
- [ ] Implement week label logic
- [ ] Add loading/error states
- [ ] Responsive styling

### Phase 5: Integration & Testing
- [ ] Integrate into Usage.tsx
- [ ] Write unit tests
- [ ] Visual QA against old dashboard
- [ ] Cross-browser testing

---

## Verification Steps

1. **Compare with Old Dashboard**
   - Open old dashboard at `http://localhost:5173`
   - Open new dashboard at `http://localhost:5174/usage`
   - Verify weekly charts show identical data
   - Verify colors match
   - Verify tooltip contents match

2. **Test Week Boundaries**
   - Select date in middle of week → verify Sunday-Saturday range
   - Select Sunday → verify correct week
   - Select Saturday → verify correct week
   - Select date across month boundary → verify labels

3. **Test Tooltips**
   - Hover each day → verify tooltip shows
   - Verify model breakdown matches bar segments
   - Verify totals are correct
   - Check edge cases (first/last day)

4. **Test Average Line**
   - Week with all days → verify average correct
   - Week with some zero days → verify excludes zeros
   - Week with all zeros → verify no line shown

5. **Test Responsive**
   - Resize browser → verify chart adapts
   - Mobile viewport → verify readable
   - Tablet viewport → verify layout

---

## Success Metrics

- [ ] Side-by-side comparison with old dashboard shows matching data
- [ ] All 7 bars render correctly
- [ ] Tooltips show on all days with data
- [ ] Average line appears and is accurate
- [ ] No layout shifts or visual glitches
- [ ] Component renders in <100ms
- [ ] Zero console errors/warnings
