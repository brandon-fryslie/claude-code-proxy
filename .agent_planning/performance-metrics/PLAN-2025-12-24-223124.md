# Sprint Plan: Performance Metrics Enhancement

**Generated**: 2025-12-24-223124
**Source**: STATUS-20251224.md (dashboard-parity)
**Epic**: brandon-fryslie_claude-code-proxy-eee
**Topic**: performance-metrics

---

## Sprint Goal

Enhance the existing Performance page with time-series trend charts, latency distribution histograms, and improved percentile displays to provide comprehensive performance insights over time.

---

## Scope

### In Scope
- Response time trend chart (time-series line chart)
- Latency distribution histogram (frequency by time bucket)
- Enhanced percentile display with visual indicators
- Time range selector (today/week/month)
- Comparison indicators (vs previous period)
- Integration with existing `/api/stats/performance` endpoint
- Cache hit rate display (if available in backend)
- TTFB (Time to First Byte) vs total response comparison

### Out of Scope
- Real-time streaming updates (polling is acceptable)
- Alerting/notifications for performance degradation
- Custom percentile selection (stick to P50/P95/P99)
- Provider-specific drill-downs (that's a separate epic)
- Historical data export (CSV/JSON download)
- Performance baselines/targets configuration

---

## Context from STATUS Report

**From STATUS-20251224.md, Section: "New Dashboard Feature Inventory"**:
> | **Performance** | `Performance.tsx` | 176 | ✅ NEW | P50/P95/P99 stats (not in old dashboard!) |

**From Section: "New Features (Not in Old)"**:
> | **Performance Stats (P50/P95/P99)** | ✅ COMPLETE | High |

**From Section: "API Coverage"**:
> | `/api/stats/performance` | ❌ | ✅ | ✅ |

**Existing Implementation** (Performance.tsx):
- Already shows P50/P95/P99 stats cards
- Bar chart showing avg/P50/P95/P99 by provider:model
- Detailed stats table with TTFB
- Uses Recharts BarChart component
- Fetches from `/api/stats/performance` with date range

**Current Gaps**:
- No trend over time (just snapshot)
- No distribution visualization
- No comparison to previous periods
- No time range selection (hardcoded to "today")
- Limited context for whether metrics are good/bad

---

## Work Items

### 1. Add Time Range Selector

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None
**Spec Reference**: Performance.tsx lines 7-8 • **Status Reference**: STATUS-20251224.md "New Dashboard Feature Inventory"

#### Description
Add a dropdown or button group allowing users to select time range (Today, Last 7 Days, Last 30 Days) for performance data.

#### Acceptance Criteria
- [ ] Component renders 3 options: Today, Last 7 Days, Last 30 Days
- [ ] Default selection is "Today"
- [ ] Selection updates URL query params (e.g., `?range=7d`)
- [ ] Selection persists across page refreshes
- [ ] API calls update with new date range
- [ ] Loading state shows while fetching new data
- [ ] Charts update to reflect selected range
- [ ] Range selector positioned near page header

#### Technical Notes
- Use button group similar to model filter in old dashboard
- Calculate date ranges:
  ```typescript
  function getDateRange(range: 'today' | '7d' | '30d') {
    const end = new Date()
    const start = new Date()
    if (range === '7d') start.setDate(end.getDate() - 7)
    if (range === '30d') start.setDate(end.getDate() - 30)
    return { start: start.toISOString(), end: end.toISOString() }
  }
  ```

---

### 2. Create Response Time Trend Chart

**Status**: Not Started
**Complexity**: Medium
**Dependencies**: Work Item #1 (Add Time Range Selector)
**Spec Reference**: Performance.tsx lines 85-135 • **Status Reference**: STATUS-20251224.md "New Dashboard Feature Inventory"

#### Description
Add a line chart showing P50/P95/P99 response times over the selected time range, allowing users to spot trends and anomalies.

#### Acceptance Criteria
- [ ] Line chart with time (X-axis) and response time in ms (Y-axis)
- [ ] Shows 3 lines: P50 (blue), P95 (orange), P99 (red)
- [ ] Time axis formatted appropriately (hours for today, days for week/month)
- [ ] Tooltip shows exact timestamp and values
- [ ] Legend clearly labels each percentile
- [ ] Chart responsive to container width
- [ ] No data shows empty state message
- [ ] Loading state shows skeleton/spinner
- [ ] Uses Recharts LineChart component

#### Technical Notes
- Backend may need enhancement to return time-bucketed data
- For "today": bucket by hour (24 data points)
- For "7d": bucket by day (7 data points)
- For "30d": bucket by day (30 data points)
- Position below existing stat cards, above bar chart

---

### 3. Add Latency Distribution Histogram

**Status**: Not Started
**Complexity**: Medium
**Dependencies**: None
**Spec Reference**: Performance.tsx • **Status Reference**: STATUS-20251224.md "New Features"

#### Description
Display a histogram showing the frequency distribution of response times across buckets (e.g., 0-1s, 1-2s, 2-5s, 5-10s, 10s+).

#### Acceptance Criteria
- [ ] Bar chart with time buckets (X-axis) and request count (Y-axis)
- [ ] Buckets: <500ms, 500ms-1s, 1-2s, 2-5s, 5-10s, 10-30s, >30s
- [ ] Bars colored by severity (green for fast, red for slow)
- [ ] Tooltip shows bucket range and request count
- [ ] Shows percentage of total requests
- [ ] No data shows empty state
- [ ] Loading state shows skeleton
- [ ] Uses Recharts BarChart component

#### Technical Notes
- Backend may need enhancement to return bucketed counts
- Alternative: Calculate client-side from individual request data
- Position below trend chart
- Color scheme:
  - <500ms: green (#10b981)
  - 500ms-1s: light green (#84cc16)
  - 1-2s: yellow (#eab308)
  - 2-5s: orange (#f97316)
  - 5-10s: light red (#fb923c)
  - 10-30s: red (#ef4444)
  - >30s: dark red (#dc2626)

---

### 4. Add Percentile Visual Indicators

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None
**Spec Reference**: Performance.tsx lines 54-83 • **Status Reference**: STATUS-20251224.md "New Dashboard Feature Inventory"

#### Description
Enhance the percentile stat cards with visual indicators (progress bars or sparklines) showing relative performance and trends.

#### Acceptance Criteria
- [ ] Each stat card includes a small horizontal bar indicator
- [ ] Bar fill represents percentile value relative to max expected (e.g., 30s)
- [ ] Bar color indicates health: green (<2s), yellow (2-5s), orange (5-10s), red (>10s)
- [ ] Optional: Small sparkline showing trend over past hours/days
- [ ] Tooltip on hover shows context (e.g., "This is 20% faster than yesterday")
- [ ] Visual indicators do not clutter existing card design
- [ ] Responsive: bars scale with card width

#### Technical Notes
- Simple horizontal bar under the value:
  ```tsx
  <div className="w-full bg-gray-200 rounded h-1 mt-2">
    <div className="bg-green-500 h-1 rounded" style={{ width: '30%' }} />
  </div>
  ```
- Color thresholds configurable or based on percentiles

---

### 5. Add Comparison to Previous Period

**Status**: Not Started
**Complexity**: Medium
**Dependencies**: Work Item #1 (Add Time Range Selector)
**Spec Reference**: Performance.tsx lines 54-83 • **Status Reference**: STATUS-20251224.md "New Dashboard Feature Inventory"

#### Description
Show comparison indicators (up/down arrows, percentage change) comparing current period metrics to the previous equivalent period.

#### Acceptance Criteria
- [ ] Each stat card shows comparison to previous period
- [ ] Displays percentage change (e.g., "+15%" or "-8%")
- [ ] Up arrow (↑) for increased latency (red/bad)
- [ ] Down arrow (↓) for decreased latency (green/good)
- [ ] Comparison period defined by selected range:
  - Today → vs yesterday
  - Last 7 days → vs previous 7 days
  - Last 30 days → vs previous 30 days
- [ ] Tooltip explains comparison (e.g., "15% slower than yesterday")
- [ ] No data for previous period shows "--" or "N/A"
- [ ] API fetches both current and previous period data

#### Technical Notes
- Fetch two date ranges in parallel:
  ```typescript
  const current = usePerformanceStats({ start, end })
  const previous = usePerformanceStats({ start: prevStart, end: prevEnd })
  ```
- Calculate change: `((current - previous) / previous) * 100`
- Position comparison text/icon next to main value

---

### 6. Add Cache Hit Rate Display

**Status**: Not Started
**Complexity**: Low
**Dependencies**: Backend API enhancement (if not already available)
**Spec Reference**: Performance.tsx • **Status Reference**: STATUS-20251224.md "New Features"

#### Description
Display cache hit rate percentage and impact on performance, if backend tracks prompt caching.

#### Acceptance Criteria
- [ ] New stat card showing "Cache Hit Rate"
- [ ] Displays percentage (e.g., "78%")
- [ ] Shows token savings or latency improvement
- [ ] Tooltip explains cache benefits
- [ ] Only shown if backend provides cache data
- [ ] Empty state if no cache data available
- [ ] Positioned alongside other stat cards

#### Technical Notes
- Check if `/api/stats/performance` response includes cache metrics
- If not, this item may be deferred pending backend implementation
- Cache hit rate: `(cached_tokens / total_input_tokens) * 100`

---

### 7. Add TTFB vs Total Response Comparison

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None (data already in table)
**Spec Reference**: Performance.tsx lines 152-166 • **Status Reference**: STATUS-20251224.md "New Dashboard Feature Inventory"

#### Description
Visualize the relationship between Time to First Byte (TTFB) and total response time to identify streaming vs processing bottlenecks.

#### Acceptance Criteria
- [ ] Scatter plot or stacked bar showing TTFB vs total response
- [ ] Each point/bar represents a model or time period
- [ ] X-axis: TTFB, Y-axis: Total response time
- [ ] Or: Stacked bar with TTFB and (Total - TTFB)
- [ ] Tooltip shows both values
- [ ] Helps identify models with slow TTFB or slow streaming
- [ ] Uses Recharts ScatterChart or stacked BarChart
- [ ] Positioned below histogram

#### Technical Notes
- Data already available in `perfStats.stats` (avgFirstByteMs, avgResponseMs)
- Stacked bar approach:
  - Bottom segment: TTFB (blue)
  - Top segment: Streaming time (response - TTFB) (purple)
- Alternative: Scatter plot with TTFB on X, Total on Y, points sized by request count

---

## Dependencies

### External Dependencies
- None (all APIs already exist or need minor enhancements)

### Internal Dependencies
- `lib/types.ts` - `PerformanceStatsResponse` type
- `lib/api.ts` - `usePerformanceStats()` hook
- `lib/utils.ts` - Date range utilities

### API Dependencies
- `GET /api/stats/performance?start=...&end=...` - Already implemented
- **Potential Enhancements Needed**:
  - Time-bucketed data for trend chart (current API may return aggregates only)
  - Latency distribution buckets (current API may need to calculate)
  - Previous period data (may need separate query or expanded response)
  - Cache metrics (may not exist yet)

---

## Risks

### Medium Risk: Backend API Enhancements Required
**Issue**: Some visualizations (trend chart, histogram) may require backend to return more granular data than currently provided.

**Mitigation**:
- Review current `/api/stats/performance` response structure
- Identify which enhancements are needed
- File backend work items if necessary
- Implement client-side calculations as fallback (e.g., fetch all requests and bucket client-side)

**Fallback**: Defer trend/histogram to separate sprint, focus on enhancing existing displays

### Low Risk: Performance of Client-Side Calculations
**Issue**: If backend doesn't provide bucketed data, client-side calculation may be slow with 1000s of requests.

**Mitigation**:
- Use Web Workers for heavy calculations
- Cache calculated results
- Limit data fetched (e.g., sample 1000 most recent requests)

**Fallback**: Show simplified views or aggregates only

---

## Testing Strategy

### Unit Tests
- [ ] Date range calculation functions
- [ ] Percentage change calculation
- [ ] Bucket allocation for histogram
- [ ] Color selection based on latency thresholds

### Integration Tests
- [ ] Charts render with API data
- [ ] Time range selector updates charts
- [ ] Comparison indicators show correct values
- [ ] Loading/error states display correctly

### Visual Tests
- [ ] Trend chart shows clear patterns
- [ ] Histogram bars sized correctly
- [ ] Stat card indicators are readable
- [ ] Comparison arrows/colors make sense
- [ ] Responsive behavior on various widths

### Performance Tests
- [ ] Page loads in <2s with typical data
- [ ] Chart rendering does not block UI
- [ ] No memory leaks with frequent range changes

---

## Definition of Done

See `DOD-2025-12-24-223124.md` for complete acceptance criteria checklist.

---

## Estimated Complexity

**Overall**: MEDIUM-HIGH

**Breakdown**:
- Time range selector: ~40 LOC
- Trend chart: ~120 LOC (+ backend enhancement?)
- Histogram: ~100 LOC (+ backend enhancement?)
- Visual indicators: ~60 LOC
- Comparison logic: ~80 LOC
- Cache display: ~30 LOC
- TTFB comparison: ~60 LOC
- Tests: ~100 LOC
- **Total**: ~590 LOC (frontend only)

**Confidence**: MEDIUM - depends on backend data availability

**Backend Work**: Potentially 2-4 hours to add time-bucketed and distribution endpoints
