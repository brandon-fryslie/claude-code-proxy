# Definition of Done: Performance Metrics Enhancement

**Generated**: 2025-12-24-223124
**Plan**: PLAN-2025-12-24-223124.md
**Epic**: brandon-fryslie_claude-code-proxy-eee

---

## Sprint Scope

This sprint delivers:
1. Time range selector (Today/7d/30d)
2. Response time trend chart (line chart)
3. Latency distribution histogram
4. Enhanced percentile visual indicators
5. Comparison to previous period
6. TTFB vs Total response visualization

Deferred: Cache hit rate display (pending backend data), real-time updates, custom percentiles

---

## Acceptance Criteria

### Time Range Selector
- [ ] Renders 3 options: Today, Last 7 Days, Last 30 Days
- [ ] Default is "Today"
- [ ] Updates URL query params
- [ ] Persists across refreshes
- [ ] API calls update with new range
- [ ] Shows loading state
- [ ] Charts update on selection
- [ ] Positioned near header

### Response Time Trend Chart
- [ ] Line chart with time (X) and ms (Y)
- [ ] Shows P50, P95, P99 lines
- [ ] P50 blue, P95 orange, P99 red
- [ ] Time axis formatted by range
- [ ] Tooltip shows timestamp + values
- [ ] Legend labels percentiles
- [ ] Responsive to width
- [ ] Empty state message
- [ ] Loading skeleton
- [ ] Uses Recharts LineChart

### Latency Distribution Histogram
- [ ] Bar chart with buckets (X) and count (Y)
- [ ] Buckets: <500ms, 500ms-1s, 1-2s, 2-5s, 5-10s, 10-30s, >30s
- [ ] Color by severity (green→red)
- [ ] Tooltip shows range + count
- [ ] Shows percentage of total
- [ ] Empty state message
- [ ] Loading skeleton
- [ ] Uses Recharts BarChart
- [ ] Positioned below trend chart

### Percentile Visual Indicators
- [ ] Each stat card has horizontal bar
- [ ] Bar represents value vs max (30s)
- [ ] Color: green (<2s), yellow (2-5s), orange (5-10s), red (>10s)
- [ ] Optional sparkline for trend
- [ ] Tooltip with context
- [ ] Does not clutter design
- [ ] Responsive bars

### Comparison to Previous Period
- [ ] Each stat shows % change
- [ ] Up arrow (↑) for worse (red)
- [ ] Down arrow (↓) for better (green)
- [ ] Comparison period matches range:
  - Today → yesterday
  - 7d → previous 7d
  - 30d → previous 30d
- [ ] Tooltip explains comparison
- [ ] "N/A" if no previous data
- [ ] Fetches both periods

### TTFB vs Total Comparison
- [ ] Scatter or stacked bar chart
- [ ] X-axis: TTFB, Y-axis: Total response
- [ ] Or stacked: TTFB + streaming time
- [ ] Tooltip shows both values
- [ ] Identifies slow TTFB vs slow streaming
- [ ] Uses Recharts chart component
- [ ] Positioned below histogram

### Data Integration
- [ ] Time range calculates correct dates
- [ ] API receives start/end params
- [ ] Handles no data gracefully
- [ ] Handles API errors
- [ ] Shows loading states
- [ ] Caches with TanStack Query
- [ ] Refetches on range change

### Testing
- [ ] Unit: date range calculation
- [ ] Unit: percentage change
- [ ] Unit: bucket allocation
- [ ] Unit: color thresholds
- [ ] Integration: charts render
- [ ] Integration: selector updates charts
- [ ] Integration: comparison values correct
- [ ] Visual: trend chart clear
- [ ] Visual: histogram sized right
- [ ] Visual: indicators readable
- [ ] Performance: page loads <2s

### Code Quality
- [ ] TypeScript types defined
- [ ] No eslint warnings
- [ ] Components documented
- [ ] Follows new dashboard patterns
- [ ] Accessible charts
- [ ] No console errors

---

## Implementation Checklist

### Phase 1: Time Range Selector
- [ ] Create date range utility in `lib/utils.ts`
- [ ] Add button group component
- [ ] Wire to URL query params
- [ ] Update Performance.tsx to use selected range
- [ ] Add loading state handling

### Phase 2: Trend Chart
- [ ] Verify backend returns time-bucketed data
- [ ] Create TrendChart component
- [ ] Configure Recharts LineChart
- [ ] Add P50/P95/P99 lines with colors
- [ ] Format time axis
- [ ] Add tooltip + legend
- [ ] Integrate into Performance.tsx

### Phase 3: Histogram
- [ ] Define bucket ranges
- [ ] Process API data into buckets (or request from backend)
- [ ] Create HistogramChart component
- [ ] Configure Recharts BarChart
- [ ] Apply color gradient
- [ ] Add tooltip with percentages
- [ ] Integrate into Performance.tsx

### Phase 4: Visual Indicators
- [ ] Add horizontal bar to stat cards
- [ ] Calculate bar width from value
- [ ] Apply color based on thresholds
- [ ] Add tooltip with context
- [ ] Test responsive behavior

### Phase 5: Comparisons
- [ ] Fetch previous period data
- [ ] Calculate percentage changes
- [ ] Add up/down indicators
- [ ] Apply red/green colors
- [ ] Add tooltips explaining comparison
- [ ] Handle missing data

### Phase 6: TTFB Visualization
- [ ] Extract TTFB and total response from API
- [ ] Create stacked or scatter chart component
- [ ] Configure Recharts chart
- [ ] Add tooltip
- [ ] Integrate into Performance.tsx

### Phase 7: Testing & QA
- [ ] Write unit tests
- [ ] Write integration tests
- [ ] Visual QA on all chart types
- [ ] Test responsive behavior
- [ ] Test with various data sets
- [ ] Performance profiling

---

## Verification Steps

1. **Test Time Range Selector**
   - Click "Today" → verify today's data loads
   - Click "Last 7 Days" → verify 7 days load
   - Click "Last 30 Days" → verify 30 days load
   - Refresh page → verify selection persists
   - Check URL params update

2. **Test Trend Chart**
   - Today: verify hourly buckets (24 points)
   - 7d: verify daily buckets (7 points)
   - 30d: verify daily buckets (30 points)
   - Hover points → verify tooltip shows time + values
   - Verify P50 < P95 < P99 ordering

3. **Test Histogram**
   - Verify buckets cover all requests
   - Verify bucket counts sum to total requests
   - Verify color gradient fast→slow
   - Hover bars → verify tooltip shows range + count + %

4. **Test Visual Indicators**
   - Fast latency (<2s) → green bar
   - Medium latency (2-5s) → yellow bar
   - Slow latency (5-10s) → orange bar
   - Very slow (>10s) → red bar
   - Hover → verify context tooltip

5. **Test Comparisons**
   - Today vs Yesterday: verify arrow direction
   - 7d vs previous 7d: verify % calculation
   - Improved latency → down arrow + green
   - Worse latency → up arrow + red
   - No previous data → "N/A"

6. **Test TTFB Chart**
   - Verify TTFB segment shown
   - Verify streaming segment shown
   - Verify TTFB + streaming = total response
   - Identify models with slow TTFB
   - Identify models with slow streaming

7. **Test Edge Cases**
   - No data → empty state messages
   - API error → error messages
   - Loading → skeleton/spinner
   - Single data point → charts render
   - Large latencies (>30s) → charts scale

8. **Test Responsive**
   - Desktop → all charts full width
   - Tablet → charts adapt
   - Mobile → charts stack/scroll
   - Tooltips don't clip

---

## Success Metrics

- [ ] All 3 time ranges selectable and functional
- [ ] Trend chart shows clear performance patterns
- [ ] Histogram reveals latency distribution
- [ ] Visual indicators provide at-a-glance health
- [ ] Comparisons show performance changes
- [ ] TTFB chart identifies bottlenecks
- [ ] No layout shifts or glitches
- [ ] Charts render in <500ms
- [ ] Zero console errors/warnings
- [ ] All tests passing
- [ ] Page provides actionable performance insights
