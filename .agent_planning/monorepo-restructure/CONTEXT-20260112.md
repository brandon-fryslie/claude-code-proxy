# Implementation Context: Proxy-Core Extraction

**Document Type**: Implementation Reference
**Audience**: Engineer executing Sprint 1
**Purpose**: Detailed operational guidance with exact file operations and build commands

---

## File Operations Reference

### Files to Copy (to proxy-core/internal/)

```bash
# Configuration package
cp proxy/internal/config/config.go proxy-core/internal/config/
cp proxy/internal/config/config_test.go proxy-core/internal/config/ 2>/dev/null || true

# Model package
cp proxy/internal/model/models.go proxy-core/internal/model/
cp proxy/internal/model/*.go proxy-core/internal/model/

# Provider package (proxy-core only feature)
cp proxy/internal/provider/provider.go proxy-core/internal/provider/
cp proxy/internal/provider/anthropic.go proxy-core/internal/provider/
cp proxy/internal/provider/openai.go proxy-core/internal/provider/
cp proxy/internal/provider/*_test.go proxy-core/internal/provider/ 2>/dev/null || true

# Handler package (core only)
cp proxy/internal/handler/core_handler.go proxy-core/internal/handler/
cp proxy/internal/handler/core_handler_test.go proxy-core/internal/handler/ 2>/dev/null || true
cp proxy/internal/handler/utils.go proxy-core/internal/handler/
cp proxy/internal/handler/utils_test.go proxy-core/internal/handler/ 2>/dev/null || true

# Middleware
cp proxy/internal/middleware/*.go proxy-core/internal/middleware/
```

### Files to Move (proxy-core command entry point)

```bash
# Create parent structure
mkdir -p proxy-core/cmd

# Move proxy-core command
mv proxy/cmd/proxy-core proxy-core/cmd/proxy-core

# Verify it moved
ls -la proxy-core/cmd/proxy-core/main.go  # Should exist
ls proxy/cmd/proxy-core 2>/dev/null || echo "✓ Successfully moved"
```

### Files That STAY with proxy (proxy-data)

```bash
# DO NOT COPY THESE - they stay with proxy-data
proxy/internal/handler/data_handler.go          # Data APIs only
proxy/internal/handler/data_handler_test.go
proxy/internal/handler/handlers.go              # Legacy monolith
proxy/internal/handler/handlers_test.go
proxy/internal/handler/handlers_v2.go

# All services stay with proxy-data
proxy/internal/service/                         # storage, indexing, routing
proxy/internal/metrics/                         # metrics (optional, stays)

# These stay with proxy-data
proxy/cmd/proxy-data/                           # Data service entry point
```

---

## go.mod File Contents

### NEW: proxy-core/go.mod

Create this file with exact content:

```go
module github.com/seifghazi/claude-code-proxy/proxy-core

go 1.23.0

require (
	github.com/gorilla/handlers v1.5.2
	github.com/gorilla/mux v1.8.1
	github.com/joho/godotenv v1.5.1
	github.com/mattn/go-sqlite3 v1.14.28
	gopkg.in/yaml.v3 v3.0.1
)

require (
	github.com/beorn7/perks v1.0.1 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/felixge/httpsnoop v1.0.3 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	golang.org/x/sys v0.35.0 // indirect
)
```

### UPDATED: proxy/go.mod

**Add this line BEFORE the `require` block:**

```go
// Link to sibling module for go.mod replacement
replace github.com/seifghazi/claude-code-proxy/proxy-core => ../proxy-core
```

**Add this line IN the `require` block:**

```go
require (
	github.com/seifghazi/claude-code-proxy/proxy-core v0.0.0
	// ... rest of existing requires unchanged
)
```

**Full updated proxy/go.mod looks like:**

```go
module github.com/seifghazi/claude-code-proxy

go 1.23.0

// Link to sibling module - allows proxy-data to use shared code from proxy-core
replace github.com/seifghazi/claude-code-proxy/proxy-core => ../proxy-core

require (
	github.com/seifghazi/claude-code-proxy/proxy-core v0.0.0
	// ... keep all existing requires unchanged
	github.com/gorilla/handlers v1.5.2
	// ... etc
)
```

### Verification Commands

```bash
# In proxy-core/
cd proxy-core
go mod tidy
# Should complete with no errors
# go.sum should be created

# In proxy/
cd ../proxy
go mod tidy
# Should complete with no errors
# go.sum should be unchanged (or minimal changes)

# Verify replacement is working
cd ..
go mod graph | grep proxy-core
# Should output: github.com/seifghazi/claude-code-proxy github.com/seifghazi/claude-code-proxy/proxy-core@v0.0.0
# This confirms the replacement is active

# Clean module cache if you get weird errors
go clean -modcache
```

---

## Justfile Updates

### BEFORE (current):

```justfile
build:
    @echo "Building..."
    cd proxy && go build -tags "fts5" -o ../bin/proxy-core cmd/proxy-core/main.go
    cd proxy && go build -tags "fts5" -o ../bin/proxy-data cmd/proxy-data/main.go
    cd web && pnpm run build
    cd dashboard && pnpm run build
    @echo "Done"

test:
    cd proxy && go test -tags "fts5" ./...
    cd web && pnpm test
```

### AFTER (updated):

```justfile
# Build proxy-core from its new location
build-core:
    cd proxy-core && go build -tags "fts5" -o ../bin/proxy-core cmd/proxy-core/main.go

# Build proxy-data (still in proxy/)
build-data:
    cd proxy && go build -tags "fts5" -o ../bin/proxy-data cmd/proxy-data/main.go

# Full build - all services
build:
    @echo "Building proxy-core..."
    just build-core
    @echo "Building proxy-data..."
    just build-data
    @echo "Building dashboards..."
    cd web && pnpm run build
    cd dashboard && pnpm run build
    @echo "Done"

install:
    cd proxy-core && go mod download
    cd proxy && go mod download
    cd web && pnpm install
    cd dashboard && pnpm install

# Test both Go modules separately
test:
    @echo "Testing proxy-core..."
    cd proxy-core && go test -tags "fts5" ./...
    @echo "Testing proxy-data..."
    cd proxy && go test -tags "fts5" ./...
    @echo "Testing web..."
    cd web && pnpm test
    @echo "All tests passed"

# Convenience: build and test
build-test:
    just build && just test
```

### Key Changes

1. Split `build` into `build-core` and `build-data` (can be run independently)
2. Main `build` calls both targets in sequence
3. `install` separately downloads deps for both modules
4. `test` runs tests in both modules separately (important for verification)

---

## Docker Build Changes

### UPDATED: docker/Dockerfile.proxy-core

**Replace the builder stage with:**

```dockerfile
FROM golang:1.23-alpine AS builder
WORKDIR /app

RUN apk add --no-cache git gcc musl-dev sqlite-dev

# Copy both modules (proxy-core and proxy) so go.mod replacement works
# The replacement directive in proxy/go.mod points to ../proxy-core
COPY proxy-core/go.mod proxy-core/go.sum ./proxy-core/
COPY proxy/go.mod proxy/go.sum ./proxy/

# Download dependencies for proxy-core module
WORKDIR /app/proxy-core
RUN go mod download

# Copy source code for both modules
COPY proxy-core/ ./
COPY ../proxy ../proxy

# Build proxy-core
RUN CGO_ENABLED=1 GOOS=linux go build -tags "fts5" -a -installsuffix cgo \
    -o /app/bin/proxy-core cmd/proxy-core/main.go

# Keep the rest of the file unchanged (runtime stage, etc)
FROM alpine:3.19
WORKDIR /app
# ... rest of Dockerfile unchanged
```

**Critical**: Must copy both `proxy-core/` AND `proxy/` because:
- go.mod replacement needs to find `../proxy` (relative to proxy-core/)
- Docker COPY paths work from context root
- Without proxy/, the go.mod replacement fails to resolve

### Check docker-compose.yml

No changes needed. These should already be correct:

```yaml
services:
  proxy-core:
    build:
      context: .
      dockerfile: docker/Dockerfile.proxy-core
```

---

## Build Verification Step-by-Step

### Step 1: Verify current state builds

```bash
cd /Users/bmf/code/brandon-fryslie_claude-code-proxy

# Clean any previous builds
just clean

# Verify everything builds before changes
just build
# Should complete successfully

# Verify tests pass
just test
# Should pass
```

### Step 2: Create directories

```bash
mkdir -p proxy-core/cmd/proxy-core
mkdir -p proxy-core/internal/{config,handler,middleware,model,provider}

# Verify structure
find proxy-core -type d -o -type f | head -20
```

### Step 3: Copy files

```bash
# Use the "Files to Copy" section above to copy all files
# Or run this script:

for file in proxy/internal/{config,handler,middleware,model,provider}/*.go; do
  dirname=$(basename $(dirname "$file"))
  mkdir -p proxy-core/internal/$dirname
  cp "$file" proxy-core/internal/$dirname/
done

# Move the command entry point
mv proxy/cmd/proxy-core proxy-core/cmd/

# Verify critical files exist
ls proxy-core/cmd/proxy-core/main.go
ls proxy-core/internal/handler/core_handler.go
ls proxy-core/internal/config/config.go
```

### Step 4: Create and verify go.mod files

```bash
# Create proxy-core/go.mod using content from section above
cat > proxy-core/go.mod << 'EOF'
module github.com/seifghazi/claude-code-proxy/proxy-core

go 1.23.0

require (
	github.com/gorilla/handlers v1.5.2
	github.com/gorilla/mux v1.8.1
	github.com/joho/godotenv v1.5.1
	github.com/mattn/go-sqlite3 v1.14.28
	gopkg.in/yaml.v3 v3.0.1
)
EOF

# Tidy proxy-core
cd proxy-core
go mod tidy
cd ..

# Update proxy/go.mod - add replacement directive and require line
# Use text editor to add the lines from "UPDATED: proxy/go.mod" section above

# Tidy proxy
cd proxy
go mod tidy
cd ..

# Verify replacement
go mod graph | grep proxy-core
# Expected: github.com/seifghazi/claude-code-proxy github.com/seifghazi/claude-code-proxy/proxy-core@v0.0.0
```

### Step 5: Update Justfile

```bash
# Backup current Justfile
cp Justfile Justfile.backup

# Edit Justfile with content from "UPDATED: Justfile" section above
# Use your editor to replace the [build] and [test] targets
```

### Step 6: Build verification

```bash
# Test proxy-core build
just build-core
# Should complete successfully
ls -l bin/proxy-core
file bin/proxy-core  # Should show "executable"

# Test proxy-data build (verifies replacement works)
just build-data
# Should complete successfully
ls -l bin/proxy-data

# Full build
just clean && just build
# Should complete in under 30 seconds

# Run tests
just test
# Should show all tests passing
```

### Step 7: Docker build test

```bash
# Build just the proxy-core Docker image
podman build -f docker/Dockerfile.proxy-core -t test-proxy-core . 2>&1 | tail -20

# Should show "Successfully built" or similar success message

# Run container test
podman run -d -p 8001:8001 --name test-proxy test-proxy-core
sleep 2
curl -s http://localhost:8001/health | jq .
# Should return JSON with status

# Cleanup
podman stop test-proxy
podman rm test-proxy
```

---

## Troubleshooting

### Error: "module not found: github.com/seifghazi/claude-code-proxy/proxy-core"

**Cause**: go.mod replacement not applied

**Solution**:
```bash
# Verify replacement is in proxy/go.mod
grep "replace" proxy/go.mod

# Should show:
# replace github.com/seifghazi/claude-code-proxy/proxy-core => ../proxy-core

# Clear module cache and retry
cd proxy-core && go mod tidy
cd ../proxy && go mod tidy
go clean -modcache
```

### Error: "cannot find package" in imports

**Cause**: File copied but imports are wrong

**Solution**:
```bash
# Check package declaration
grep "^package " proxy-core/internal/config/config.go
# Should show: package config

# Check imports in main.go
grep "seifghazi/claude-code-proxy/proxy-core/internal" proxy-core/cmd/proxy-core/main.go
# Should show correct import paths like:
# "github.com/seifghazi/claude-code-proxy/proxy-core/internal/config"
```

### Error: "docker build fails - path not found"

**Cause**: COPY in Dockerfile wrong

**Solution**:
```bash
# Verify files exist where Dockerfile expects them
ls proxy-core/go.mod
ls proxy/go.mod
ls proxy-core/cmd/proxy-core/main.go

# Re-read Dockerfile section above and verify COPY paths are exact
```

### Error: "version mismatch"

**Cause**: go.mod files out of sync

**Solution**:
```bash
# Clean and retidy both modules
cd proxy-core && go mod tidy && git diff go.mod
cd ../proxy && go mod tidy && git diff go.mod

# Review changes - should only see expected new/removed deps
```

---

## Build Commands Cheat Sheet

```bash
# Local development
just build         # Build all services
just build-core    # Build just proxy-core (quick test)
just test          # Run all tests
just build-test    # Build and test

# Docker
just docker        # Full docker-compose up

# Cleanup
just clean         # Remove all build artifacts
just clean && just build  # Clean rebuild

# Verify module health
cd proxy-core && go mod tidy
cd ../proxy && go mod tidy
go mod graph | grep proxy-core
```

---

## Critical Success Indicators

### You'll know it worked when:

1. ✅ `just build` completes in < 30 seconds
2. ✅ `just test` shows all tests passing
3. ✅ Both binaries exist: `ls -l bin/proxy-{core,data}`
4. ✅ Docker image builds: `podman build -f docker/Dockerfile.proxy-core .` succeeds
5. ✅ Container runs: `curl http://localhost:8001/health` returns JSON
6. ✅ `go mod graph | grep proxy-core` shows exactly 1 edge
7. ✅ Zero errors in Justfile output

If ALL of these pass, the proxy-core extraction was successful!

---

## What Success Looks Like

Terminal output should show:

```
$ just build
Building proxy-core...
Building proxy-data...
Building dashboards...
Done

$ just test
Testing proxy-core...
ok  	github.com/seifghazi/claude-code-proxy/proxy-core/internal/config	0.234s
ok  	github.com/seifghazi/claude-code-proxy/proxy-core/internal/handler	0.456s
...
Testing proxy-data...
ok  	github.com/seifghazi/claude-code-proxy/internal/service	1.234s
...
Testing web...
PASS
All tests passed

$ ls -l bin/
-rwxr-xr-x  proxy-core
-rwxr-xr-x  proxy-data

$ curl http://localhost:8001/health
{
  "database": "connected",
  "service": "proxy-core",
  "status": "ok",
  "timestamp": "2026-01-12T..."
}
```

---

This document provides everything needed to execute the proxy-core extraction with high confidence. Each step is specific, testable, and verifiable.
