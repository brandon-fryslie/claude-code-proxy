# Sprint Plan: Model Breakdown Stats

**Generated**: 2025-12-24-223124
**Source**: STATUS-20251224.md (dashboard-parity)
**Epic**: brandon-fryslie_claude-code-proxy-xwb
**Topic**: model-breakdown-stats

---

## Sprint Goal

Add per-model token usage breakdown with visual representation (bar chart or pie chart) showing proportional usage across Claude models for the selected date.

---

## Scope

### In Scope
- Model breakdown display component
- Horizontal bar chart showing token usage per model
- Model name formatting (opus/sonnet/haiku)
- Model-specific colors matching chart conventions
- Token count formatting (K/M notation)
- Percentage calculation relative to max model
- Integration with existing `/api/stats/models` endpoint
- Responsive layout

### Out of Scope
- Request count breakdown (focus on tokens only)
- Time-series model usage (separate from this view)
- Model comparison across dates (no historical comparison)
- Pie chart visualization (using bar chart for consistency)
- Per-provider breakdown (that's in provider stats)
- Cost calculation (not in scope)

---

## Context from STATUS Report

**From STATUS-20251224.md, Section: "Old Dashboard Feature Inventory"**:
> **Usage Dashboard** | `UsageDashboard.tsx` (451 LOC + CSS) | Weekly + hourly charts, model breakdown

**From Section: "Component Comparison"**:
> web/app/components/
> └── UsageDashboard.tsx        451 LOC  - Usage charts
> **Gap**: New dashboard missing ~4,500 LOC of UI components!

**From Section: "API Coverage"**:
> | `/api/stats/models` | ✅ | ✅ | ✅ |

**Key Implementation Details** (lines 428-446 of `UsageDashboard.tsx`):
```typescript
<div className="breakdown-title">Models</div>
{processedStats.models.map((model, i) => (
  <div key={i} className="breakdown-item">
    <div className="breakdown-header">
      <span className="breakdown-model">{model.displayName}</span>
      <span className="breakdown-tokens">{formatTokens(model.tokens)}</span>
    </div>
    <div className="breakdown-bar">
      <div className="breakdown-bar-fill"
        style={{
          width: `${(model.tokens / processedStats.maxModelTokens) * 100}%`,
          backgroundColor: model.color,
        }}
      />
    </div>
  </div>
))}
```

**Model Color Mapping** (lines 24-42):
- Opus: `#9333ea` (purple)
- Sonnet: `#3b82f6` (blue)
- Haiku: `#10b981` (green)
- Uses substring matching: `model.includes('opus')`

---

## Work Items

### 1. Create ModelBreakdown Component

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None
**Spec Reference**: UsageDashboard.tsx lines 428-446 • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Create a component that displays per-model token usage as horizontal bars with model names, token counts, and proportional widths.

#### Acceptance Criteria
- [ ] Accepts `ModelStatsResponse` type from API
- [ ] Renders one horizontal bar per model
- [ ] Each bar shows: model name (left), token count (right)
- [ ] Bar fill width proportional to max model usage (100% = highest)
- [ ] Uses model-specific colors (Opus purple, Sonnet blue, Haiku green)
- [ ] Handles empty data gracefully (shows "No data" message)
- [ ] Sorts models by token count (descending)
- [ ] Token counts formatted with K/M notation

#### Technical Notes
- Component structure:
  ```tsx
  <div className="model-breakdown">
    <h3>Model Breakdown</h3>
    {models.map(model => (
      <div className="model-item">
        <div className="model-header">
          <span>{displayName}</span>
          <span>{formatTokens(tokens)}</span>
        </div>
        <div className="model-bar">
          <div className="model-bar-fill" style={{ width: '...%', backgroundColor: '...' }} />
        </div>
      </div>
    ))}
  </div>
  ```

---

### 2. Implement Model Name Formatting

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None
**Spec Reference**: UsageDashboard.tsx lines 30-35 • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Create utility functions to extract user-friendly model names and colors from full model strings.

#### Acceptance Criteria
- [ ] Function `getModelDisplayName(model: string): string` returns short name
- [ ] Maps "claude-opus-4-5-20251101" → "Opus"
- [ ] Maps "claude-sonnet-4-5-20250929" → "Sonnet"
- [ ] Maps "claude-haiku-3-5-20241022" → "Haiku"
- [ ] Returns full model string if no match found
- [ ] Function `getModelColor(model: string): string` returns hex color
- [ ] Returns purple (#9333ea) for opus variants
- [ ] Returns blue (#3b82f6) for sonnet variants
- [ ] Returns green (#10b981) for haiku variants
- [ ] Returns gray (#6b7280) as fallback

#### Technical Notes
- Use case-insensitive substring matching
- Place in `lib/utils.ts` for reusability
- Example:
  ```typescript
  function getModelDisplayName(model: string): string {
    const lower = model.toLowerCase()
    if (lower.includes('opus')) return 'Opus'
    if (lower.includes('sonnet')) return 'Sonnet'
    if (lower.includes('haiku')) return 'Haiku'
    return model
  }
  ```

---

### 3. Add Token Formatting Utility

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None
**Spec Reference**: UsageDashboard.tsx lines 44-49 • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Create a consistent token formatting function that converts large numbers to K/M notation.

#### Acceptance Criteria
- [ ] Function `formatTokens(tokens: number): string` returns formatted string
- [ ] Returns plain number for tokens < 1,000 (e.g., "523")
- [ ] Returns K notation for tokens 1K-999K (e.g., "15.2K")
- [ ] Returns M notation for tokens ≥ 1M (e.g., "2.3M")
- [ ] Returns B notation for tokens ≥ 1B (e.g., "1.1B")
- [ ] Uses 1 decimal place for K/M/B
- [ ] Handles 0 correctly (returns "0")
- [ ] Handles negative numbers (unlikely but safe)

#### Technical Notes
- Already partially exists in `lib/api.ts` but only handles K/M
- Enhance to handle B (billions) for future-proofing
- Use in both weekly chart and model breakdown

---

### 4. Integrate with Dashboard and Usage Pages

**Status**: Not Started
**Complexity**: Low
**Dependencies**: Work Items #1, #2, #3
**Spec Reference**: dashboard/src/pages/Dashboard.tsx, Usage.tsx • **Status Reference**: STATUS-20251224.md "New Dashboard Feature Inventory"

#### Description
Add ModelBreakdown component to both the main Dashboard page and the dedicated Usage page, fetching data from `/api/stats/models`.

#### Acceptance Criteria
- [ ] Component imported and rendered in Dashboard.tsx
- [ ] Component imported and rendered in Usage.tsx
- [ ] Uses `useModelStats()` hook from `lib/api.ts`
- [ ] Passes date range parameters to API hook
- [ ] Shows loading state while fetching
- [ ] Shows error state on fetch failure
- [ ] Updates when date selection changes (future enhancement)
- [ ] Maintains responsive layout

#### Technical Notes
- Dashboard page: Add to right column or below stats cards
- Usage page: Add below charts section
- Use existing `getTodayDateRange()` helper for date params
- Ensure TanStack Query caching works correctly

---

### 5. Add Model Breakdown Styling

**Status**: Not Started
**Complexity**: Low
**Dependencies**: Work Item #1 (Create ModelBreakdown Component)
**Spec Reference**: UsageDashboard.css (old dashboard) • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Style the ModelBreakdown component to match the new dashboard's design system while maintaining visual similarity to the old dashboard's breakdown section.

#### Acceptance Criteria
- [ ] Breakdown section has clear title/header
- [ ] Model items have adequate spacing (margin/padding)
- [ ] Model names use consistent typography
- [ ] Token counts right-aligned and monospaced
- [ ] Bar backgrounds have subtle gray color
- [ ] Bar fills use full-saturation model colors
- [ ] Bar fills have smooth edges (border-radius)
- [ ] Hover state shows subtle highlight
- [ ] Responsive: stacks on mobile, side-by-side on desktop
- [ ] Matches Tailwind utility classes from new dashboard

#### Technical Notes
- Use Tailwind classes for consistency
- Example bar styling:
  ```tsx
  <div className="bg-gray-100 rounded-full h-2 overflow-hidden">
    <div
      className="h-full rounded-full transition-all"
      style={{ width: '75%', backgroundColor: '#3b82f6' }}
    />
  </div>
  ```

---

### 6. Add Sorting and Percentage Display

**Status**: Not Started
**Complexity**: Low
**Dependencies**: Work Item #1 (Create ModelBreakdown Component)
**Spec Reference**: UsageDashboard.tsx lines 106-113 • **Status Reference**: STATUS-20251224.md "Old Dashboard Feature Inventory"

#### Description
Sort models by usage (descending) and optionally show percentage of total tokens.

#### Acceptance Criteria
- [ ] Models sorted by token count (highest first)
- [ ] Sort order maintained on data updates
- [ ] Optionally show percentage next to token count (e.g., "45%")
- [ ] Percentage calculated as `(modelTokens / totalTokens) * 100`
- [ ] Percentage formatted to 1 decimal place
- [ ] Handle edge case: totalTokens = 0 (show "0%")

#### Technical Notes
- Sorting:
  ```typescript
  const sortedModels = [...models].sort((a, b) => b.tokens - a.tokens)
  ```
- Percentage is optional enhancement; can defer if time-constrained
- Old dashboard shows absolute token counts, not percentages

---

## Dependencies

### External Dependencies
- None (all APIs already exist)

### Internal Dependencies
- `lib/types.ts` - `ModelStatsResponse` type
- `lib/api.ts` - `useModelStats()` hook
- `lib/utils.ts` - Utility functions (to be created/enhanced)

### API Dependencies
- `GET /api/stats/models?start=...&end=...` - Already implemented
- Response structure:
  ```json
  {
    "modelStats": [
      { "model": "claude-opus-4-5-20251101", "tokens": 1234567, "requests": 42 },
      { "model": "claude-sonnet-4-5-20250929", "tokens": 987654, "requests": 35 }
    ]
  }
  ```

---

## Risks

### Low Risk: Model Name Variations
**Issue**: Backend may return unexpected model name formats.

**Mitigation**:
- Use defensive substring matching
- Log unrecognized models to console for debugging
- Fall back to full model string if no match

**Fallback**: Display full model name as-is

### Low Risk: Missing Model Data
**Issue**: API may return empty array for dates with no activity.

**Mitigation**:
- Check `modelStats.length === 0` and show "No data" message
- Don't attempt to render bars if no data
- Show loading state during fetch

---

## Testing Strategy

### Unit Tests
- [ ] `getModelDisplayName()` with various model strings
- [ ] `getModelColor()` with various model strings
- [ ] `formatTokens()` with edge cases (0, 999, 1000, 1000000, etc)
- [ ] Model sorting logic
- [ ] Percentage calculation with edge cases

### Integration Tests
- [ ] Component renders with API data
- [ ] Component shows loading state
- [ ] Component shows error state
- [ ] Component updates on data change

### Visual Tests
- [ ] Compare with old dashboard breakdown section
- [ ] Verify colors match model conventions
- [ ] Check bar widths are proportional
- [ ] Test responsive behavior

---

## Definition of Done

See `DOD-2025-12-24-223124.md` for complete acceptance criteria checklist.

---

## Estimated Complexity

**Overall**: LOW

**Breakdown**:
- ModelBreakdown component: ~80 LOC
- Model utilities: ~30 LOC
- Token formatting: ~15 LOC (enhance existing)
- Styling: ~30 LOC (Tailwind classes)
- Integration: ~20 LOC
- Tests: ~60 LOC
- **Total**: ~235 LOC

**Confidence**: HIGH - simple component, clear requirements, existing API
