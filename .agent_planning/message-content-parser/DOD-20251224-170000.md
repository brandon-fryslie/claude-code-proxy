# Definition of Done: Message Content Parser

**Generated**: 2025-12-24-170000
**Plan**: PLAN-20251224-170000.md
**Epic**: brandon-fryslie_claude-code-proxy-kqw

---

## Sprint Scope

This sprint delivers a complete MessageContent component system that parses and renders all Anthropic message content block types with proper formatting.

**Deliverables**: 3 major components (MessageContent, ToolUse, ToolResult/ImageContent) + formatters

**Deferred**: TodoList rendering, CodeDiff integration (awaiting other sprints)

---

## Acceptance Criteria

### MessageContent Component

- [ ] MessageContent.tsx created in dashboard/src/components/
- [ ] Handles string content (renders as formatted text)
- [ ] Handles array content (recursive rendering of each item)
- [ ] Handles object content with type switching (text/tool_use/tool_result/image/unknown)
- [ ] Unknown content types show warning UI with expandable raw JSON
- [ ] TypeScript interfaces defined for ContentItem structure
- [ ] Unit tests verify all content type branches (5+ test cases)

### Text Content Rendering

- [ ] Plain text renders in styled div (white bg, border, rounded, shadow)
- [ ] Text blocks extract `text` field from content object
- [ ] Content processed through `formatLargeText()` formatter
- [ ] Line breaks preserved in output (whitespace-pre-wrap or br tags)
- [ ] Long text wraps correctly without breaking layout
- [ ] Integration test: 500+ line text block renders in < 500ms

### ToolUse Component

- [ ] ToolUse.tsx created with tool name, ID, and parameters display
- [ ] Shows parameter count badge
- [ ] Expand/collapse for 3+ parameters
- [ ] Copy button copies entire tool call as JSON
- [ ] Special rendering for Edit tool (shows code diff placeholder if CodeDiff not available)
- [ ] Special rendering for Read tool (shows file path)
- [ ] Special rendering for TodoWrite tool (shows raw todos or TodoList component)
- [ ] Complex parameters (objects) render as expandable details
- [ ] Large string parameters (200+ chars) truncate with expand button
- [ ] Gradient indigo/blue background styling
- [ ] Unit tests for parameter rendering (strings, objects, arrays)

### ToolResult Component

- [ ] ToolResult.tsx created with success/error styling
- [ ] Auto-detects code content (checks for line numbers, keywords)
- [ ] Code content integrates with CodeViewer (or placeholder)
- [ ] JSON content renders in formatted pre block
- [ ] Plain text renders with line breaks preserved
- [ ] Large content (500+ chars) truncates with expand button
- [ ] Extracts code from cat -n format (removes line number prefixes)
- [ ] Error results show red styling with AlertCircle icon
- [ ] Success results show green styling with CheckCircle icon
- [ ] Tool ID badge displayed when provided
- [ ] Expandable raw data structure for complex objects
- [ ] Unit tests for content type detection (code/JSON/text - 3+ cases)

### ImageContent Component

- [ ] ImageContent.tsx created
- [ ] Parses Claude API format (source.data, source.media_type)
- [ ] Parses alternative format (data, media_type)
- [ ] Constructs data URI from base64 correctly
- [ ] Displays image in bordered container
- [ ] Download button saves image with correct extension
- [ ] Fullscreen modal opens on click
- [ ] Handles image load errors (shows error UI)
- [ ] Modal closes on outside click or X button
- [ ] Media type label displayed
- [ ] Unit test for data URI construction

### System Reminder Parsing

- [ ] Detects <system-reminder> tags in content
- [ ] Extracts reminder content separately from regular text
- [ ] Regular text renders without visible tags
- [ ] Reminders collapsed by default
- [ ] Shows reminder count ("N system reminder(s)")
- [ ] AlertCircle icon for reminder indicator
- [ ] Reminders render in gray monospace
- [ ] Multiple reminders all extracted and displayed
- [ ] Unit tests for 0, 1, and multiple reminders

### Tool Definition Parsing

- [ ] Detects <functions> tags in system prompts
- [ ] Extracts individual <function> blocks
- [ ] Parses JSON tool definitions
- [ ] Shows tool count in header
- [ ] All tools collapsed by default with toggle
- [ ] Each tool card shows name, description, param count
- [ ] Required parameter count badge displayed
- [ ] Expand shows parameter list with types
- [ ] Required parameters marked with red badge
- [ ] Optional parameters marked with gray badge
- [ ] Invalid JSON shows error card
- [ ] Expandable raw definition
- [ ] Gradient green background styling
- [ ] Unit tests for valid and invalid JSON parsing

### Utility Formatters

- [ ] formatters.ts created in dashboard/src/lib/
- [ ] formatLargeText() formats text with line breaks
- [ ] formatJSON() stringifies with 2-space indent
- [ ] formatValue() converts any value to string
- [ ] isComplexObject() detects objects/arrays
- [ ] truncateText() truncates with ellipsis
- [ ] All functions handle null/undefined
- [ ] Unit tests for each formatter (5+ test cases per function)
- [ ] TypeScript types exported

---

## Testing Requirements

### Unit Test Coverage
- [ ] MessageContent component: 80%+ coverage
- [ ] ToolUse component: 80%+ coverage
- [ ] ToolResult component: 80%+ coverage
- [ ] ImageContent component: 80%+ coverage
- [ ] Formatters: 90%+ coverage

### Integration Tests
- [ ] Complete API response with mixed content types renders correctly
- [ ] 2000-line code block renders without performance issues
- [ ] Recursive content (5+ levels) renders correctly
- [ ] Error scenarios handled gracefully

### Code Quality
- [ ] 0 TypeScript errors
- [ ] 0 ESLint warnings
- [ ] All components properly typed

---

## Performance Benchmarks

- [ ] 500-line text block: < 500ms render time
- [ ] 2000-line tool result: < 1s render time
- [ ] 100 tool definitions: expand/collapse < 100ms
- [ ] No memory leaks after 100+ message renders

---

## Visual/UX Requirements

- [ ] Expand/collapse animations smooth (if implemented)
- [ ] Visual hierarchy clear (different colors for tool use/result/error)
- [ ] Copy feedback visible (checkmark on success)
- [ ] Responsive on mobile (375px width minimum)
- [ ] All interactive elements keyboard accessible

---

## Documentation

- [ ] Component prop interfaces documented with JSDoc
- [ ] README section added explaining MessageContent usage
- [ ] Example usage provided for each content type

---

## Blockers Resolved

- [ ] CodeViewer dependency resolved (placeholder implemented OR sprint scheduled)
- [ ] Formatter XSS protection implemented (DOMPurify OR sanitization)
- [ ] Component location decided (flat vs nested structure)

---

## Sprint Complete When

All acceptance criteria above are met AND:
- [ ] PR reviewed and approved
- [ ] All tests passing in CI
- [ ] Components integrated into Requests page
- [ ] Manual smoke test completed with real API data
