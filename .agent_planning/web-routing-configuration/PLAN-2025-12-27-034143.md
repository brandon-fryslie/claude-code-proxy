# Sprint Plan: Web Routing Configuration
Generated: 2025-12-27-034143
Source: STATUS-20251227.md
Topic: web-routing-configuration

## Executive Summary

**Current State:** Configuration is loaded from `config.yaml` at startup and is READ-ONLY. The Routing page displays subagent statistics but provides no way to view or modify the underlying provider and subagent configuration.

**Goal:** Enable web-based configuration management for providers and subagent routing mappings through the dashboard.

**Sprint Scope:** This first sprint focuses on **P0: Read-Only Configuration API & Display** to establish the foundation for future editing capabilities.

**Total Work Items:** 8 (P0: 3, P1: 3, P2: 2)

**Recommended Sprint:** Deliver P0 items first (estimated: LOW-MEDIUM complexity total)

---

## Sprint 1 Deliverables (P0: Foundation)

This sprint delivers:
1. Backend API to expose current configuration (sanitized)
2. Frontend display of providers and subagent mappings
3. TypeScript types and API hooks for config data

**Deferred to Sprint 2+:**
- Configuration editing UI (P1)
- Configuration persistence and validation (P2)
- Hot reload mechanism (P2)

---

## Backlog by Priority

### P0 (Critical) - Read-Only Configuration API & Display

#### [P0-1] Backend: Configuration Read API

**Status:** Not Started
**Effort:** Small (1-2 days)
**Dependencies:** None
**Spec Reference:** CLAUDE.md §Configuration • **Status Reference:** STATUS-20251227.md §What's Missing #1

##### Description
Add GET endpoints to expose current provider configuration and subagent mappings. API keys must be sanitized (masked or omitted entirely) in responses to prevent credential exposure.

The backend already has the `Config` struct loaded at startup (`config.go`) and validates it. This task adds HTTP handlers to expose that data over REST endpoints.

##### Acceptance Criteria
- [ ] GET `/api/config` endpoint returns full configuration structure (providers + subagents + server settings)
- [ ] GET `/api/config/providers` endpoint returns list of provider configurations
- [ ] GET `/api/config/subagents` endpoint returns subagent mappings and enable status
- [ ] API keys are NEVER included in responses (replaced with `"***REDACTED***"` or omitted)
- [ ] Responses follow V2 API pattern (unwrapped, clean JSON)
- [ ] All endpoints return proper HTTP status codes (200 OK, 500 on error)

##### Technical Notes
- Implementation location: `proxy/internal/handler/handlers.go`
- Add new handler methods: `GetConfig()`, `GetProviders()`, `GetSubagents()`
- Create sanitized copy of config before returning (don't mutate original)
- Register routes in `proxy/cmd/proxy/main.go` router setup
- Use existing `Config` struct from `config.go` - no new models needed
- Consider adding a `Sanitize()` helper method on `ProviderConfig` to mask API keys

**Example Response (GET /api/config/providers):**
```json
{
  "anthropic": {
    "format": "anthropic",
    "base_url": "https://api.anthropic.com",
    "version": "2023-06-01",
    "max_retries": 3,
    "api_key": "***REDACTED***"
  },
  "openai": {
    "format": "openai",
    "base_url": "https://api.openai.com",
    "api_key": "***REDACTED***"
  }
}
```

---

#### [P0-2] Frontend: TypeScript Types and API Hooks

**Status:** Not Started
**Effort:** Small (1 day)
**Dependencies:** [P0-1]
**Spec Reference:** CLAUDE.md §Web Dashboard • **Status Reference:** STATUS-20251227.md §What's Missing #4

##### Description
Add TypeScript type definitions for configuration data structures and create React Query hooks for fetching configuration from the new backend endpoints.

##### Acceptance Criteria
- [ ] TypeScript types added to `dashboard/src/lib/types.ts` matching backend `Config`, `ProviderConfig`, `SubagentsConfig` structs
- [ ] `useConfig()` hook implemented in `dashboard/src/lib/api.ts` to fetch full config
- [ ] `useProviders()` hook implemented to fetch providers list
- [ ] `useSubagentConfig()` hook implemented to fetch subagent mappings
- [ ] Hooks use React Query with proper cache invalidation strategies
- [ ] Type definitions include JSDoc comments explaining each field

##### Technical Notes
- Follow existing patterns in `api.ts` (use `fetchAPI<T>` wrapper, V2 API base)
- Use consistent query keys: `['config']`, `['config', 'providers']`, `['config', 'subagents']`
- Set reasonable stale time (e.g., 60 seconds) since config doesn't change frequently
- API key field should be `string | undefined` in TS types since it may be omitted

**Example Type:**
```typescript
export interface ProviderConfig {
  format: 'anthropic' | 'openai'
  base_url: string
  api_key?: string  // May be omitted for security
  version?: string
  max_retries?: number
}

export interface Config {
  server: ServerConfig
  providers: Record<string, ProviderConfig>
  storage: StorageConfig
  subagents: SubagentsConfig
}
```

---

#### [P0-3] Frontend: Display Configuration in Routing Page

**Status:** Not Started
**Effort:** Medium (2-3 days)
**Dependencies:** [P0-2]
**Spec Reference:** CLAUDE.md §Web Dashboard • **Status Reference:** STATUS-20251227.md §What's Missing #4

##### Description
Extend the existing `Routing.tsx` page to display current provider configurations and subagent mappings in a read-only view. This establishes the UI foundation for future editing capabilities.

##### Acceptance Criteria
- [ ] New "Providers" section displays all configured providers with format, base URL, and status indicator
- [ ] Provider display shows if API key is configured (yes/no indicator, never shows actual key)
- [ ] New "Subagent Mappings" section displays all mappings with enable/disable toggle status (read-only)
- [ ] Loading states shown while fetching configuration data
- [ ] Error states handled gracefully (e.g., "Failed to load configuration")
- [ ] UI matches existing dashboard design patterns and styling
- [ ] Page remains responsive on mobile/tablet viewports

##### Technical Notes
- Extend existing `Routing.tsx` file - add sections above "Active Routes"
- Reuse existing component patterns (cards, stat displays, tables)
- Use consistent color variables from CSS custom properties
- Consider adding icons from `lucide-react` (e.g., `Server`, `Settings`, `Key`)
- Show providers even if they have no usage stats (unlike current "Active Routes" which only shows used routes)
- Display subagent enable/disable status prominently (perhaps with a badge or toggle UI element)

**Layout suggestion:**
```
┌─ Providers ────────────────────────────────────┐
│ • anthropic (Anthropic API)                    │
│   https://api.anthropic.com | API Key: Yes     │
│ • openai (OpenAI API)                          │
│   https://api.openai.com | API Key: Yes        │
└────────────────────────────────────────────────┘

┌─ Subagent Routing ─────────────────────────────┐
│ Status: Enabled                                │
│                                                 │
│ code-reviewer → openai:gpt-4o                  │
│ test-writer → anthropic:claude-3-opus          │
└────────────────────────────────────────────────┘

┌─ Active Routes (existing section) ─────────────┐
│ ... existing stats display ...                 │
└────────────────────────────────────────────────┘
```

---

### P1 (High) - Configuration Editing UI

#### [P1-1] Backend: Provider Management Endpoints

**Status:** Not Started
**Effort:** Medium (3-4 days)
**Dependencies:** [P0-1]
**Spec Reference:** CLAUDE.md §Configuration • **Status Reference:** STATUS-20251227.md §What's Missing #1

##### Description
Add POST/PUT/DELETE endpoints for managing provider configurations. This enables the frontend to add, modify, and remove providers through the API.

##### Acceptance Criteria
- [ ] POST `/api/config/providers` creates a new provider with validation
- [ ] PUT `/api/config/providers/{name}` updates an existing provider
- [ ] DELETE `/api/config/providers/{name}` removes a provider
- [ ] Validation enforces required fields (format, base_url) before accepting changes
- [ ] Validation prevents deleting providers that are referenced in subagent mappings (return 409 Conflict with explanation)
- [ ] Provider name validation prevents empty/invalid names (alphanumeric + hyphens only)
- [ ] Changes are applied to in-memory config immediately (persistence deferred to P2)
- [ ] Unit tests cover validation logic and error cases

##### Technical Notes
- Implementation location: `proxy/internal/handler/handlers.go`
- Add handler methods: `CreateProvider()`, `UpdateProvider()`, `DeleteProvider()`
- Reuse existing `validateProviders()` logic from `config.go`
- For validation, check if provider name exists in `Subagents.Mappings` values before allowing delete
- Use Go's `sync.RWMutex` to protect concurrent access to config (add to `Config` struct or handler state)
- Return appropriate HTTP status codes:
  - 201 Created (POST success)
  - 200 OK (PUT/DELETE success)
  - 400 Bad Request (validation failure)
  - 404 Not Found (PUT/DELETE non-existent provider)
  - 409 Conflict (delete provider in use)

**Request Body Example (POST /api/config/providers with name "custom-anthropic"):**
```json
{
  "format": "anthropic",
  "base_url": "https://custom.anthropic-proxy.com",
  "api_key": "sk-ant-...",
  "version": "2023-06-01",
  "max_retries": 5
}
```

---

#### [P1-2] Backend: Subagent Mappings Management Endpoints

**Status:** Not Started
**Effort:** Medium (2-3 days)
**Dependencies:** [P0-1], [P1-1]
**Spec Reference:** CLAUDE.md §Configuration • **Status Reference:** STATUS-20251227.md §What's Missing #1

##### Description
Add endpoints for modifying subagent routing mappings and toggling the subagent routing feature on/off.

##### Acceptance Criteria
- [ ] PUT `/api/config/subagents/mappings` updates all subagent mappings (replaces entire map)
- [ ] PUT `/api/config/subagents/enable` toggles subagent routing on/off (accepts `{"enable": true/false}`)
- [ ] Validation ensures referenced providers exist before accepting mapping changes (return 400 with details)
- [ ] Validation ensures model names are non-empty in mappings
- [ ] Validation enforces mapping format: `"provider:model"` with both parts present
- [ ] Changes applied to in-memory config immediately
- [ ] Unit tests cover validation and edge cases

##### Technical Notes
- Implementation location: `proxy/internal/handler/handlers.go`
- Parse mapping values to validate format: `strings.Split(mapping, ":")` should yield exactly 2 parts
- Check that provider name from mapping exists in `Config.Providers`
- Consider logging warnings for agent names that don't have corresponding `.claude/agents/*.md` files (informational only, not blocking)
- Use same mutex as [P1-1] for thread safety

**Request Body Example (PUT /api/config/subagents/mappings):**
```json
{
  "code-reviewer": "openai:gpt-4o",
  "test-writer": "anthropic:claude-3-opus-20240229",
  "documentation": "custom-anthropic:claude-3-sonnet-20240229"
}
```

---

#### [P1-3] Frontend: Configuration Editing Forms

**Status:** Not Started
**Effort:** Large (5-7 days)
**Dependencies:** [P0-3], [P1-1], [P1-2]
**Spec Reference:** CLAUDE.md §Web Dashboard • **Status Reference:** STATUS-20251227.md §What's Missing #4

##### Description
Build interactive forms for adding/editing/deleting providers and subagent mappings in the Routing page. Replace read-only displays from [P0-3] with editable components.

##### Acceptance Criteria
- [ ] Provider form allows adding new providers with fields: name, format (dropdown), base_url, api_key (optional), version (optional), max_retries (optional)
- [ ] Provider edit flow allows updating existing providers (pre-populated form)
- [ ] Provider delete button with confirmation dialog warns if provider is in use by subagent mappings
- [ ] Subagent mappings editor allows adding/removing individual mappings (agent name → provider:model)
- [ ] Subagent routing enable/disable toggle updates immediately with optimistic UI
- [ ] Form validation provides real-time feedback (e.g., "Base URL required", "Invalid format")
- [ ] API errors displayed to user with actionable messages
- [ ] Success feedback shown after save (e.g., toast notification or inline message)
- [ ] Uses React Query mutations with proper cache invalidation (refetch config after changes)

##### Technical Notes
- Create new components: `ProviderForm.tsx`, `SubagentMappingEditor.tsx`
- Use form library like `react-hook-form` for validation and state management
- Implement optimistic updates for toggle switch (instant UI feedback)
- For subagent mappings, consider autocomplete for provider:model format
- Add mutation hooks in `api.ts`: `useCreateProvider()`, `useUpdateProvider()`, `useDeleteProvider()`, `useUpdateSubagentMappings()`, `useToggleSubagents()`
- Follow existing dashboard patterns for modals/forms (check `Settings.tsx` for reference)
- Use `useMutation` with `onSuccess` callback to invalidate `['config']` query keys

**UX Flow Example (Add Provider):**
1. User clicks "Add Provider" button
2. Modal opens with form
3. User fills: name="gemini", format="openai", base_url="https://api.gemini.com", api_key="..."
4. Clicks "Save"
5. Frontend validates, sends POST request
6. On success: modal closes, provider appears in list, success message shown
7. On error: error message shown in modal, user can correct and retry

---

### P2 (Medium) - Configuration Persistence & Hot Reload

#### [P2-1] Backend: Configuration Persistence to YAML

**Status:** Not Started
**Effort:** Medium (3-4 days)
**Dependencies:** [P1-1], [P1-2]
**Spec Reference:** CLAUDE.md §Configuration • **Status Reference:** STATUS-20251227.md §What's Missing #2

##### Description
Implement `Save()` method to write configuration changes back to `config.yaml` file. Include backup mechanism and validation before write to prevent corrupting the configuration file.

##### Acceptance Criteria
- [ ] `Config.Save(path string)` method serializes config to YAML and writes to disk
- [ ] Before writing, creates backup of existing config file (e.g., `config.yaml.backup.<timestamp>`)
- [ ] Validates serialized YAML can be re-parsed successfully before overwriting original file
- [ ] File write is atomic (write to temp file, then rename) to prevent corruption on crash
- [ ] Returns descriptive error if write fails (permissions, disk full, etc.)
- [ ] Integration test verifies write → read roundtrip preserves all data
- [ ] Documentation updated in CLAUDE.md explaining persistence behavior

##### Technical Notes
- Implementation location: `proxy/internal/config/config.go`
- Use `yaml.Marshal()` to serialize (inverse of existing `yaml.Unmarshal()`)
- YAML formatting: use `yaml.v3` encoder options to preserve order and formatting
- Backup retention: keep last 3-5 backups, delete older ones to prevent disk bloat
- Consider preserving comments in YAML (may require custom marshaling or migration to `gopkg.in/yaml.v3` Node API)
- Handle edge case: if config was loaded from multiple search paths, save to the first location found (or make path explicit)
- Add config file path to `Config` struct for tracking where it was loaded from

**Atomic Write Pattern:**
```go
func (c *Config) Save(path string) error {
    // 1. Create backup
    backup := path + ".backup." + time.Now().Format("20060102-150405")
    os.Rename(path, backup)

    // 2. Marshal to YAML
    data, err := yaml.Marshal(c)
    if err != nil {
        return fmt.Errorf("marshal config: %w", err)
    }

    // 3. Validate can re-parse
    var testCfg Config
    if err := yaml.Unmarshal(data, &testCfg); err != nil {
        return fmt.Errorf("validation failed: %w", err)
    }

    // 4. Atomic write (write temp, rename)
    tmpPath := path + ".tmp"
    if err := os.WriteFile(tmpPath, data, 0644); err != nil {
        return fmt.Errorf("write temp file: %w", err)
    }

    return os.Rename(tmpPath, path)
}
```

---

#### [P2-2] Backend: Hot Reload Mechanism

**Status:** Not Started
**Effort:** Medium-High (4-6 days)
**Dependencies:** [P2-1]
**Spec Reference:** CLAUDE.md §Architecture • **Status Reference:** STATUS-20251227.md §What's Missing #3

##### Description
Implement mechanism to reload configuration at runtime without restarting the proxy server. This involves reinitializing the `ModelRouter` and provider map when config changes.

##### Acceptance Criteria
- [ ] Config modification endpoints trigger reload after successful save
- [ ] `ModelRouter` reloads custom agent prompts from `.claude/agents/` directory
- [ ] Provider map is rebuilt to reflect added/removed/updated providers
- [ ] In-flight requests are not interrupted during reload (graceful transition)
- [ ] Reload errors are logged but do not crash the server (fallback to previous config)
- [ ] Integration test verifies config change → reload → routing behavior updated
- [ ] Reload completion time logged for monitoring

##### Technical Notes
- Implementation location: Add `Reload()` method to `ModelRouter` in `proxy/internal/service/model_router.go`
- Requires passing config reference to router or creating new router instance
- Use `sync.RWMutex` to protect routing table during reload (read lock for routing, write lock for reload)
- Reload steps:
  1. Parse all `.claude/agents/*.md` files
  2. Hash agent system prompts
  3. Build new `agentName → provider:model` map
  4. Swap routing table atomically
- Consider exposing reload endpoint: `POST /api/config/reload` for manual trigger (useful for debugging)
- Log warnings if agent files are missing for configured mappings

**Soft Reload Strategy:**
- Don't create new HTTP server
- Don't close existing provider connections (may break in-flight requests)
- Do reinitialize ModelRouter with new config
- Do rebuild internal routing maps
- Do reload agent hash cache

---

## Dependency Graph

```
P0-1 (Backend: Config Read API)
  ↓
  ├─→ P0-2 (Frontend: Types & Hooks)
  │     ↓
  │     └─→ P0-3 (Frontend: Display Config)
  │           ↓
  │           └─→ P1-3 (Frontend: Editing Forms) ← depends on P1-1 & P1-2
  │
  └─→ P1-1 (Backend: Provider Endpoints)
        ↓
        ├─→ P1-2 (Backend: Subagent Endpoints)
        │     ↓
        │     └─→ P2-1 (Backend: Persistence)
        │           ↓
        │           └─→ P2-2 (Backend: Hot Reload)
        │
        └─→ P2-1 (Backend: Persistence)
              ↓
              └─→ P2-2 (Backend: Hot Reload)
```

---

## Recommended Sprint Planning

### Sprint 1: Foundation (P0 Items)
**Goal:** Expose config via API and display in UI (read-only)
**Duration:** 1 week (3-5 days of work)
**Items:** P0-1, P0-2, P0-3
**Outcome:** Users can view current config in dashboard

### Sprint 2: Editing Capability (P1 Items)
**Goal:** Enable full CRUD operations on config
**Duration:** 2 weeks (8-12 days of work)
**Items:** P1-1, P1-2, P1-3
**Outcome:** Users can modify config via dashboard (changes in-memory only)

### Sprint 3: Persistence & Hot Reload (P2 Items)
**Goal:** Persist changes to disk and enable hot reload
**Duration:** 1.5 weeks (6-8 days of work)
**Items:** P2-1, P2-2
**Outcome:** Config changes persist across restarts, no downtime needed

---

## Risk Assessment

### High-Risk Items

| Item | Risk | Mitigation |
|------|------|------------|
| **P2-1 (Persistence)** | May overwrite user's config file with lost comments/formatting | Create timestamped backups before every write; document manual recovery process |
| **P2-2 (Hot Reload)** | Complex concurrency issues could cause crashes or routing failures | Extensive testing with concurrent requests during reload; fallback to previous config on error |
| **P1-3 (Forms)** | Complex validation logic prone to edge cases | Comprehensive frontend validation tests; backend validation as safety net |

### Medium-Risk Items

| Item | Risk | Mitigation |
|------|------|------------|
| **P1-1 (Provider Endpoints)** | Race conditions on config updates | Use mutex for all config read/write operations |
| **P0-1 (Read API)** | Accidentally exposing API keys in responses | Sanitization helper; integration test verifies keys are redacted |

---

## Testing Strategy

### Unit Tests (Backend)
- Config serialization/deserialization roundtrip (P2-1)
- Provider validation logic (P1-1)
- Subagent mapping validation (P1-2)
- API key sanitization (P0-1)

### Integration Tests (Backend)
- Full config CRUD flow with persistence (P2-1)
- Hot reload with in-flight requests (P2-2)
- Provider deletion with mappings (P1-1)

### E2E Tests (Frontend)
- Add provider → appears in list (P1-3)
- Edit provider → changes reflected (P1-3)
- Delete provider → confirmation flow (P1-3)
- Update subagent mapping → routing changes (P1-3)

### Manual Testing Scenarios
1. Config file permissions error handling
2. Corrupted YAML recovery
3. Provider connection test (future enhancement)
4. Concurrent config modifications (stress test)

---

## Blockers and Questions

None identified. The evaluation report (STATUS-20251227.md) provided clear architectural understanding and all dependencies are internal to the project.

**Clarifications Documented:**
1. **Persistence Strategy:** Use original `config.yaml` with timestamped backups (per STATUS recommendations)
2. **Hot Reload Strategy:** Soft reload (reinitialize components without server restart)
3. **Authentication:** Deferred to future work (not in scope for MVP)

---

## Files to Modify/Create

### Backend (Go)
| File | Changes |
|------|---------|
| `proxy/internal/handler/handlers.go` | Add 8+ new handler methods for config CRUD |
| `proxy/internal/config/config.go` | Add `Save()` method, sanitization helpers, mutex for thread safety |
| `proxy/internal/service/model_router.go` | Add `Reload()` method for hot reload |
| `proxy/cmd/proxy/main.go` | Register new API routes |
| `proxy/internal/handler/handlers_test.go` | Add unit tests for new handlers |
| `proxy/internal/config/config_test.go` | Add tests for persistence logic |

### Frontend (TypeScript/React)
| File | Changes |
|------|---------|
| `dashboard/src/lib/types.ts` | Add `Config`, `ProviderConfig`, `SubagentsConfig` types |
| `dashboard/src/lib/api.ts` | Add 8+ new hooks for config queries/mutations |
| `dashboard/src/pages/Routing.tsx` | Add provider/subagent config display sections |
| `dashboard/src/components/ProviderForm.tsx` | NEW: Provider add/edit form component |
| `dashboard/src/components/SubagentMappingEditor.tsx` | NEW: Subagent mapping editor component |

---

## Success Metrics

**Sprint 1 (P0):**
- [ ] 3 new backend endpoints functional and tested
- [ ] Configuration visible in dashboard Routing page
- [ ] Zero API keys exposed in API responses (verified by test)

**Sprint 2 (P1):**
- [ ] Full provider CRUD working end-to-end
- [ ] Subagent mappings editable via UI
- [ ] Validation prevents invalid config states

**Sprint 3 (P2):**
- [ ] Config changes persist to `config.yaml`
- [ ] Hot reload completes in <1 second
- [ ] Zero request failures during reload (under load test)

---

## Definition of Done

For each work item:
- [ ] Code implemented and passes type checking (`make test`, `npm run typecheck`)
- [ ] Unit tests written and passing
- [ ] Integration tests written for backend endpoints
- [ ] Manual testing completed for happy path and error cases
- [ ] Code reviewed for security issues (especially API key handling)
- [ ] Documentation updated if behavior changes (CLAUDE.md)
- [ ] No regressions in existing functionality (existing tests still pass)
