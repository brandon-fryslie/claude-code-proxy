# Definition of Done: Web Routing Configuration
Generated: 2025-12-27-034143
Plan: PLAN-2025-12-27-034143.md
Topic: web-routing-configuration

## Sprint Scope

This sprint delivers:
1. **Backend Configuration Read API** - Expose current provider and subagent config via REST endpoints
2. **Frontend Configuration Display** - Show providers and subagent mappings in Routing page (read-only)

**Deferred:**
- Configuration editing UI (Sprint 2)
- Configuration persistence to YAML (Sprint 3)
- Hot reload mechanism (Sprint 3)
- Authentication/authorization
- Provider connection testing
- Agent file management

---

## Acceptance Criteria

### Deliverable 1: Backend Configuration Read API

#### GET /api/config Endpoint
- [ ] Returns full configuration structure including providers, subagents, and server settings
- [ ] Response follows V2 API pattern (clean JSON, unwrapped)
- [ ] Returns HTTP 200 OK on success
- [ ] Returns HTTP 500 with error message on failure
- [ ] API keys are NEVER included in response (replaced with `"***REDACTED***"` or omitted)

#### GET /api/config/providers Endpoint
- [ ] Returns map of all provider configurations keyed by provider name
- [ ] Each provider includes: format, base_url, version (if set), max_retries (if set)
- [ ] API key field shows `"***REDACTED***"` if configured, or is omitted entirely
- [ ] Returns HTTP 200 OK on success
- [ ] Returns empty object `{}` if no providers configured

#### GET /api/config/subagents Endpoint
- [ ] Returns subagent configuration including `enable` boolean and `mappings` object
- [ ] Mappings format: `{"agent-name": "provider:model", ...}`
- [ ] Returns HTTP 200 OK on success
- [ ] Returns `{"enable": false, "mappings": {}}` if subagents not configured

#### Security & Safety
- [ ] Integration test verifies API keys are redacted/omitted in all responses
- [ ] No sensitive environment variables exposed in responses
- [ ] Config sanitization happens before serialization (original config unchanged)

#### Code Quality
- [ ] Handler functions added to `proxy/internal/handler/handlers.go`
- [ ] Routes registered in `proxy/cmd/proxy/main.go` router setup
- [ ] Unit tests cover successful responses and error cases
- [ ] Code passes `go test ./...` and `go build` without errors

---

### Deliverable 2: Frontend TypeScript Types and API Hooks

#### Type Definitions
- [ ] `ProviderConfig` interface defined in `dashboard/src/lib/types.ts`
- [ ] `SubagentsConfig` interface defined with `enable` and `mappings` fields
- [ ] `Config` interface defined with `server`, `providers`, `storage`, `subagents` fields
- [ ] All types include JSDoc comments explaining purpose of each field
- [ ] Types match backend Go struct definitions exactly

#### API Hooks
- [ ] `useConfig()` hook fetches full configuration from `/api/config`
- [ ] `useProviders()` hook fetches provider list from `/api/config/providers`
- [ ] `useSubagentConfig()` hook fetches subagent config from `/api/config/subagents`
- [ ] All hooks use React Query with proper TypeScript generics
- [ ] Query keys follow consistent pattern: `['config']`, `['config', 'providers']`, `['config', 'subagents']`
- [ ] Stale time configured appropriately (e.g., 60 seconds)

#### Code Quality
- [ ] Hooks added to `dashboard/src/lib/api.ts`
- [ ] Follows existing `fetchAPI<T>` wrapper pattern for requests
- [ ] TypeScript compilation passes without errors (`npm run typecheck`)
- [ ] Linting passes without errors (`npm run lint`)

---

### Deliverable 3: Frontend Configuration Display in Routing Page

#### Providers Section
- [ ] New "Providers" section added to Routing page above existing "Active Routes"
- [ ] Displays all configured providers in a card/list layout
- [ ] Each provider shows: name, format (Anthropic/OpenAI), base URL
- [ ] Shows indicator if API key is configured (e.g., "API Key: Yes" or checkmark icon)
- [ ] Never displays actual API key value
- [ ] Shows provider icon or format badge for visual distinction

#### Subagent Mappings Section
- [ ] New "Subagent Routing" section displays current mapping configuration
- [ ] Shows enable/disable status prominently (e.g., badge or status indicator)
- [ ] Lists all configured mappings in format: `agent-name → provider:model`
- [ ] Displays message "No mappings configured" if mappings empty
- [ ] Shows "Subagent routing disabled" message if `enable: false`

#### UX & Visual Design
- [ ] Matches existing dashboard design patterns and color scheme
- [ ] Uses CSS custom properties for colors (`var(--color-*)`)
- [ ] Responsive layout works on mobile, tablet, and desktop viewports
- [ ] Icons from `lucide-react` used consistently (e.g., `Server`, `Settings`, `Key`, `GitBranch`)
- [ ] Section headings consistent with existing page sections

#### Data Loading & Error Handling
- [ ] Loading state displayed while fetching config data (spinner or skeleton)
- [ ] Error state shown if API request fails with actionable message
- [ ] Error message: "Failed to load configuration. Please refresh the page."
- [ ] Gracefully handles empty/missing config (shows appropriate empty states)
- [ ] Uses `useProviders()` and `useSubagentConfig()` hooks from Deliverable 2

#### Code Quality
- [ ] Changes made to existing `dashboard/src/pages/Routing.tsx`
- [ ] Components follow existing patterns in file (e.g., `RouteRow` structure)
- [ ] TypeScript types used properly (no `any` types)
- [ ] Code passes `npm run typecheck` and `npm run lint`
- [ ] No console errors when page loads

---

## Testing Checklist

### Backend Testing
- [ ] Unit test: GET `/api/config` returns expected structure
- [ ] Unit test: API keys are sanitized in all endpoints
- [ ] Unit test: Empty config returns valid default values
- [ ] Integration test: Full round-trip from handler to response JSON
- [ ] Manual test: Verify responses in browser DevTools Network tab

### Frontend Testing
- [ ] Unit test: Type definitions correctly type API responses
- [ ] Integration test: Hooks fetch data and parse correctly
- [ ] Manual test: Routing page loads without errors
- [ ] Manual test: Providers section displays correctly with real config
- [ ] Manual test: Subagent section displays correctly with real config
- [ ] Manual test: Empty states render properly (no providers, no mappings)
- [ ] Manual test: Loading states appear briefly during data fetch
- [ ] Manual test: Error states display if backend is unreachable

### Regression Testing
- [ ] Existing `/api/stats/subagents` endpoint still works
- [ ] Existing "Active Routes" section still displays usage stats
- [ ] Other dashboard pages (Dashboard, Performance, Usage) unaffected
- [ ] All existing tests pass: `cd proxy && go test ./...`
- [ ] All existing frontend tests pass: `cd dashboard && npm run test`

---

## Quality Gates

Before marking sprint as complete:

### Code Quality
- [ ] All Go code formatted with `go fmt`
- [ ] All TypeScript code formatted with Prettier
- [ ] No linter warnings or errors
- [ ] No TypeScript `any` types in new code
- [ ] Code reviewed for security issues (especially credential handling)

### Functionality
- [ ] All acceptance criteria checked off
- [ ] Manual testing completed for all user-facing changes
- [ ] Screenshots/demos captured for documentation

### Documentation
- [ ] API endpoints documented in CLAUDE.md §API Endpoints section
- [ ] New configuration fields explained if added
- [ ] Any architectural changes noted in CLAUDE.md

### Testing
- [ ] Unit test coverage for new backend handlers
- [ ] Integration tests for new API endpoints
- [ ] No test failures in CI/local runs

### Deployment Readiness
- [ ] Changes work with existing `config.yaml` files (backward compatible)
- [ ] No breaking changes to existing API contracts
- [ ] Application starts successfully with new code (`make dev`)
- [ ] No runtime errors in console during normal operation

---

## Handoff to Sprint 2

After completing this sprint, the following will be ready for Sprint 2:

1. **API Foundation:** Backend exposes config in standard REST format
2. **UI Foundation:** Routing page has sections for displaying config
3. **Type Safety:** TypeScript types defined and validated
4. **Testing Foundation:** Test patterns established for config endpoints

Sprint 2 can immediately begin work on:
- Adding POST/PUT/DELETE endpoints for config mutations
- Converting read-only displays to editable forms
- Implementing validation and error handling for config changes
