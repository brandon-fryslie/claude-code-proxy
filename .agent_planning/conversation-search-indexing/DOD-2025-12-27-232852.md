# Definition of Done: Conversation Search Indexing
Generated: 2025-12-27 23:28:52
Plan: PLAN-2025-12-27-232852.md
Source: STATUS-20251227_233000.md

## Sprint Scope
This sprint delivers:
1. SQLite schema (conversations + FTS5 tables) with migration
2. Conversation indexing service with file watcher
3. Search API endpoint with pagination

Deferred:
- Search result highlighting/snippets (too complex for MVP)
- Advanced filters (date range, project-specific)
- Real-time indexing with WebSocket updates

---

## Acceptance Criteria

### P0: Database Schema & JSONL Message Parser

#### Database Schema
- [ ] **Schema Created**: `conversations` table stores sessionID, project info, timestamps, file path, indexed_at
- [ ] **FTS5 Table Ready**: `conversations_fts` virtual table with porter stemming, indexes message content + tool names
- [ ] **Migration Successful**: Running `go run cmd/proxy/main.go` creates tables on first start, no errors

#### JSONL Message Parser
- [ ] **JSONL Parser Works**: Can extract text content from all message types (userMessage, assistantMessage, toolResult, etc.)
- [ ] **Parser Tested**: Unit tests cover 5+ real JSONL files from `~/.claude/projects/`, handle edge cases (empty messages, large tool outputs, Unicode)
- [ ] **Tool Name Extraction**: Parser identifies and extracts tool names from tool_use blocks (e.g., "bash", "read_file")
- [ ] **Format Documented**: Code comments or doc string explain message format variants discovered

---

### P1: Conversation Indexing Service with File Watcher

#### Initial Indexing
- [ ] **Initial Indexing Works**: On startup, service walks `~/.claude/projects/`, indexes all JSONL files, populates both tables

#### Incremental Updates
- [ ] **Incremental Updates**: File watcher detects new/modified JSONL files, triggers re-indexing
- [ ] **Debouncing Active**: Writing to JSONL file rapidly (simulated) only triggers one re-index after 5 seconds of inactivity
- [ ] **Staleness Handling**: Modified JSONL files (changed mtime) are detected and re-indexed on next startup

#### Reliability
- [ ] **Graceful Shutdown**: Service cleanly stops file watcher, closes channels, no goroutine leaks
- [ ] **Error Recovery**: File watcher failures (e.g., too many open files) log error, attempt restart after 10 seconds
- [ ] **Dependency Added**: `github.com/fsnotify/fsnotify` added to `go.mod`

---

### P2: Search API Endpoint with Pagination

#### API Functionality
- [ ] **Endpoint Exists**: `GET /api/conversations/search?q=<query>&limit=50&offset=0` returns 200 with valid JSON
- [ ] **Search Works**: Query "authentication" returns conversations containing that term (case-insensitive)
- [ ] **Multi-term Search**: Query "auth bug" uses OR logic (matches "auth" OR "bug")
- [ ] **Pagination Functional**: limit=20&offset=20 returns second page of 20 results

#### Response Format
- [ ] **Response Format**: Returns `{query, results: [{conversationId, projectName, matchCount, lastActivity}], total}`
- [ ] **Empty Query Handled**: Empty or missing `q` parameter returns 400 Bad Request
- [ ] **No Results Graceful**: Query with zero matches returns 200 with empty results array

---

## Verification Checklist

### Code Quality
- [ ] All unit tests pass: `cd proxy && go test ./...`
- [ ] Integration tests pass (file watcher, endpoint)
- [ ] No linter warnings: `cd proxy && go vet ./...`
- [ ] Code reviewed (self-review minimum)

### Functionality
- [ ] Manual test: Index 50+ real conversations from `~/.claude/projects/`
- [ ] Manual test: Search for known terms, verify results accurate
- [ ] Manual test: Create new JSONL file, verify auto-indexed within 5 seconds
- [ ] Manual test: Modify existing JSONL, verify re-indexed

### Performance
- [ ] Benchmark: Initial indexing completes in <1 second per 100 conversations
- [ ] Benchmark: Search query returns in <200ms for typical query
- [ ] Benchmark: Incremental update completes in <100ms per conversation
- [ ] Memory check: Indexer service uses <50MB additional memory

### Documentation
- [ ] Code comments explain JSONL message format discovered
- [ ] README updated with search feature description
- [ ] API documentation added for `/api/conversations/search` endpoint

---

## Test Coverage Requirements

### Unit Tests (Required)
- [ ] `conversation_test.go`: Message parser with 5+ real JSONL fixtures
- [ ] `storage_sqlite_test.go`: FTS5 search queries (single term, multi-term, edge cases)
- [ ] `indexer_test.go`: Staleness detection, error handling

### Integration Tests (Required)
- [ ] `indexer_integration_test.go`: File watcher (create, modify, delete events)
- [ ] `handlers_test.go`: Search endpoint (200 response, pagination, 400 for missing query)

### Manual Tests (Required Before Merge)
- [ ] Index real JSONL files (50+ conversations)
- [ ] Search for terms present in conversations, verify results
- [ ] Search for terms NOT present, verify empty results
- [ ] Test pagination (navigate through multiple pages)
- [ ] Restart proxy, verify index persists across restarts

---

## Known Limitations (Accepted for MVP)

These are documented and deferred to future sprints:

1. **No snippet highlighting** - Results include conversationID and matchCount, but not highlighted text snippets
2. **No advanced filters** - Cannot filter by date range or project in this sprint (API supports project filter, but not tested)
3. **No real-time updates** - Frontend must poll or refresh to see new search results (no WebSocket push)
4. **No fuzzy search** - Exact term matching only (no typo tolerance)
5. **Tool results truncated** - Large tool outputs (>500 chars) may be truncated to avoid bloating index

---

## Success Criteria

**This sprint is DONE when:**

1. ✅ All 21 acceptance criteria above are met
2. ✅ All unit and integration tests pass
3. ✅ Manual testing confirms search works end-to-end
4. ✅ Performance benchmarks meet targets (<1s/100 convos, <200ms search)
5. ✅ Code reviewed and merged to main branch
6. ✅ Documentation updated

**This sprint is NOT done if:**

- Any acceptance criteria is incomplete
- Tests are failing or missing
- Performance targets not met
- Code has merge conflicts or build errors

---

## Handoff to Next Sprint

After this sprint completes, the following work is ready:

### Immediate Follow-ups (Next Sprint)
- Add search result highlighting/snippets
- Add date range filter UI and backend support
- Add project filter UI (backend already supports it)
- Performance tuning for 10,000+ conversations

### Future Work (Backlog)
- Real-time search updates (WebSocket)
- Fuzzy search (requires external library or trigram approach)
- Search analytics (track popular queries)
- Advanced search syntax (e.g., `tool:bash`, `project:auth`)
