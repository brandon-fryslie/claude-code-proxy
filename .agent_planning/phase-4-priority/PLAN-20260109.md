# Sprint Plan: Phase 4 Priority Features

**Generated:** 2026-01-09
**Source:** EVALUATION-20260109.md
**Sprint Duration:** ~2 weeks

---

## Sprint Goal

Deliver web-based configuration viewing, data management controls, and Gemini provider support to enable power users to manage the proxy without editing config files.

---

## Scope

### In Scope (This Sprint)

**Deliverable 1: Web Routing Configuration (Read-Only Foundation)**
- Backend API exposing sanitized configuration
- Frontend display of providers and subagent mappings
- TypeScript types and React Query hooks

**Deliverable 2: Data Management Controls**
- Manual refresh buttons for all pages
- Clear all requests with confirmation
- Auto-refresh toggle and interval settings

**Deliverable 3: Gemini Provider Support**
- Configuration example for Gemini
- Documentation for setup
- Verification with real Gemini API

### Explicitly Out of Scope (Future Sprints)

- Configuration editing UI (web-routing-config P1)
- Configuration persistence to YAML (web-routing-config P2)
- Hot reload mechanism (web-routing-config P2)
- Multi-account round-robin (vibeproxy P1) - needs test infrastructure first
- Conversation threads - needs data model investigation first
- Multi-provider comparison - needs scope definition first

---

## Work Items

### Deliverable 1: Web Routing Configuration (Read-Only)

#### [D1-1] Backend: Configuration Read API

**Effort:** Small (1-2 days)
**Dependencies:** None
**Source:** web-routing-configuration/PLAN-2025-12-27

##### Description
Add GET endpoints to expose current provider configuration and subagent mappings. API keys must be sanitized (masked) to prevent credential exposure.

##### Acceptance Criteria
- [ ] GET `/api/config` returns full configuration (providers + subagents + server)
- [ ] GET `/api/config/providers` returns list of provider configurations
- [ ] GET `/api/config/subagents` returns subagent mappings and enable status
- [ ] API keys replaced with `"***REDACTED***"` - never exposed
- [ ] All endpoints return proper HTTP status codes

##### Technical Notes
- Location: `proxy/internal/handler/data_handler.go`
- Add `Sanitize()` method to `ProviderConfig` struct
- Register routes in `proxy/cmd/proxy-data/main.go`

---

#### [D1-2] Frontend: TypeScript Types and API Hooks

**Effort:** Small (0.5 day)
**Dependencies:** D1-1
**Source:** web-routing-configuration/PLAN-2025-12-27

##### Description
Add TypeScript types matching backend Config structs and React Query hooks for fetching configuration.

##### Acceptance Criteria
- [ ] Types added: `Config`, `ProviderConfig`, `SubagentsConfig` in `dashboard/src/lib/types.ts`
- [ ] `useConfig()` hook fetches full config
- [ ] `useProviders()` hook fetches providers list
- [ ] `useSubagentConfig()` hook fetches subagent mappings
- [ ] Hooks use React Query with 60s stale time

##### Technical Notes
- Follow existing patterns in `api.ts`
- Query keys: `['config']`, `['config', 'providers']`, `['config', 'subagents']`

---

#### [D1-3] Frontend: Display Configuration in Routing Page

**Effort:** Medium (1-2 days)
**Dependencies:** D1-2
**Source:** web-routing-configuration/PLAN-2025-12-27

##### Description
Extend Routing.tsx to display current providers and subagent mappings in a read-only view.

##### Acceptance Criteria
- [ ] "Providers" section shows all configured providers (name, format, base URL)
- [ ] Provider display shows API key configured indicator (yes/no, never actual key)
- [ ] "Subagent Mappings" section shows mappings and enable/disable status
- [ ] Loading and error states handled gracefully
- [ ] Matches existing dashboard design patterns

##### Technical Notes
- Extend `dashboard/src/pages/Routing.tsx`
- Add sections above existing "Active Routes"
- Use lucide-react icons: Server, Settings, Key

---

### Deliverable 2: Data Management Controls

#### [D2-1] Manual Refresh for Request List

**Effort:** Small (0.5 day)
**Dependencies:** None
**Source:** data-management/PLAN-2025-12-24

##### Description
Add refresh button to Requests page that refetches request data on demand.

##### Acceptance Criteria
- [ ] Refresh button (RefreshCw icon) in Requests page header
- [ ] Click triggers refetch of request list
- [ ] Spinning animation while loading
- [ ] Button disabled during refresh
- [ ] Error toast on failure

##### Technical Notes
- Use `queryClient.invalidateQueries(['requests'])`
- Debounce rapid clicks

---

#### [D2-2] Manual Refresh for Stats/Analytics Pages

**Effort:** Small (0.5 day)
**Dependencies:** None
**Source:** data-management/PLAN-2025-12-24

##### Description
Add refresh buttons to Dashboard, Usage, Performance, and Routing pages.

##### Acceptance Criteria
- [ ] Refresh button on Dashboard, Usage, Performance, Routing pages
- [ ] All related queries invalidated simultaneously
- [ ] Charts update smoothly (no flicker)
- [ ] "Last updated" timestamp shown

##### Technical Notes
- Invalidate query keys: `['stats']`, `['stats', 'hourly']`, `['stats', 'models']`
- Display relative timestamp with date-fns

---

#### [D2-3] Clear All Requests with Confirmation

**Effort:** Medium (1 day)
**Dependencies:** None
**Source:** data-management/PLAN-2025-12-24

##### Description
Implement "Clear All Requests" with confirmation modal requiring explicit user action.

##### Acceptance Criteria
- [ ] "Clear All Requests" button in Settings page
- [ ] Confirmation modal with warning message
- [ ] Must type "DELETE" to confirm (prevents accidental clicks)
- [ ] Calls DELETE `/api/requests` on confirm
- [ ] Success toast and redirect to empty state
- [ ] Request list and stats refresh automatically after clear

##### Technical Notes
- Backend endpoint exists: `DELETE /api/requests`
- Show request count in confirmation message if possible

---

#### [D2-4] Auto-Refresh Toggle and Interval

**Effort:** Small (1 day)
**Dependencies:** None
**Source:** data-management/PLAN-2025-12-24

##### Description
Add auto-refresh settings to Settings page with toggle and interval configuration.

##### Acceptance Criteria
- [ ] Settings page has "Auto-Refresh" toggle switch
- [ ] Interval selector: 30s, 1m, 5m, 10m
- [ ] Settings persisted in localStorage
- [ ] Visual indicator when auto-refresh active (pulsing icon in header)
- [ ] Applies to all pages (requests, dashboard, stats)
- [ ] Default: OFF with 1m interval

##### Technical Notes
- Use TanStack Query's `refetchInterval` option
- Global state: React Context or localStorage
- Minimum interval 30s to avoid performance impact

---

### Deliverable 3: Gemini Provider Support

#### [D3-1] Gemini Configuration and Documentation

**Effort:** Small (1 day)
**Dependencies:** None
**Source:** vibeproxy-feature-analysis/PLAN-2025-12-27

##### Description
Enable routing to Gemini models via the existing OpenAI provider infrastructure. This is config-only - no code changes needed.

##### Acceptance Criteria
- [ ] Gemini example added to `config.yaml.example`
- [ ] Base URL documented: `https://generativelanguage.googleapis.com/v1beta/openai/`
- [ ] Subagent mapping example: `code-reviewer: "gemini:gemini-2.0-flash-exp"`
- [ ] Available models documented (gemini-1.5-pro, gemini-1.5-flash, gemini-2.0-flash-exp)
- [ ] Test request forwarding to Gemini API
- [ ] Verify streaming responses work
- [ ] Verify token usage captured in dashboard

##### Technical Notes
- No code changes - uses existing OpenAI provider
- Gemini uses API key as query param by default, but Bearer token may work
- If Bearer doesn't work, small tweak to openai.go may be needed

---

## Dependencies Graph

```
D1-1 (Backend Config API)
  ↓
D1-2 (Frontend Types/Hooks)
  ↓
D1-3 (Frontend Display)

D2-1, D2-2, D2-3, D2-4 (Data Management) - All independent

D3-1 (Gemini) - Independent
```

All deliverables can be worked in parallel with minimal coordination.

---

## Risks

### Technical Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| API key sanitization incomplete | Low | High | Add integration test verifying no keys in response |
| Auto-refresh performance impact | Medium | Medium | Default OFF, min 30s interval, test with load |
| Gemini API incompatibility | Low | Low | Early manual testing, document quirks |

### UX Risks

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Accidental clear all | Medium | High | Require typing "DELETE", show count |
| Auto-refresh UI jank | Medium | Medium | Use background refetch, maintain scroll |

---

## Testing Strategy

### Unit Tests
- Config sanitization helper
- localStorage persistence for settings
- TanStack Query cache invalidation

### Integration Tests
- Config endpoints return sanitized data
- DELETE /api/requests clears all data
- Manual refresh updates data

### Manual Testing
- Enable auto-refresh, monitor for 5+ minutes
- Clear all with 1000+ requests
- Configure and test Gemini provider end-to-end

---

## Files to Modify/Create

### Backend (Go)
| File | Changes |
|------|---------|
| `proxy/internal/handler/data_handler.go` | Add GetConfig, GetProviders, GetSubagents handlers |
| `proxy/internal/config/config.go` | Add Sanitize() method |
| `proxy/cmd/proxy-data/main.go` | Register new routes |

### Frontend (TypeScript/React)
| File | Changes |
|------|---------|
| `dashboard/src/lib/types.ts` | Add Config, ProviderConfig, SubagentsConfig |
| `dashboard/src/lib/api.ts` | Add useConfig, useProviders, useSubagentConfig hooks |
| `dashboard/src/pages/Routing.tsx` | Add provider/subagent config sections |
| `dashboard/src/pages/Requests.tsx` | Add refresh button |
| `dashboard/src/pages/Dashboard.tsx` | Add refresh button, timestamp |
| `dashboard/src/pages/Usage.tsx` | Add refresh button |
| `dashboard/src/pages/Performance.tsx` | Add refresh button |
| `dashboard/src/pages/Settings.tsx` | Add clear all, auto-refresh settings |
| `dashboard/src/components/RefreshButton.tsx` | NEW: Reusable refresh button component |
| `dashboard/src/components/ConfirmDeleteModal.tsx` | NEW: Confirmation modal |
| `dashboard/src/contexts/AutoRefreshContext.tsx` | NEW: Global auto-refresh state |

### Configuration
| File | Changes |
|------|---------|
| `config.yaml.example` | Add Gemini provider example |
| `CLAUDE.md` | Update with Gemini configuration docs |

---

## Success Metrics

- [ ] Configuration visible in dashboard Routing page
- [ ] Zero API keys exposed in API responses (verified by test)
- [ ] Manual refresh completes in <2 seconds for 1000 requests
- [ ] Auto-refresh has zero UI jank (scroll preserved)
- [ ] Clear all completes in <5 seconds for 10,000 requests
- [ ] Gemini routing works end-to-end with real API

---

## Estimated Effort

| Deliverable | Days |
|-------------|------|
| D1: Web Routing Config (Read-Only) | 3-4 days |
| D2: Data Management Controls | 3 days |
| D3: Gemini Provider Support | 1 day |
| **Total** | **7-8 days** |

---

## Next Steps After This Sprint

1. **web-routing-configuration P1**: Add editing UI
2. **web-routing-configuration P2**: Add persistence + hot reload
3. **vibeproxy Multi-Account**: After test infrastructure
4. **conversation-threads**: After data model investigation
5. **multi-provider-comparison**: After scope research
