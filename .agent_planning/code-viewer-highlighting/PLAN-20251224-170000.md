# Sprint Plan: Code Viewer with Syntax Highlighting

**Generated**: 2025-12-24-170000
**Source**: STATUS-20251224.md (dashboard-parity evaluation)
**Epic**: brandon-fryslie_claude-code-proxy-6j7
**Topic**: code-viewer-highlighting

---

## Sprint Goal

Create a CodeViewer component with syntax highlighting, language detection, line numbers, copy/download functionality, and fullscreen modal support.

---

## Scope

### In Scope
- CodeViewer component with syntax highlighting
- Language detection from file extensions
- Line-numbered code display
- Copy code to clipboard
- Download code as file
- Fullscreen modal view
- Support for 40+ common languages
- Custom lightweight highlighting (current implementation)
- Dark theme code display

### Out of Scope
- External syntax highlighting libraries (Prism.js, Shiki, highlight.js) - using existing lightweight implementation
- Theme switching (light/dark modes) - dark only for now
- Line selection/highlighting
- Code search within viewer
- Diff view (separate component: CodeDiff)

---

## Work Items

### P0-1: Port CodeViewer Component Core Structure

**Status**: Not Started
**Complexity**: Low
**Dependencies**: None
**Spec Reference**: CLAUDE.md - Code Viewer | **Status Reference**: STATUS-20251224.md lines 45, 117-118

#### Description
Port the CodeViewer component shell from old dashboard (`web/app/components/CodeViewer.tsx`) to new dashboard. This includes the component structure, props interface, and state management for copy/fullscreen features.

#### Acceptance Criteria
- [ ] CodeViewer.tsx created at `dashboard/src/components/CodeViewer.tsx`
- [ ] TypeScript interface for props: `code: string`, `fileName?: string`, `language?: string`
- [ ] State hooks for `copied` (boolean) and `isFullscreen` (boolean)
- [ ] Component renders with dark theme (bg-gray-900, border-gray-700)
- [ ] Header section with file name, language badge, line count
- [ ] Code content section (to be implemented in P0-2)
- [ ] Component exports properly for use in ToolResult
- [ ] Unit test verifies component renders without errors

#### Technical Notes
- Reference `web/app/components/CodeViewer.tsx` lines 1-265
- Use Tailwind classes for dark theme consistency
- Icons from lucide-react: FileCode, Copy, Check, Download, Maximize2, X

---

### P0-2: Implement Language Detection from File Extension

**Status**: Not Started
**Complexity**: Low
**Dependencies**: P0-1
**Spec Reference**: CLAUDE.md - Code Viewer | **Status Reference**: STATUS-20251224.md lines 45, 342-344

#### Description
Build the language detection logic that maps file extensions to language identifiers for syntax highlighting and display.

#### Acceptance Criteria
- [ ] `getLanguageFromFileName()` function implemented
- [ ] Supports 40+ language extensions (js, ts, py, go, rs, java, cpp, etc.)
- [ ] Handles edge cases: no extension, unknown extension (defaults to 'text')
- [ ] Case-insensitive matching (Dockerfile, MAKEFILE work)
- [ ] Language prop overrides auto-detection if provided
- [ ] Language badge displays detected/provided language
- [ ] Unit tests for 10+ common extensions
- [ ] Unit tests for edge cases (no extension, unknown, override)

#### Technical Notes
- Reference `web/app/components/CodeViewer.tsx` lines 15-81
- Language map is a simple object: `{extension: languageName}`
- Common patterns: js→javascript, ts→typescript, py→python
- Special cases: 'dockerfile', 'makefile' (no extension)

---

### P0-3: Build Syntax Highlighting Engine

**Status**: Not Started
**Complexity**: Medium
**Dependencies**: P0-2
**Spec Reference**: CLAUDE.md - Code Viewer | **Status Reference**: STATUS-20251224.md lines 342-344

#### Description
Implement the lightweight syntax highlighting using regex-based token matching. This highlights keywords, strings, comments, numbers, and types using a single-pass algorithm.

#### Acceptance Criteria
- [ ] `highlightCode()` function implemented with single-pass algorithm
- [ ] HTML escaping prevents XSS (all code sanitized before highlighting)
- [ ] Token types supported: strings (3 types), comments (2 types), keywords, literals, numbers, types
- [ ] Regex patterns match language-agnostic constructs
- [ ] Highlighted tokens wrapped in `<span>` with Tailwind color classes
- [ ] Output is safe HTML string (no unescaped user content)
- [ ] Performance: 1000-line file highlights in < 100ms
- [ ] Unit tests for each token type (strings, comments, keywords, etc.)
- [ ] Integration test: Full TypeScript/JavaScript file with all token types

#### Technical Notes
- Reference `web/app/components/CodeViewer.tsx` lines 85-147
- Key insight: Match tokens in priority order (strings/comments first to avoid highlighting inside them)
- Use combined regex with capture groups to identify which pattern matched
- Tailwind classes: text-green-400 (strings), text-gray-500 (comments), text-blue-400 (keywords)
- Escape HTML BEFORE applying spans to avoid breaking class attributes

---

### P0-4: Implement Line-Numbered Display

**Status**: Not Started
**Complexity**: Low
**Dependencies**: P0-3
**Spec Reference**: CLAUDE.md - Code Viewer | **Status Reference**: STATUS-20251224.md lines 45, 342-344

#### Description
Render code in a table with line numbers in the left column, syntax-highlighted code in the right column, with hover effects and proper alignment.

#### Acceptance Criteria
- [ ] Code rendered as HTML table with two columns
- [ ] Left column: Line numbers (1-indexed), right-aligned, gray text
- [ ] Right column: Syntax-highlighted code with whitespace preservation
- [ ] Line numbers non-selectable (select-none class)
- [ ] Rows have hover effect (hover:bg-gray-800/50)
- [ ] Line numbers align to top for wrapped lines (align-top)
- [ ] Monospace font for both columns (font-mono)
- [ ] Each line renders via `dangerouslySetInnerHTML` with highlighted HTML
- [ ] Scrollable container for large files (max-h-[500px] or max-h-[80vh] in modal)
- [ ] Unit test: Verify 100-line file renders all line numbers correctly

#### Technical Notes
- Reference `web/app/components/CodeViewer.tsx` lines 221-237
- Split code by `\n` to get lines array
- Table structure: `<table><tbody>{lines.map(...)}</tbody></table>`
- Line number column width fixed (w-12) to prevent shifting

---

### P0-5: Add Copy to Clipboard Functionality

**Status**: Not Started
**Complexity**: Low
**Dependencies**: P0-1
**Spec Reference**: CLAUDE.md - Code Viewer | **Status Reference**: STATUS-20251224.md lines 45, 342-344

#### Description
Implement copy button that copies raw code to clipboard with visual feedback (checkmark for 2 seconds).

#### Acceptance Criteria
- [ ] Copy button in header (icon button with Copy/Check icons)
- [ ] `handleCopy()` function uses `navigator.clipboard.writeText()`
- [ ] Copies raw code (not highlighted HTML)
- [ ] Shows checkmark icon for 2 seconds after successful copy
- [ ] Returns to copy icon after timeout
- [ ] Button shows green color during success state
- [ ] Error handling: Logs to console if clipboard API fails
- [ ] Button has hover effect (hover:bg-gray-700)
- [ ] Unit test: Mock clipboard API, verify copy called with code
- [ ] Integration test: Click copy button, verify state transitions

#### Technical Notes
- Reference `web/app/components/CodeViewer.tsx` lines 149-157
- Use `setTimeout` to reset copied state after 2000ms
- Icons: Copy (default), Check (success, text-green-400)
- Clipboard API requires HTTPS or localhost

---

### P0-6: Add Download Functionality

**Status**: Not Started
**Complexity**: Low
**Dependencies**: P0-1
**Spec Reference**: CLAUDE.md - Code Viewer | **Status Reference**: STATUS-20251224.md lines 45, 342-344

#### Description
Implement download button that saves code as a file with the original filename or a default.

#### Acceptance Criteria
- [ ] Download button in header (icon button with Download icon)
- [ ] `handleDownload()` function creates Blob from code
- [ ] Creates data URL and triggers download via anchor element
- [ ] Uses provided `fileName` prop or defaults to 'code.txt'
- [ ] File downloads with correct name and extension
- [ ] Blob URL revoked after download (no memory leak)
- [ ] Button has hover effect (hover:bg-gray-700)
- [ ] Works in Chrome, Firefox, Safari
- [ ] Unit test: Mock createElement, verify download triggered
- [ ] Integration test: Click download, verify file saved

#### Technical Notes
- Reference `web/app/components/CodeViewer.tsx` lines 159-169
- Create Blob: `new Blob([code], { type: 'text/plain' })`
- Create anchor: `document.createElement('a')`, set href/download, click, remove
- Clean up: `URL.revokeObjectURL(url)` after click

---

### P0-7: Implement Fullscreen Modal

**Status**: Not Started
**Complexity**: Medium
**Dependencies**: P0-4
**Spec Reference**: CLAUDE.md - Code Viewer | **Status Reference**: STATUS-20251224.md lines 45, 342-344

#### Description
Add fullscreen button that opens code in a modal overlay with larger display area and close functionality.

#### Acceptance Criteria
- [ ] Fullscreen button in header (Maximize2 icon)
- [ ] Button not shown in modal view (prevents nested modals)
- [ ] Clicking button sets `isFullscreen` state to true
- [ ] Modal renders as fixed overlay (z-50, bg-black/90)
- [ ] Modal covers entire viewport (inset-0)
- [ ] Code viewer in modal uses larger max-height (max-h-[80vh])
- [ ] Close button (X icon) positioned above code viewer
- [ ] Clicking overlay background closes modal
- [ ] Clicking X button closes modal
- [ ] Clicking code viewer does NOT close modal (event.stopPropagation)
- [ ] Modal content centered (flex items-center justify-center)
- [ ] Fullscreen view has same features as inline (copy, download)
- [ ] Unit test: Verify modal renders when isFullscreen=true
- [ ] Integration test: Open/close fullscreen, verify state

#### Technical Notes
- Reference `web/app/components/CodeViewer.tsx` lines 246-263
- Use shared CodeDisplay component for inline and modal rendering (DRY principle)
- Modal structure: `<div onClick={close}><div onClick={stopPropagation}>{content}</div></div>`
- Pass `inModal` prop to CodeDisplay to adjust styling/buttons

---

### P1-8: Add CodeViewer Tests

**Status**: Not Started
**Complexity**: Low
**Dependencies**: P0-1 through P0-7
**Spec Reference**: CLAUDE.md - Testing | **Status Reference**: STATUS-20251224.md lines 315-322

#### Description
Create comprehensive unit and integration tests for CodeViewer component covering all features and edge cases.

#### Acceptance Criteria
- [ ] Test file created: `CodeViewer.test.tsx`
- [ ] Unit tests for language detection (10+ cases)
- [ ] Unit tests for syntax highlighting (each token type)
- [ ] Unit tests for HTML escaping (XSS prevention)
- [ ] Unit tests for copy/download handlers
- [ ] Integration test: Full component render with all features
- [ ] Integration test: Large file (1000+ lines) performance
- [ ] Edge case tests: Empty code, code with HTML tags, special characters
- [ ] Mock tests: Clipboard API, Blob API, createElement
- [ ] Test coverage: 85%+ for CodeViewer component
- [ ] All tests pass in CI

#### Technical Notes
- Reference existing test: `web/app/components/CodeViewer.test.tsx`
- Use Vitest (configured in new dashboard)
- Mock browser APIs: `navigator.clipboard`, `document.createElement`, `URL.createObjectURL`
- Test helpers: `render()`, `fireEvent` from testing library
- Performance test: Use `performance.now()` to measure highlight time

---

## Dependencies

```
P0-1 (Component shell)
  ├─> P0-2 (Language detection)
  │     └─> P0-3 (Syntax highlighting)
  │           └─> P0-4 (Line numbers)
  │                 └─> P0-7 (Fullscreen)
  ├─> P0-5 (Copy)
  └─> P0-6 (Download)

P1-8 (Tests) depends on all P0 items
```

**Critical Path**: P0-1 → P0-2 → P0-3 → P0-4 → P0-7

---

## Recommended Sprint Sequence

### Week 1: Core Implementation
1. **Day 1**: Component shell (P0-1) + Language detection (P0-2)
2. **Day 2**: Syntax highlighting (P0-3)
3. **Day 3**: Line-numbered display (P0-4)
4. **Day 4**: Copy (P0-5) + Download (P0-6)
5. **Day 5**: Fullscreen modal (P0-7)

### Week 2: Testing & Integration
1. **Day 1-2**: Comprehensive tests (P1-8)
2. **Day 3**: Integration with ToolResult component
3. **Day 4**: Performance testing and optimization
4. **Day 5**: Bug fixes and polish

**Total Complexity**: MEDIUM (264 LOC reference component, well-defined scope)

---

## Risk Assessment

### High Risks
1. **XSS Vulnerability**: Highlighting uses `dangerouslySetInnerHTML`
   - **Mitigation**: Escape ALL code content before applying highlights
   - **Impact**: Security issue if user content not sanitized

2. **Performance**: Large files (5000+ lines) could cause lag
   - **Mitigation**: Test with large files, add virtualization if needed
   - **Impact**: Poor UX for large code files

### Medium Risks
1. **Clipboard API Support**: Not available in all browsers/contexts
   - **Mitigation**: Graceful fallback (log error, show message)
   - **Impact**: Copy feature broken in some environments

2. **Download Compatibility**: Blob/anchor download may fail in some browsers
   - **Mitigation**: Test in Chrome, Firefox, Safari
   - **Impact**: Download feature broken in edge cases

### Low Risks
1. **Language Detection Edge Cases**: Unusual file extensions might not be detected
   - **Mitigation**: Default to 'text' for unknown extensions
   - **Impact**: No syntax highlighting for rare languages

---

## Testing Strategy

### Unit Tests
- Language detection: 15+ file extensions + edge cases
- Syntax highlighting: Each token type (8+ tests)
- HTML escaping: XSS attempts, special characters
- Event handlers: Copy, download, fullscreen toggle
- Line splitting: Edge cases (empty, single line, 1000+ lines)

### Integration Tests
- Full component render with TypeScript code
- Copy flow: Click → clipboard API → success state
- Download flow: Click → file download
- Fullscreen flow: Open → display → close
- Large file: 2000 lines renders in < 1s

### Performance Tests
- Highlight 1000-line file: < 100ms
- Render 5000-line file: < 500ms
- No memory leaks after 100 renders

### Visual Tests (Manual)
- Dark theme matches dashboard design
- Line numbers align correctly
- Hover effects smooth
- Fullscreen modal centered
- Icons render correctly

---

## Blockers and Questions

### Questions for Product Owner
1. **Syntax Highlighting Library**: Stay with lightweight custom implementation, or integrate external library?
   - **Current**: Custom regex-based (lightweight, ~60 lines)
   - **Alternative**: Prism.js (comprehensive, larger bundle)
   - **Recommendation**: Keep custom for now, reconsider if more language features needed

2. **Theme Support**: Add light theme, or dark only?
   - **Current**: Dark theme only (bg-gray-900)
   - **Impact**: Light theme requires duplicate color classes
   - **Recommendation**: Dark only for MVP, add theme switching later

### Technical Decisions Needed
1. **Component Location**: `dashboard/src/components/CodeViewer.tsx` or subdirectory?
   - **Recommendation**: Flat for now, same as other components

2. **Virtualization**: Add for large files (5000+ lines)?
   - **Recommendation**: Defer to performance testing, add only if needed

3. **Line Selection**: Should users be able to select/link to specific lines?
   - **Recommendation**: Out of scope for this sprint, future enhancement

---

## Definition of Done

See: `DOD-20251224-170000.md`

---

## Success Metrics

### Functional Completeness
- [ ] All 40+ languages detected correctly
- [ ] Syntax highlighting renders for JS/TS/Python/Go (top 4 languages)
- [ ] Copy/download/fullscreen work in Chrome/Firefox/Safari
- [ ] Integrated with ToolResult component

### Performance
- [ ] 1000-line file highlights in < 100ms
- [ ] 5000-line file renders in < 500ms
- [ ] No UI blocking for any file size

### Quality
- [ ] 85%+ unit test coverage
- [ ] 0 TypeScript errors
- [ ] 0 ESLint warnings
- [ ] No XSS vulnerabilities (verified with test payloads)

### User Experience
- [ ] Dark theme consistent with dashboard
- [ ] Fullscreen modal smooth (no layout shifts)
- [ ] Copy feedback clear (green checkmark visible)
- [ ] Mobile responsive (horizontal scroll for wide code)
