# Definition of Done: Code Viewer with Syntax Highlighting

**Generated**: 2025-12-24-170000
**Plan**: PLAN-20251224-170000.md
**Epic**: brandon-fryslie_claude-code-proxy-6j7

---

## Sprint Scope

This sprint delivers a complete CodeViewer component with syntax highlighting, language detection, line numbers, and user interaction features (copy/download/fullscreen).

**Deliverables**: 1 major component (CodeViewer) with 7 features

**Deferred**: External syntax highlighting libraries, theme switching, line selection

---

## Acceptance Criteria

### Component Structure

- [ ] CodeViewer.tsx created at dashboard/src/components/CodeViewer.tsx
- [ ] TypeScript props interface: code (string), fileName (optional string), language (optional string)
- [ ] State management for copied (boolean) and isFullscreen (boolean)
- [ ] Component renders with dark theme (bg-gray-900, text-gray-300)
- [ ] Header with file name, language badge, line count
- [ ] Unit test verifies component renders without errors

### Language Detection

- [ ] getLanguageFromFileName() function implemented
- [ ] Supports 40+ language extensions (js, ts, tsx, jsx, py, go, rs, java, cpp, c, cs, php, rb, swift, kt, etc.)
- [ ] Defaults to 'text' for unknown extensions
- [ ] Case-insensitive extension matching
- [ ] Language prop overrides auto-detection
- [ ] Language badge displays detected/provided language in header
- [ ] Unit tests for 10+ common extensions (js, ts, py, go, etc.)
- [ ] Unit tests for edge cases (no extension, unknown extension, override)

### Syntax Highlighting

- [ ] highlightCode() function implemented with single-pass regex algorithm
- [ ] HTML escaping applied BEFORE highlighting (prevents XSS)
- [ ] Token types: strings (double/single/backtick), comments (single/multi), keywords, literals, numbers, types (PascalCase)
- [ ] Highlighted output wrapped in span tags with Tailwind color classes
- [ ] Colors: green-400 (strings), gray-500 (comments), blue-400 (keywords), orange-400 (literals), purple-400 (numbers), cyan-400 (types)
- [ ] Performance: 1000-line file highlights in < 100ms
- [ ] Unit tests for each token type (8+ test cases)
- [ ] Unit test for HTML escaping (XSS prevention with <script> tags)
- [ ] Integration test: Full TypeScript/JavaScript file with all token types

### Line-Numbered Display

- [ ] Code rendered as HTML table with two columns
- [ ] Left column: Line numbers (1-indexed, right-aligned, gray-500, select-none, w-12)
- [ ] Right column: Syntax-highlighted code (whitespace-pre, font-mono)
- [ ] Rows have hover effect (hover:bg-gray-800/50)
- [ ] Line numbers align-top for wrapped lines
- [ ] Scrollable container (overflow-auto, max-h-[500px] inline / max-h-[80vh] fullscreen)
- [ ] Each line renders via dangerouslySetInnerHTML with highlighted HTML
- [ ] Unit test: 100-line file renders all line numbers correctly

### Copy to Clipboard

- [ ] Copy button in header (Copy icon from lucide-react)
- [ ] handleCopy() uses navigator.clipboard.writeText()
- [ ] Copies raw code (not highlighted HTML)
- [ ] Shows Check icon (green-400) for 2 seconds after success
- [ ] Returns to Copy icon after timeout
- [ ] Error handling: Logs to console if clipboard API fails
- [ ] Button hover effect (hover:text-white, hover:bg-gray-700)
- [ ] Title tooltip: "Copy code"
- [ ] Unit test: Mock clipboard, verify writeText called with raw code
- [ ] Integration test: Click copy, verify icon transitions

### Download Functionality

- [ ] Download button in header (Download icon)
- [ ] handleDownload() creates Blob from code
- [ ] Creates object URL and triggers download via temporary anchor
- [ ] Uses fileName prop or defaults to 'code.txt'
- [ ] Blob URL revoked after download (URL.revokeObjectURL)
- [ ] Button hover effect (hover:text-white, hover:bg-gray-700)
- [ ] Title tooltip: "Download file"
- [ ] Works in Chrome, Firefox, Safari
- [ ] Unit test: Mock createElement, verify download triggered with correct filename
- [ ] Integration test: Click download, verify file saved

### Fullscreen Modal

- [ ] Fullscreen button in header (Maximize2 icon, not shown in modal)
- [ ] Clicking button opens fullscreen modal
- [ ] Modal overlay: fixed, inset-0, z-50, bg-black/90, flex centered
- [ ] Code viewer in modal uses larger height (max-h-[80vh])
- [ ] Close button (X icon) positioned above viewer
- [ ] Clicking overlay background closes modal
- [ ] Clicking X button closes modal
- [ ] Clicking code viewer does NOT close modal (stopPropagation)
- [ ] Fullscreen view has same copy/download buttons
- [ ] Unit test: Verify modal renders when isFullscreen=true
- [ ] Integration test: Open/close fullscreen, verify state transitions

### Testing & Quality

- [ ] CodeViewer.test.tsx created
- [ ] Unit test coverage: 85%+ for CodeViewer component
- [ ] All unit tests pass
- [ ] Integration tests pass
- [ ] Performance test: 1000-line file < 100ms
- [ ] Performance test: 5000-line file < 500ms
- [ ] 0 TypeScript errors
- [ ] 0 ESLint warnings
- [ ] No XSS vulnerabilities (test with <script> tags, HTML entities)

---

## Integration Requirements

- [ ] CodeViewer imported and used in ToolResult component
- [ ] ToolResult passes code, fileName to CodeViewer
- [ ] Code extraction from cat -n format works with CodeViewer
- [ ] CodeViewer renders within ToolResult's white rounded container
- [ ] End-to-end test: API response with Read tool â†’ CodeViewer displays

---

## Performance Benchmarks

- [ ] 500-line file: < 50ms highlight time
- [ ] 1000-line file: < 100ms highlight time
- [ ] 5000-line file: < 500ms render time
- [ ] No memory leaks after 100 component renders
- [ ] Fullscreen modal opens in < 100ms

---

## Visual/UX Requirements

- [ ] Dark theme consistent (matches dashboard bg-gray-900)
- [ ] Line numbers right-aligned and non-selectable
- [ ] Code text wraps correctly or scrolls horizontally
- [ ] Hover effects smooth (transition-colors on buttons)
- [ ] Icons render correctly (lucide-react icons)
- [ ] Fullscreen modal centered with padding
- [ ] Mobile responsive (horizontal scroll for wide code, min-width handling)

---

## Browser Compatibility

- [ ] Chrome: All features work
- [ ] Firefox: All features work
- [ ] Safari: All features work
- [ ] Clipboard API fallback for unsupported contexts (logs error)

---

## Documentation

- [ ] Component props documented with JSDoc
- [ ] Language map documented (comment listing all 40+ supported languages)
- [ ] Example usage added to component file or README

---

## Blockers Resolved

- [ ] Syntax highlighting approach decided (custom regex vs external library)
- [ ] Theme decision made (dark only vs theme switching)
- [ ] Component location finalized

---

## Sprint Complete When

All acceptance criteria above are met AND:
- [ ] PR reviewed and approved
- [ ] All tests passing in CI
- [ ] Component integrated into ToolResult
- [ ] Manual smoke test with 10+ different file types (js, ts, py, go, etc.)
- [ ] Performance verified with 5000-line file
