# Sprint Plan: Data Management

**Generated**: 2025-12-24-165200
**Source STATUS**: STATUS-2025-12-24-164500.md (dashboard-parity)
**Epic**: brandon-fryslie_claude-code-proxy-5jo

---

## Sprint Goal

Implement data management controls allowing users to refresh request data on-demand, clear all requests from the database, and configure auto-refresh settings for monitoring active sessions.

---

## Scope

### In Scope
- Manual refresh button for request list
- Manual refresh for stats/analytics data
- Clear all requests functionality with confirmation
- Auto-refresh toggle in settings
- Auto-refresh interval configuration (30s, 1m, 5m, off)
- Visual feedback for refresh state (loading indicators)
- Confirmation dialogs for destructive actions

### Out of Scope
- Selective request deletion (delete individual requests)
- Request export/import functionality
- Data backup/restore
- Database compaction or optimization tools
- Request archiving (soft delete vs hard delete)
- Undo for clear operations

---

## Current State (from STATUS)

**Old Dashboard**:
- Manual refresh button in header (RefreshCw icon)
- Clear all requests with confirmation modal
- No auto-refresh capability (manual only)
- `DELETE /api/requests` endpoint for clearing

**New Dashboard**:
- TanStack Query provides automatic caching and refetching
- No manual refresh button in UI
- No clear all requests functionality
- No settings for auto-refresh
- Settings page is stub (67 LOC placeholder)

---

## Work Items

### P0 - Manual Refresh Button for Request List

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None
**Spec Reference**: Old dashboard `_index.tsx` refresh button • **Status Reference**: STATUS-2025-12-24-164500.md section "Implemented Pages"

#### Description
Add a manual refresh button to the Requests page header that refetches the request list from the backend. Show loading indicator during refresh and handle errors gracefully. Works with TanStack Query's invalidation mechanism.

#### Acceptance Criteria (REQUIRED)
- [ ] Refresh button (RefreshCw icon) visible in Requests page header
- [ ] Click triggers immediate refetch of request list data
- [ ] Button shows spinning animation during refresh
- [ ] Button disabled while refresh in progress
- [ ] Request list updates immediately after successful refresh
- [ ] Error toast shown if refresh fails
- [ ] Keyboard shortcut (Cmd/Ctrl+R) triggers refresh
- [ ] Unit test: Refresh action invalidates correct TanStack Query cache keys
- [ ] E2E test: Click refresh → loading state → updated list

#### Technical Notes
- Use TanStack Query's `queryClient.invalidateQueries(['requests'])`
- Respect existing filters/sort when refreshing (maintain user context)
- Consider invalidating related queries (stats, counts) simultaneously
- Debounce rapid clicks to prevent query spam

---

### P0 - Manual Refresh for Stats/Analytics

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None
**Spec Reference**: Old dashboard pattern • **Status Reference**: STATUS-2025-12-24-164500.md section "Data Flow Verification"

#### Description
Add refresh capability to Dashboard, Usage, Performance, and Routing pages to update stats and charts on-demand. Coordinate multiple query invalidations to ensure consistent data across visualizations.

#### Acceptance Criteria (REQUIRED)
- [ ] Refresh button on Dashboard page header
- [ ] Refresh button on Usage page header
- [ ] Refresh button on Performance page header
- [ ] Refresh button on Routing page header
- [ ] All related queries invalidated simultaneously (stats, hourly, models, providers)
- [ ] Charts update smoothly after refresh (no flicker)
- [ ] Last refresh timestamp displayed (e.g., "Updated 2m ago")
- [ ] Unit test: Refresh invalidates all required query keys
- [ ] E2E test: Refresh dashboard → all stats update

#### Technical Notes
- Dashboard queries to invalidate: `['stats']`, `['stats', 'hourly']`, `['stats', 'models']`
- Use `queryClient.invalidateQueries({ queryKey: ['stats'] })` to invalidate all stats-related queries
- Consider global refresh that updates all pages (toolbar action)
- Display relative timestamp using `date-fns` or similar

---

### P0 - Clear All Requests with Confirmation

**Status**: Not Started
**Effort**: Medium (2 days)
**Dependencies**: None
**Spec Reference**: Old dashboard clear all button • **Status Reference**: STATUS-2025-12-24-164500.md (implied feature)

#### Description
Implement "Clear All Requests" functionality that deletes all request data from the backend database. Require explicit user confirmation with warning about data loss. Provide feedback on success and handle errors.

#### Acceptance Criteria (REQUIRED)
- [ ] "Clear All Requests" button in Settings page or Requests page header
- [ ] Click opens confirmation modal with warning message
- [ ] Confirmation modal requires typing "DELETE" or similar to confirm
- [ ] Cancel button closes modal without action
- [ ] Confirm triggers `DELETE /api/requests` API call
- [ ] Success shows toast notification and redirects to empty state
- [ ] Error shows toast with error details
- [ ] Request list and stats refresh automatically after clear
- [ ] Button disabled during delete operation
- [ ] Unit test: Confirmation flow prevents accidental deletion
- [ ] E2E test: Confirm deletion → all requests cleared → empty state shown

#### Technical Notes
- Backend endpoint: `DELETE /api/requests` (verify exists in Go proxy)
- Confirmation pattern: Require text input "DELETE" to enable confirm button (prevent mis-clicks)
- After successful delete, invalidate ALL queries: `queryClient.clear()` or selective invalidation
- Consider adding request count to warning message (e.g., "Delete 1,234 requests?")

---

### P1 - Auto-Refresh Toggle in Settings

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: New feature (not in old dashboard) • **Status Reference**: STATUS-2025-12-24-164500.md section "Implemented Pages"

#### Description
Add auto-refresh setting to Settings page allowing users to enable/disable automatic data refreshing. Store preference in localStorage and apply globally across all pages. Useful for monitoring active Claude Code sessions in real-time.

#### Acceptance Criteria (REQUIRED)
- [ ] Settings page has "Auto-Refresh" toggle switch
- [ ] Toggle state persisted in localStorage
- [ ] Toggle state loads on app initialization
- [ ] Visual indicator when auto-refresh is active (e.g., pulsing icon in header)
- [ ] Turning on auto-refresh immediately starts refresh timer
- [ ] Turning off auto-refresh stops refresh timer
- [ ] Setting applies to all pages (requests, dashboard, stats)
- [ ] Unit test: Toggle state correctly saved/loaded from localStorage
- [ ] E2E test: Enable auto-refresh → data refreshes automatically

#### Technical Notes
- Use `localStorage.getItem('autoRefresh')` / `setItem()`
- Global state management: React Context or Zustand for auto-refresh state
- Hook into TanStack Query's `refetchInterval` option or use custom `useInterval` hook
- Default: OFF (don't refresh automatically, can be costly)

---

### P1 - Auto-Refresh Interval Configuration

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Auto-Refresh Toggle in Settings
**Spec Reference**: New feature • **Status Reference**: STATUS-2025-12-24-164500.md (implied)

#### Description
Allow users to configure auto-refresh interval from preset options (30s, 1m, 5m, custom). Store preference in localStorage and use to set TanStack Query refetch intervals.

#### Acceptance Criteria (REQUIRED)
- [ ] Settings page has interval selector (radio buttons or dropdown)
- [ ] Options: 30 seconds, 1 minute, 5 minutes, 10 minutes
- [ ] Selected interval persisted in localStorage
- [ ] Interval applies to all auto-refresh queries
- [ ] Changing interval while auto-refresh active immediately updates timer
- [ ] Default interval: 1 minute
- [ ] Visual indicator shows current interval (e.g., "Auto-refresh: ON (1m)")
- [ ] Unit test: Interval value correctly saved/loaded
- [ ] E2E test: Change interval → verify refresh happens at new interval

#### Technical Notes
- Store interval in milliseconds: 30s = 30000, 1m = 60000, etc.
- Apply via TanStack Query: `refetchInterval: autoRefreshEnabled ? interval : false`
- Consider different intervals for different data types (requests: 30s, stats: 5m)
- Add warning if interval < 30s (potential performance impact)

---

### P2 - Refresh All Data Global Action

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Manual Refresh buttons
**Spec Reference**: New feature • **Status Reference**: STATUS-2025-12-24-164500.md (usability)

#### Description
Add global "Refresh All" action in main toolbar/header that invalidates all queries across the entire application. Useful for ensuring completely fresh data after configuration changes or suspected stale data.

#### Acceptance Criteria (REQUIRED)
- [ ] "Refresh All" button in main app header/toolbar
- [ ] Click invalidates all TanStack Query caches
- [ ] Loading state shown globally (progress bar or overlay)
- [ ] All pages update after refresh completes
- [ ] Keyboard shortcut (Cmd/Ctrl+Shift+R) triggers global refresh
- [ ] Success toast notification shown
- [ ] Unit test: Global refresh invalidates all query keys
- [ ] E2E test: Navigate to different pages → global refresh → all data updated

#### Technical Notes
- Use `queryClient.invalidateQueries()` without filter to invalidate ALL queries
- Alternatively: `queryClient.clear()` to remove all cache, then refetch
- Consider showing modal: "Refreshing all data..." with progress indicator
- Avoid refreshing too frequently (debounce or cooldown period)

---

### P2 - Last Refresh Timestamp Display

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Manual Refresh buttons
**Spec Reference**: New feature • **Status Reference**: STATUS-2025-12-24-164500.md (usability)

#### Description
Display "last refreshed" timestamp on each page to give users confidence in data freshness. Update timestamp after manual or auto-refresh. Format as relative time (e.g., "Updated 2m ago") with tooltip showing absolute time.

#### Acceptance Criteria (REQUIRED)
- [ ] Timestamp displayed on Requests, Dashboard, Usage, Performance, Routing pages
- [ ] Timestamp updates after manual refresh
- [ ] Timestamp updates after auto-refresh
- [ ] Format: "Updated Xm ago" or "Updated Xs ago"
- [ ] Tooltip shows absolute timestamp (e.g., "2025-12-24 16:52:00")
- [ ] Timestamp updates in real-time (every 10s) without refetching data
- [ ] Unit test: Timestamp calculation accurate
- [ ] E2E test: Refresh → timestamp updates

#### Technical Notes
- Use `date-fns` or `dayjs` for relative time formatting
- Store refresh timestamp in TanStack Query's `dataUpdatedAt` or custom React state
- Update display every 10-30s using `setInterval`
- Position: Typically in page header next to refresh button

---

### P3 - Request Count Before Clear

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Clear All Requests with Confirmation
**Spec Reference**: Usability enhancement • **Status Reference**: STATUS-2025-12-24-164500.md

#### Description
Show current request count in the "Clear All Requests" confirmation modal to give users context about how much data will be deleted. Helps prevent accidental deletion when user expects small count but sees large number.

#### Acceptance Criteria (REQUIRED)
- [ ] Confirmation modal displays: "Delete X requests?"
- [ ] Count fetched from backend or derived from current request list
- [ ] Count accurate at time of modal open (not stale)
- [ ] Warning message severity increases with count (e.g., >1000 shows red warning)
- [ ] Unit test: Count displayed matches actual request count
- [ ] E2E test: Open modal → count shown → cancel → count unchanged

#### Technical Notes
- Query `GET /api/requests/summary` with count-only parameter or use existing data
- Alternative: Add `GET /api/requests/count` endpoint for efficiency
- Format large numbers: 1,234 vs 1234
- Consider showing storage size if backend provides it

---

## Dependencies

### External Dependencies
- None (all functionality uses existing libraries)

### Internal Dependencies
- TanStack Query for cache invalidation
- Backend endpoints: `DELETE /api/requests`, `GET /api/requests/count` (optional)

### Cross-Sprint Dependencies
- **Blocks**: None
- **Blocked By**: None
- **Related**: Settings page needs basic structure (currently stub)

---

## Risks

### Technical Risks

**Risk 1**: Auto-refresh performance impact on backend with high frequency
- **Likelihood**: Medium
- **Impact**: Medium (server load, API rate limits)
- **Mitigation**: Default to OFF, minimum interval 30s, warn users about performance

**Risk 2**: Clear all requests operation timeout on large databases
- **Likelihood**: Low
- **Impact**: High (partial delete, data inconsistency)
- **Mitigation**: Backend should handle as transaction, show progress for large deletes, add timeout handling

**Risk 3**: TanStack Query cache invalidation edge cases
- **Likelihood**: Low
- **Impact**: Medium (stale data shown after refresh)
- **Mitigation**: Test invalidation thoroughly, use broad query key matching, clear cache if unsure

### UX Risks

**Risk 4**: Users accidentally clear all requests
- **Likelihood**: Medium (despite confirmation)
- **Impact**: High (data loss, frustration)
- **Mitigation**: Require typing "DELETE", show count, add undo or soft-delete in future

**Risk 5**: Auto-refresh causes UI jank or lost scroll position
- **Likelihood**: Medium
- **Impact**: Medium (poor UX during active use)
- **Mitigation**: Use TanStack Query's background refetch, maintain scroll position, only update DOM if data actually changed

---

## Testing Strategy

### Unit Tests
- TanStack Query invalidation logic
- localStorage persistence for settings
- Auto-refresh interval calculation
- Confirmation modal state management

### Integration Tests
- Manual refresh → data updates
- Auto-refresh → periodic updates
- Clear all → empty state
- Settings persist across sessions

### E2E Tests
- Full refresh workflow (manual + auto)
- Clear all with confirmation
- Settings changes apply globally

### Manual Testing Scenarios
1. Enable auto-refresh → leave browser open 5 minutes → verify periodic updates
2. Clear all with 1000+ requests → verify speed and success
3. Refresh during active request creation → verify no conflicts
4. Change auto-refresh interval while active → verify new interval applies
5. Disable auto-refresh → verify updates stop

---

## Recommended Sprint Approach

**Week 1**:
1. Day 1: Manual refresh for requests
2. Day 2: Manual refresh for stats
3. Day 3: Clear all requests with confirmation
4. Day 4: Auto-refresh toggle
5. Day 5: Auto-refresh interval configuration

**Week 2**:
1. Day 1: Global refresh action
2. Day 2: Last refresh timestamp
3. Day 3: Request count before clear
4. Day 4-5: Testing, polish, documentation

**Total Effort**: 7-9 days

---

## Success Metrics

- Manual refresh completes in under 2 seconds for lists with 1000 requests
- Auto-refresh has zero noticeable UI impact (no jank, scroll preserved)
- Clear all operation completes in under 5 seconds for 10,000 requests
- Zero accidental data deletions reported by users (confirmation effective)
- Settings persist 100% across browser sessions

---

## Open Questions

1. **Undo for Clear All**: Should we implement soft-delete or undo capability?
   - **Decision**: Out of scope for MVP, add to backlog if users request

2. **Auto-Refresh Scope**: Should auto-refresh apply to conversation list as well?
   - **Recommendation**: Yes, include conversations in auto-refresh scope

3. **Clear All Granularity**: Should users be able to clear by date range or filter?
   - **Decision**: Out of scope, add selective deletion to future backlog

4. **Backend Pagination**: Does backend support pagination for request list? Impacts refresh strategy.
   - **Action**: Verify with backend API documentation

5. **Export Before Clear**: Should we prompt to export before clearing?
   - **Decision**: Nice-to-have, out of scope for this sprint

---

## Related Epics

- **Epic**: brandon-fryslie_claude-code-proxy-5jo (Data Management)
- **Phase**: 5 (Advanced Features)
- **Depends On**: Core request list and stats pages
- **Enables**: Real-time monitoring, database maintenance, user control

---

## Notes

- Data management is critical for long-running Claude Code sessions (developers may accumulate 1000s of requests)
- Auto-refresh is new capability not in old dashboard (improvement!)
- Consider adding data retention policies (auto-delete after 30 days) in future
- Export functionality is separate epic, can be integrated with clear all workflow later
- Settings page needs to be fleshed out beyond just auto-refresh (theme, API key display, etc.)
