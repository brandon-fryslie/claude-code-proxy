# Sprint Plan: Request Comparison

**Generated**: 2025-12-24-165000
**Source STATUS**: STATUS-2025-12-24-164500.md (dashboard-parity)
**Epic**: brandon-fryslie_claude-code-proxy-wa1

---

## Sprint Goal

Implement side-by-side request comparison allowing developers to analyze differences in prompts, responses, token usage, and timing between any two requests.

---

## Scope

### In Scope
- Multi-select UI for selecting 2 requests from the list
- Side-by-side comparison modal/view
- Diff visualization for request bodies (prompts, system messages, tools)
- Diff visualization for response content
- Token usage comparison (input/output/cache)
- Timing and performance comparison
- Model/routing comparison
- Export comparison as JSON

### Out of Scope
- Comparing more than 2 requests at once
- Historical comparison tracking (saved comparisons)
- AI-powered diff analysis or summarization
- Inline editing of requests during comparison
- Comparison of conversations (vs individual requests)

---

## Current State (from STATUS)

**Old Dashboard** (`web/app/components/RequestCompareModal.tsx`):
- 1,152 LOC fully-featured comparison modal
- Side-by-side layout with synchronized scrolling
- Granular diffs for all request/response sections
- Token and timing comparison
- Uses `CodeDiff.tsx` (102 LOC) for code-level diffs
- Multi-select UI integrated into main list view

**New Dashboard**:
- No comparison capability exists
- Request list supports selection (basic UI pattern available)
- Individual request detail view exists but no comparison logic

---

## Work Items

### P0 - Multi-Select Request UI

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: Old dashboard `_index.tsx` lines 1-100 • **Status Reference**: STATUS-2025-12-24-164500.md section "Component Comparison"

#### Description
Add multi-select capability to the Requests page allowing users to select exactly 2 requests for comparison. Include visual indicators (checkboxes or highlight), a "Compare Selected" button that activates when exactly 2 requests are selected, and clear selection controls.

#### Acceptance Criteria (REQUIRED)
- [ ] User can select/deselect individual requests via checkbox or click modifier
- [ ] Visual indicator (highlight/checkbox) shows which requests are selected
- [ ] "Compare Selected" button appears when 2 requests are selected
- [ ] Button is disabled when 0, 1, or 3+ requests are selected
- [ ] "Clear Selection" action resets all selections
- [ ] Selection state persists when scrolling through virtualized list
- [ ] Unit test: Selection state management handles edge cases (select same request twice, deselect correctly)

#### Technical Notes
- Integrate with existing virtualized request list
- Use React state to track selected request IDs (Set or array)
- Consider keyboard shortcuts (Ctrl+Click, Shift+Click) for UX
- Selection should work with both RequestSummary (list) and full Request objects

---

### P0 - Side-by-Side Comparison Layout

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: Multi-Select Request UI
**Spec Reference**: Old dashboard `RequestCompareModal.tsx` lines 1-300 • **Status Reference**: STATUS-2025-12-24-164500.md section "Advanced Gaps"

#### Description
Create a comparison view component with side-by-side layout for 2 requests. Include synchronized sections (Metadata, Request Body, Response, Timing, Tokens) with expand/collapse controls, clear labeling of left vs right request, and responsive layout handling.

#### Acceptance Criteria (REQUIRED)
- [ ] Side-by-side layout displays 2 requests with clear visual separation (50/50 split or adjustable)
- [ ] Metadata section shows model, timestamp, endpoint for both requests
- [ ] Collapsible sections for Request Body, System Messages, Tools, Response, Usage
- [ ] All sections can expand/collapse independently
- [ ] Visual hierarchy matches existing RequestDetailContent pattern
- [ ] Close button returns user to request list
- [ ] Layout is responsive and usable on smaller screens (stacks vertically if needed)
- [ ] Unit test: Component renders with 2 request objects and displays key fields correctly

#### Technical Notes
- Port layout pattern from `RequestCompareModal.tsx` but adapt to new dashboard's component structure
- Use ResizablePanel pattern if available in new dashboard
- Consider modal vs full-page view (recommend modal for quick comparison)
- Reuse styling from existing detail views for consistency

---

### P1 - Request/Response Content Diffing

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: Side-by-Side Comparison Layout
**Spec Reference**: Old dashboard `CodeDiff.tsx` lines 1-102 • **Status Reference**: STATUS-2025-12-24-164500.md section "Advanced Gaps"

#### Description
Implement diff visualization for request and response content using line-by-line comparison. Show additions (green), deletions (red), and unchanged content (gray). Handle JSON formatting, text content, and nested message structures.

#### Acceptance Criteria (REQUIRED)
- [ ] Request body differences highlighted (system messages, user prompts, tool definitions)
- [ ] Response content differences highlighted (assistant messages, tool use/results)
- [ ] Line-by-line diff with color coding: green (+), red (-), gray (unchanged)
- [ ] JSON objects are formatted and compared structurally (not string comparison)
- [ ] Long content can be collapsed/expanded to show only changed sections
- [ ] Empty/null values handled gracefully (e.g., one request has tools, other doesn't)
- [ ] Unit test: Diff algorithm correctly identifies additions, deletions, and unchanged lines
- [ ] E2E test: Compare 2 known requests and verify diff highlights appear correctly

#### Technical Notes
- Port `CodeDiff.tsx` component or use a library like `react-diff-viewer` or `diff-match-patch`
- Consider performance for large responses (use virtualization or lazy rendering)
- Handle different content types: text, JSON objects, arrays
- Normalize formatting before comparison (e.g., consistent JSON indentation)

---

### P1 - Token and Performance Metrics Comparison

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Side-by-Side Comparison Layout
**Spec Reference**: Old dashboard `RequestCompareModal.tsx` lines 400-600 • **Status Reference**: STATUS-2025-12-24-164500.md section "Advanced Gaps"

#### Description
Display side-by-side token usage and performance metrics with delta calculations. Show input tokens, output tokens, cache tokens, total tokens, response time, and calculate percentage differences between the two requests.

#### Acceptance Criteria (REQUIRED)
- [ ] Token comparison table shows: input_tokens, output_tokens, cache_creation_input_tokens, cache_read_input_tokens, total_tokens
- [ ] Deltas calculated and displayed (absolute difference and percentage)
- [ ] Color coding: green for better (lower cost/time), red for worse
- [ ] Response time comparison with delta
- [ ] Handle missing usage data gracefully (show "N/A" or "-")
- [ ] Visual indicator if one request used caching and other didn't
- [ ] Unit test: Delta calculations are accurate for various token combinations

#### Technical Notes
- Reuse existing performance metric display patterns from Performance page
- Formula: delta% = ((new - old) / old) * 100
- Consider which request is "baseline" (left or right) for delta direction
- Token costs could be calculated if pricing data available (future enhancement)

---

### P2 - Model and Routing Comparison

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Side-by-Side Comparison Layout
**Spec Reference**: Old dashboard `RequestCompareModal.tsx` lines 200-300 • **Status Reference**: STATUS-2025-12-24-164500.md section "Data Flow Verification"

#### Description
Compare model selection and routing decisions between 2 requests. Show original model, routed model (if different), provider, and highlight differences in routing logic (e.g., subagent routing).

#### Acceptance Criteria (REQUIRED)
- [ ] Display originalModel and routedModel for both requests
- [ ] Highlight if routing differed (one routed to subagent, other didn't)
- [ ] Show provider information (Anthropic vs OpenAI)
- [ ] Visual indicator if models are identical vs different
- [ ] Handle requests without routing data (non-subagent requests)
- [ ] Unit test: Correctly identifies routing differences in test cases

#### Technical Notes
- Reference proxy routing logic from `proxy/internal/service/model_router.go`
- May need to fetch additional metadata from backend if not in request summary
- Consider showing "why" routing differed (different system prompt hash?)

---

### P2 - Export Comparison Data

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: All comparison sections implemented
**Spec Reference**: Old dashboard `RequestCompareModal.tsx` lines 900-1000 • **Status Reference**: STATUS-2025-12-24-164500.md (implied feature)

#### Description
Allow users to export the comparison view as structured JSON for external analysis or sharing. Include all compared data: metadata, token deltas, timing deltas, and full request/response content.

#### Acceptance Criteria (REQUIRED)
- [ ] Export button triggers download of comparison JSON file
- [ ] JSON structure includes: both request IDs, metadata, usage comparison, timing comparison, content diffs
- [ ] Filename includes both request IDs and timestamp (e.g., `comparison_1234_5678_20251224.json`)
- [ ] JSON is properly formatted and parseable
- [ ] Export includes human-readable summary section
- [ ] Unit test: Exported JSON has all required fields and valid structure

#### Technical Notes
- Use browser's download API: `URL.createObjectURL()` + `<a download>`
- Consider optional CSV export for metrics only (future enhancement)
- Structure should be importable for comparison replay (future feature)

---

## Dependencies

### External Dependencies
- `diff-match-patch` or similar diff library (if not implementing custom)
- No new backend endpoints needed (uses existing `/api/requests/{id}`)

### Internal Dependencies
- Existing RequestDetailContent patterns
- Existing request loading/caching logic
- Code syntax highlighting (CodeViewer component from other sprint)

### Cross-Sprint Dependencies
- **Blocks**: None (standalone feature)
- **Blocked By**: None (can implement independently)
- **Nice to Have**: Code Viewer component (for better code diffs), but not required

---

## Risks

### Technical Risks

**Risk 1**: Diff performance on very large responses (20k+ token responses)
- **Likelihood**: Medium
- **Impact**: High (UI freeze, poor UX)
- **Mitigation**: Use virtualization, limit diff to first 10k characters with "show more" option

**Risk 2**: Complex nested JSON comparison (tools with large schemas)
- **Likelihood**: Medium
- **Impact**: Medium (confusing diff output)
- **Mitigation**: Provide multiple diff modes (raw JSON, formatted, semantic)

**Risk 3**: Selection state conflicts with virtualized list
- **Likelihood**: Low
- **Impact**: Medium (lost selections when scrolling)
- **Mitigation**: Store selections by ID not index, test thoroughly with large lists

### UX Risks

**Risk 4**: Users accidentally compare unrelated requests
- **Likelihood**: High
- **Impact**: Low (confusing but harmless)
- **Mitigation**: Show clear labels, add confirmation step, allow quick re-selection

**Risk 5**: Side-by-side layout too cramped on smaller screens
- **Likelihood**: High
- **Impact**: Medium (unusable on laptop screens)
- **Mitigation**: Responsive layout with vertical stacking option, horizontal scroll fallback

---

## Testing Strategy

### Unit Tests
- Selection state management (add/remove, max 2 selections)
- Diff algorithm correctness (additions, deletions, unchanged)
- Delta calculations (tokens, percentages)
- Export JSON structure validation

### Integration Tests
- Load 2 requests → display comparison → all sections render
- Compare identical requests → no diffs shown
- Compare completely different requests → all diffs shown
- Export → download triggers → valid JSON

### E2E Tests
- Full user flow: Select 2 requests → open comparison → explore sections → export
- Selection persistence through scrolling
- Close comparison → return to list with selections cleared

### Manual Testing Scenarios
1. Compare 2 requests with different models (opus vs sonnet)
2. Compare routed vs non-routed request
3. Compare requests with/without caching
4. Compare requests with significantly different token usage
5. Compare requests with different tool sets

---

## Recommended Sprint Approach

**Week 1**:
1. Day 1-2: Multi-select UI + selection state management
2. Day 3-4: Side-by-side comparison layout skeleton
3. Day 5: Token/metrics comparison (quick win)

**Week 2**:
1. Day 1-3: Request/response content diffing (most complex)
2. Day 4: Model/routing comparison
3. Day 5: Export functionality + polish

**Total Effort**: 8-10 days

---

## Success Metrics

- Users can select and compare any 2 requests in under 10 seconds
- Diff algorithm processes requests up to 10k tokens in under 1 second
- Token delta calculations are accurate within 0.1%
- Export JSON validates against schema
- No performance degradation when comparison modal is open

---

## Open Questions

1. **Diff Library Choice**: Should we use `diff-match-patch`, `react-diff-viewer`, or build custom?
   - **Recommendation**: Start with `react-diff-viewer` for speed, custom implementation if needed for specific formatting

2. **Comparison Persistence**: Should comparisons be saveable for later review?
   - **Decision**: Out of scope for this sprint, add to backlog

3. **Multi-Request Comparison**: Future need to compare 3+ requests?
   - **Decision**: Not for MVP, gather user feedback first

4. **Semantic Diff**: Should we show semantic differences (e.g., "prompt added 3 new sentences") vs raw text diff?
   - **Decision**: Raw diff for MVP, semantic analysis is future enhancement

---

## Related Epics

- **Epic**: brandon-fryslie_claude-code-proxy-wa1 (Request Comparison)
- **Phase**: 5 (Advanced Features)
- **Depends On**: Phase 1-4 core infrastructure
- **Enables**: Advanced debugging workflows, A/B testing of prompts

---

## Notes

- This is one of the highest value features from old dashboard (1,152 LOC component)
- Critical for prompt engineering and debugging workflows
- Consider adding "quick compare" (compare with previous request) shortcut
- Port UX patterns from old RequestCompareModal but modernize with new component library
