# Sprint Plan: Unified Conversation Search with Filters

**Sprint Date:** 2026-01-12
**Estimated Effort:** 8-12 hours
**Status:** Ready for Implementation

---

## Sprint Goal

Enable users to search across ALL conversations and their content with filter checkboxes to show/hide message types (User, Claude, Subagents, Other).

---

## Scope

**In scope (this sprint):**
- P0: Backend - Enhanced search API returning message-level results with type filters
- P1: Frontend - Global search component with filter checkboxes and results display

**Explicitly out of scope (future sprints):**
- Search within request logs
- Advanced filter operators (AND/OR/NOT)
- Saved searches
- Date range filtering

---

## Work Items

### P0: Backend - Enhanced Search API with Message-Level Results

**Objective:** Modify the existing search endpoint to return message-level results with context snippets and support type filtering.

**Implementation Steps:**

1. **Add new model types** (`proxy/internal/model/models.go`)
   - Add `MessageSearchResult` struct for message-level results
   - Update `SearchOptions` with `MessageTypes []string` field
   - Update `SearchResults` to include grouped message results

2. **Enhance storage search method** (`proxy/internal/service/storage_sqlite.go`)
   - Modify `SearchConversations()` to return message-level results
   - Add SQL JOIN to `conversation_messages` table
   - Use SQLite `snippet()` function for ~100 char context extraction
   - Filter by message type:
     - User: `type = 'user'`
     - Claude: `type = 'assistant' AND agent_id IS NULL`
     - Subagents: `type = 'assistant' AND agent_id IS NOT NULL`
     - Other: `type NOT IN ('user', 'assistant')`

3. **Update handler** (`proxy/internal/handler/data_handler.go`)
   - Parse `types` query parameter (comma-separated)
   - Pass filters to storage method

**Technical Notes:**
- FTS5 `snippet()` function: `snippet(conversations_fts, 3, '<mark>', '</mark>', '...', 20)`
- Column index 3 = `content_text` in FTS table

---

### P1: Frontend - Global Search Component with Filters

**Objective:** Create a search UI that searches across ALL conversations with filter checkboxes and displays results grouped by conversation.

**Implementation Steps:**

1. **Add types** (`dashboard/src/lib/types.ts`)
   - `SearchFilters` interface
   - `MessageSearchResult` interface
   - `ConversationSearchResult` interface
   - `SearchResultsResponse` interface

2. **Add API hook** (`dashboard/src/lib/api.ts`)
   - Add `useConversationSearch(query, filters)` hook
   - Build query string with `types` parameter

3. **Create GlobalSearchResults component** (`dashboard/src/components/features/GlobalSearchResults.tsx`)
   - Results grouped by conversation header
   - Message snippets with highlighted matches
   - Type badges (User/Claude/Subagent/Other)
   - Click to select conversation

4. **Update ConversationSearch component** (`dashboard/src/components/features/ConversationSearch.tsx`)
   - Add filter checkbox row: User, Claude, Subagents, Other
   - Default all filters ON
   - Debounce search input (300ms)

5. **Integrate into Conversations page** (`dashboard/src/pages/Conversations.tsx`)
   - Show GlobalSearchResults when searching
   - Show ConversationList when not searching (empty state)

**UX Behavior:**
- Empty search input: Show recent conversations (current behavior)
- Search active: Show API results grouped by conversation
- Filters: Unchecking removes those message types from results

---

## Dependencies

- ✅ FTS5 database already indexed and working
- ✅ API endpoint `/api/v2/conversations/search` exists
- ✅ `conversation_messages` table has `agent_id` for subagent detection

---

## Risks

| Risk | Mitigation |
|------|------------|
| Query performance on 90K+ messages | FTS5 tested <10ms, add pagination |
| Filter edge cases with agent_id | Verify indexer populates correctly |
| UI state complexity | Use React Query for async, local state for filters |

---

## Deliverables Summary

| Priority | Deliverable | Files Modified |
|----------|-------------|----------------|
| P0 | Backend: Enhanced search API | models.go, storage_sqlite.go, data_handler.go |
| P1 | Frontend: Global search UI | types.ts, api.ts, GlobalSearchResults.tsx (new), ConversationSearch.tsx, Conversations.tsx |
