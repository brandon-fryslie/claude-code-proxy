# Sprint Plan: Virtualized Request List

**Generated**: 2025-12-24-223454
**Source**: STATUS-2025-12-24-164500.md
**Epic**: brandon-fryslie_claude-code-proxy-pyf
**Sprint Goal**: Replace flat list rendering with virtualization to efficiently handle 1000s of requests without performance degradation.

---

## Executive Summary

**Current State**: New dashboard renders all 100 requests directly (hardcoded limit). Won't scale to 1000s of requests.

**Target State**: Virtualized list using `@tanstack/react-virtual` that renders only visible items, matching old dashboard's proven pattern.

**Total Items**: 4 work items (2 P0, 1 P1, 1 P2)

**Gap**: Missing dependency `@tanstack/react-virtual` (old dashboard has it, new doesn't)

---

## Sprint Scope

### In Scope
- Install `@tanstack/react-virtual` dependency
- Replace flat map rendering in `Requests.tsx` with virtualized list
- Remove hardcoded 100-item limit from API calls
- Lazy load full request details on-demand
- Scroll-to-top and scroll-to-item utilities

### Out of Scope
- Infinite scroll pagination (load all items at once, virtualize rendering)
- Complex filtering/search (that's a separate epic)
- Virtualization for other lists (conversations, etc.)
- Custom scrollbar styling

### Dependencies
- Backend `/api/requests/summary` endpoint must handle requests without limit param (or with very high limit)
- TanStack Query for caching request details

---

## Work Items

### [P0] Install and Configure @tanstack/react-virtual

**Status**: Not Started
**Effort**: Small (half day)
**Dependencies**: None
**Spec Reference**: CLAUDE.md "Virtualization" pattern • **Status Reference**: STATUS-2025-12-24-164500.md Section "Dependency Analysis" line 309

#### Description
Add the virtualization library to the project and verify it's compatible with React 19 (new dashboard uses React 19, old uses React 18).

#### Acceptance Criteria
- [ ] `@tanstack/react-virtual` added to `dashboard/package.json` with version ^3.13.12 or later
- [ ] `pnpm install` completes without errors
- [ ] No peer dependency conflicts with React 19
- [ ] Import `useVirtualizer` in test file to verify installation

#### Technical Notes
- Old dashboard uses `@tanstack/react-virtual: ^3.13.12`
- Check compatibility: https://tanstack.com/virtual/latest/docs/framework/react/react-virtual
- React 19 is newer than when old dashboard was built - verify no breaking changes

---

### [P0] Implement Virtualized List in Requests Page

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: @tanstack/react-virtual installed
**Spec Reference**: CLAUDE.md "Virtualized Request List" • **Status Reference**: STATUS-2025-12-24-164500.md Section "Feature Gap Analysis" line 114

#### Description
Replace the flat `.map()` rendering in `Requests.tsx` with `useVirtualizer` hook to render only visible items. Port pattern from old dashboard's `_index.tsx`.

#### Acceptance Criteria
- [ ] `useVirtualizer` hook configured with parent ref and item count
- [ ] Only visible request items rendered (verify in React DevTools)
- [ ] Scrolling through 1000+ requests feels smooth (no jank, 60fps)
- [ ] Selected item remains visible when clicking (no jump)
- [ ] Unit test: Virtualization renders correct items based on scroll position

#### Technical Notes
- Reference: `web/app/routes/_index.tsx` lines 214-215, 475-520 (virtualization setup)
- Key props: `count`, `getScrollElement`, `estimateSize`, `overscan`
- Use `parentRef` on scrollable container div
- Item height: estimate ~60px based on `RequestListItem` component
- Set `overscan: 5` to pre-render items just outside viewport

**Code Pattern**:
```tsx
const parentRef = useRef<HTMLDivElement>(null)
const virtualizer = useVirtualizer({
  count: filteredRequests.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 60, // RequestListItem height
  overscan: 5,
})

return (
  <div ref={parentRef} className="h-full overflow-auto">
    <div style={{ height: `${virtualizer.getTotalSize()}px`, position: 'relative' }}>
      {virtualizer.getVirtualItems().map((virtualItem) => (
        <div
          key={filteredRequests[virtualItem.index].requestId}
          style={{
            position: 'absolute',
            top: 0,
            left: 0,
            width: '100%',
            transform: `translateY(${virtualItem.start}px)`,
          }}
        >
          <RequestListItem request={filteredRequests[virtualItem.index]} />
        </div>
      ))}
    </div>
  </div>
)
```

---

### [P1] Remove Hardcoded 100-Item Limit

**Status**: Not Started
**Effort**: Small (half day)
**Dependencies**: Virtualized list implementation
**Spec Reference**: None (bug fix) • **Status Reference**: STATUS-2025-12-24-164500.md Section "Data Flow Verification" line 225

#### Description
Update `useRequestsSummary` API hook to fetch all requests for selected date range instead of limiting to 100 items.

#### Acceptance Criteria
- [ ] `limit: 100` removed from API call in `lib/api.ts`
- [ ] Backend returns all requests for date range (verify with 500+ request day)
- [ ] Request list displays all returned requests via virtualization
- [ ] No performance degradation with 1000+ requests loaded
- [ ] Query cache size monitored (should be <5MB for typical dataset)

#### Technical Notes
- Current code: `dashboard/src/lib/api.ts` likely has `limit: 100` hardcoded
- Backend should handle unlimited requests efficiently (it's a summary endpoint, minimal data per request)
- Consider adding optional limit param for initial page load optimization (stretch goal)
- Monitor memory usage in browser DevTools with large datasets

---

### [P2] Implement Lazy Loading for Request Details

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Virtualized list, TanStack Query
**Spec Reference**: CLAUDE.md "Lazy Loading" pattern • **Status Reference**: STATUS-2025-12-24-164500.md Section "Data Flow Verification" lines 217-223

#### Description
Ensure full request details are only fetched when user clicks on a request item, not eagerly loaded for all items in the list. This is already partially implemented via `useRequestDetail`, but verify it's optimal.

#### Acceptance Criteria
- [ ] Clicking request item triggers single `GET /api/requests/{id}` call
- [ ] TanStack Query caches response to avoid refetching on re-selection
- [ ] Network tab shows no requests being fetched for non-selected items
- [ ] Cache eviction configured (keep last 50 request details, LRU)
- [ ] Loading state displays while fetching request details

#### Technical Notes
- Current implementation in `Requests.tsx` already uses `useRequestDetail(requestId)` which is conditionally called
- Verify TanStack Query cache is configured properly:
  ```tsx
  queryClient.setQueryDefaults(['request-detail'], {
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
    // Optional: limit cache size
  })
  ```
- Old dashboard uses `Map` for manual caching - new approach with TanStack Query is better
- Consider prefetching adjacent items on hover (stretch goal)

---

## Dependency Graph

```
Install @tanstack/react-virtual (P0)
  └── Implement Virtualized List (P0)
        ├── Remove 100-Item Limit (P1)
        └── Lazy Loading Optimization (P2)
```

**Critical Path**: Install Dependency → Virtualize List → Remove Limit

---

## Recommended Sprint Execution Order

1. **Day 1 (Morning)**: Install `@tanstack/react-virtual`, verify compatibility
2. **Day 1 (Afternoon) - Day 3**: Implement virtualized list in `Requests.tsx`
3. **Day 4**: Remove hardcoded limit, test with large datasets
4. **Day 5**: Optimize lazy loading and cache configuration

**Total Sprint Duration**: 5 days (1 week)

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| React 19 incompatibility with react-virtual | Low | High | Test immediately, have fallback plan to downgrade React if needed |
| Virtualization causes layout jank | Medium | Medium | Use fixed item heights, set proper `estimateSize`, test on slow devices |
| Backend chokes on unlimited requests query | Low | High | Monitor backend perf, add pagination if needed |
| Memory leak with large datasets | Medium | Medium | Configure TanStack Query cache limits, monitor memory in DevTools |

**Overall Risk**: LOW-MEDIUM - Proven pattern from old dashboard, but React 19 is new.

---

## Blockers and Questions

### Questions for User

1. **Expected max requests per day**: How many requests do we expect in a typical day? (Determines if we need server-side pagination)

2. **Backend query performance**: Has the backend been tested with unlimited `summary` queries? Should we add a sanity limit (e.g., 10,000)?

### Blockers

None - backend API already supports the required queries.

---

## Testing Strategy

### Unit Tests
- Virtualization renders correct subset of items based on scroll position
- Item selection updates selected state correctly
- Lazy loading only fetches clicked items

### Integration Tests
- Load 500+ requests → verify only ~20 DOM nodes rendered (visible items)
- Scroll to bottom → verify new items render, old items unmount
- Click item → verify details load, cache works on re-selection

### Performance Tests
- Benchmark: Load 1000 requests → measure initial render time (<2s)
- Benchmark: Scroll through 1000 requests → measure frame rate (>50fps)
- Memory: Load 1000 requests → measure heap size (<50MB)

### E2E Tests
- User flow: Load page → see virtualized list → scroll → select item → see details
- Edge case: Rapidly scroll + click → no race conditions

---

## Success Metrics

- Request list handles 1000+ items without performance degradation
- Initial page load <2s even with large datasets
- Scrolling maintains 60fps on mid-range devices
- Memory usage <50MB with 1000 requests loaded
- Zero layout shift or jank during scroll

---

## Appendix: Code References

**Old Dashboard Files**:
- `web/app/routes/_index.tsx` lines 214-215 (virtualizer setup)
- `web/app/routes/_index.tsx` lines 475-520 (virtualized rendering)
- `web/app/routes/_index.tsx` lines 316-360 (lazy loading with Map cache)

**New Dashboard Files to Modify**:
- `dashboard/src/pages/Requests.tsx` (replace flat list with virtualizer)
- `dashboard/src/lib/api.ts` (remove limit param)
- `dashboard/package.json` (add dependency)

**Dependencies**:
```json
{
  "@tanstack/react-virtual": "^3.13.12"
}
```
