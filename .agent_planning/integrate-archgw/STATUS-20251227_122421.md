# Status Report: integrate-archgw
**Timestamp:** 2025-12-27T12:24:21
**Scope:** topic/integrate-archgw
**Confidence:** FRESH
**Status:** PROPOSED (No implementation started)

---

## Executive Summary

**ArchGW has been renamed to Plano** and is now a Rust/Envoy-based proxy server for agentic AI applications. The claude-code-proxy already has a working provider routing system in Go. Integrating ArchGW/Plano would mean either:

1. **Replace** the existing Go proxy with Plano entirely
2. **Integrate** Plano as an upstream routing target
3. **Port** specific Plano features into the existing Go codebase

**Recommendation: PAUSE** - This integration requires clarification on goals before proceeding.

---

## What Exists: Current Proxy Routing System

### Architecture Overview

The claude-code-proxy has a complete, working provider routing system:

```
Request Flow:
  Client Request (/v1/messages)
       |
       v
  handler.Messages() [handlers.go:49-137]
       |
       v
  ModelRouter.DetermineRoute() [model_router.go:169-230]
       |
       +-- Check subagent routing (Claude Code agents)
       +-- Hash system prompt, match against loaded .claude/agents/*.md
       +-- Return RoutingDecision: Provider + TargetModel
       |
       v
  Provider.ForwardRequest() [provider.go interface]
       |
       +-- AnthropicProvider [anthropic.go] - Passthrough
       +-- OpenAIProvider [openai.go] - Format conversion
       v
  Response (streaming or non-streaming)
```

### Current Provider Support

| Provider | Format | Conversion | Status |
|----------|--------|------------|--------|
| Anthropic | anthropic | None (passthrough) | Working |
| OpenAI | openai | Full Anthropic-to-OpenAI conversion | Working |
| Any OpenAI-compatible | openai | Uses OpenAI conversion | Working |

**Code locations:**
- Provider interface: `/Users/bmf/code/brandon-fryslie_claude-code-proxy/proxy/internal/provider/provider.go`
- Anthropic provider: `/Users/bmf/code/brandon-fryslie_claude-code-proxy/proxy/internal/provider/anthropic.go` (143 lines)
- OpenAI provider: `/Users/bmf/code/brandon-fryslie_claude-code-proxy/proxy/internal/provider/openai.go` (725 lines - handles full format conversion)
- Model router: `/Users/bmf/code/brandon-fryslie_claude-code-proxy/proxy/internal/service/model_router.go` (293 lines)

### Current Configuration

From `/Users/bmf/code/brandon-fryslie_claude-code-proxy/config.yaml.example`:
```yaml
providers:
  anthropic:
    base_url: "https://api.anthropic.com"
    format: "anthropic"
  openai:
    api_key: "..."
    base_url: "https://api.openai.com"
    format: "openai"
  localllm:
    base_url: "localhost:1234"
    format: "openai"

subagents:
  mappings:
    code-reviewer: "openai:gpt-4o"
    planner: "localllm:my-local-agent"
```

### Test Coverage

Existing tests in `/Users/bmf/code/brandon-fryslie_claude-code-proxy/proxy/internal/service/model_router_test.go`:
- TestModelRouter_EdgeCases
- TestModelRouter_ExtractStaticPrompt
- TestModelRouter_ParseMappings
- TestRoutingDecision_ProviderNameAndSubagentName

---

## What ArchGW/Plano Offers

### Key Facts (from web research)

| Aspect | Details |
|--------|---------|
| **Name Change** | ArchGW is now **Plano** (archgw.com redirects to planoai.dev) |
| **Tech Stack** | Rust + Envoy (not Go) |
| **Deployment** | Docker/Docker Compose, Python CLI (`pip install planoai`) |
| **API Format** | OpenAI-compatible (`/v1/chat/completions`) |
| **Configuration** | YAML-based (`plano_config.yaml`) |
| **Provider Support** | 11+ providers: OpenAI, Anthropic, DeepSeek, Mistral, Groq, etc. |

### Plano Routing Features

1. **Model-based Routing** - Direct routing to specific models by provider/model name
2. **Alias-based Routing** - Semantic routing using custom aliases
3. **Preference-aligned Routing** - Arch-Router (1.5B model) routes based on context/preferences

### Additional Plano Features (beyond routing)

- **Guardrails** - Jailbreak detection, content moderation
- **Agent Routing** - Multi-agent orchestration and handoff
- **Observability** - OpenTelemetry-compatible tracing, LLM metrics
- **Context Engineering** - Reusable filters for agent enhancement

---

## Integration Analysis

### Option A: Full Replacement

Replace the Go proxy with Plano entirely.

| Pros | Cons |
|------|------|
| 11+ providers out of box | Lose all custom Go code (984 lines in providers) |
| Built-in guardrails | Lose SQLite request logging |
| OpenTelemetry observability | Lose React dashboard integration |
| Active development | Different tech stack (Rust/Envoy vs Go) |
| | No Anthropic API format input (only OpenAI) |
| | Lose Claude Code subagent routing logic |

**Impact:** HIGH - Complete rewrite of monitoring/dashboard integration

### Option B: Upstream Integration

Keep Go proxy, route through Plano for LLM calls.

```
Client -> Go Proxy (logging, subagent routing) -> Plano -> LLM Providers
```

| Pros | Cons |
|------|------|
| Keep existing monitoring | Added latency (extra hop) |
| Keep subagent routing | Deployment complexity (two services) |
| Gain Plano's provider support | Config duplication |
| Incremental migration | Plano only accepts OpenAI format |

**Impact:** MEDIUM - Requires Anthropic-to-OpenAI conversion before Plano

### Option C: Feature Porting

Port specific Plano features into the existing Go codebase.

| Feature | Effort | Value |
|---------|--------|-------|
| Additional providers | LOW (config-only per vibeproxy research) | HIGH |
| Preference routing | HIGH (would need Arch-Router integration) | MEDIUM |
| Guardrails | MEDIUM-HIGH | MEDIUM |
| OpenTelemetry | MEDIUM | HIGH |

**Impact:** Variable - Cherry-pick features as needed

---

## Critical Ambiguities (NEEDS CLARIFICATION)

### Question 1: What Problem Are We Solving?

**Context:** The current routing system works. What's missing?

**Options:**
- A. More provider support (Gemini, etc.) - Already planned via vibeproxy features
- B. Preference-aware routing (Arch-Router) - New capability
- C. Guardrails/safety features - New capability
- D. Better observability - OpenTelemetry integration
- E. Reduced maintenance burden - Use external project

**Impact of wrong choice:** Significant rework if we choose full replacement but only needed more providers.

### Question 2: Is Anthropic Input Format Required?

**Context:** Plano only accepts OpenAI-format input. Claude Code sends Anthropic format.

**Current state:** The proxy receives Anthropic format and converts to OpenAI when needed.

**If we use Plano:**
- Must convert ALL requests to OpenAI format before sending to Plano
- Lose ability to passthrough Anthropic format to Anthropic API
- Added latency for format conversion

**Question:** Is native Anthropic format support important?

### Question 3: Deployment Constraints?

**Context:** Plano requires Docker/Python. Current proxy is a single Go binary.

**Current deployment:** `go run cmd/proxy/main.go` or `./bin/proxy`

**Plano deployment:** `docker-compose up` or `planoai up config.yaml`

**Question:** Are Docker dependencies acceptable? Is single-binary deployment important?

### Question 4: Integration Scope?

**If integrating (not replacing):**
- Which requests route through Plano? All? Only certain providers?
- How does subagent routing interact with Plano's routing?
- Does Plano replace the provider layer or sit in front of it?

---

## Dependencies and Risks

### Technical Dependencies

| Dependency | Risk | Mitigation |
|------------|------|------------|
| Plano Docker images | External dependency | Pin versions, have fallback |
| Arch-Router model (1.5B) | Model availability, inference cost | Optional feature, can disable |
| OpenAI format requirement | API incompatibility | Conversion layer already exists |

### Implementation Risks

| Risk | Severity | Notes |
|------|----------|-------|
| Breaking existing subagent routing | HIGH | Current routing uses prompt hashing, must be preserved |
| Loss of request logging | HIGH | SQLite storage must continue working |
| Dashboard integration break | MEDIUM | API endpoints must remain compatible |
| Performance regression | MEDIUM | Added latency from format conversion + extra hop |

### Project Risks

| Risk | Severity | Notes |
|------|----------|-------|
| Scope creep | HIGH | ArchGW has many features; easy to over-engineer |
| Maintenance burden | MEDIUM | Two systems to maintain if integrating |
| Learning curve | MEDIUM | Rust/Envoy debugging if issues arise |

---

## Relationship to Other Features

### vibeproxy-feature-analysis (COMPLETED)

The vibeproxy research already produced an implementation plan for:
- Adding Gemini provider (config-only, trivial)
- Multi-account round-robin (moderate changes)

**Overlap:** ArchGW integration could supersede these plans IF full replacement is chosen.

**Recommendation:** Implement vibeproxy features first (lower risk), evaluate ArchGW later.

### web-routing-configuration (PLANNED)

Plan exists to configure subagent routing from web UI.

**Overlap:** If ArchGW is adopted, configuration format changes.

**Recommendation:** Wait for ArchGW decision before implementing web routing config.

---

## Existing Evaluations Reused

| Source | Confidence | Carried Forward |
|--------|------------|-----------------|
| eval-cache/vibeproxy-implementation-plan.md | FRESH | Provider architecture, config patterns |
| ROADMAP.md | FRESH | Feature priorities, topic relationships |

---

## Recommendations

### Immediate

1. **PAUSE this topic** - Too many ambiguities about goals
2. **Proceed with vibeproxy features** - Lower risk, immediate value
3. **Define success criteria** - What would ArchGW integration achieve?

### If Proceeding

1. **Start with Option B (Upstream)** - Lowest risk, reversible
2. **Proof of concept first** - Route a single provider through Plano
3. **Measure latency impact** - Format conversion + extra hop overhead
4. **Preserve subagent routing** - This is critical functionality

### Questions for User

Before proceeding, clarify:

1. **Primary goal?** (Provider support / Preference routing / Guardrails / Observability / Maintenance)
2. **Deployment constraints?** (Docker OK? Single binary required?)
3. **Anthropic format important?** (Passthrough vs always convert)
4. **Integration or replacement?** (Keep Go proxy or migrate away)

---

## Verdict

- [ ] CONTINUE - Issues clear, implementer can proceed
- [x] **PAUSE - Ambiguities need clarification before proceeding**

**Reason:** The integration scope is undefined. "Integrate ArchGW" could mean:
- Full replacement (HIGH effort, HIGH risk)
- Upstream proxy (MEDIUM effort, MEDIUM risk)
- Feature porting (VARIABLE effort, LOW risk)

Cannot estimate complexity or create implementation plan without knowing which approach.

---

## Sources

- [GitHub - katanemo/archgw](https://github.com/katanemo/archgw)
- [Plano AI](https://planoai.dev)
- [ArchGW Documentation](https://docs.archgw.com/guides/llm_router.html) (404 - redirected to Plano)
- [LLM Routing Blog](https://www.archgw.com/blogs/arch-router-outperforming-foundational-models-in-llm-routing-with-a-1-5b-model)
- [Preference-aware Routing for Claude Code](https://www.archgw.com/blogs/preference-aware-routing-for-claude-code-2-0)
