# Sprint Plan: Fix All Failing Playwright E2E Tests

**Generated:** 2026-01-11 05:43:00
**Sprint Duration:** 1 sprint (1-2 hours of focused work)
**Status:** READY FOR IMPLEMENTATION

---

## Sprint Goal

Achieve 100% Playwright test pass rate (33/33 tests passing) by fixing networkidle timeout failures and accessibility violations, establishing robust test patterns for future development.

---

## Scope

### In Scope
- Fix 6 networkidle timeout failures in accessibility tests
- Fix 1 accessibility label failure for icon-only buttons
- Update test helper patterns to avoid future networkidle issues
- Add aria-label attributes to ~15 icon-only buttons
- Update TESTING.md documentation
- Verify all 33 tests pass consistently

### Out of Scope
- Adding new test coverage beyond existing 33 tests
- API mocking infrastructure (defer to future sprint)
- Visual regression testing (defer to future sprint)
- CI/CD pipeline integration (defer to future sprint)
- Performance optimizations beyond test fixes

---

## Work Items

### P0: Fix Networkidle Timeout Failures
**Priority:** CRITICAL - Blocks 6/33 tests (18% of test suite)

**Files to Change:**
- `dashboard/e2e/accessibility.spec.ts` (lines 17, 29, 46)
- `dashboard/e2e/helpers.ts` (line 11)
- `dashboard/e2e/dashboard.spec.ts` (lines 13, 17, 43, 51)
- `dashboard/e2e/requests.spec.ts` (line 44)
- `dashboard/e2e/usage.spec.ts` (lines 10, 17, 36, 44, 57)
- `dashboard/e2e/navigation.spec.ts` (line 8)

**Changes Required:**
Replace `page.waitForLoadState('networkidle')` with `page.waitForLoadState('domcontentloaded')` throughout test suite.

**Rationale:**
- Development environment has persistent network activity (Vite HMR WebSocket, React Query polling)
- `networkidle` waits for ALL network activity to cease - will never achieve in dev
- `domcontentloaded` ensures DOM is ready for interaction without waiting for background requests
- Passing tests (navigation.spec.ts) don't use networkidle - proves pattern works

**Acceptance Criteria:**
1. All 6 accessibility timeout tests pass consistently (100% pass rate over 3 runs)
2. Test execution time reduced from 30s timeout to <5s per test
3. No false negatives - tests still validate page loaded correctly
4. All existing passing tests remain passing (regression check)
5. Tests pass in both development and production builds

---

### P0: Fix Accessibility Label Failures
**Priority:** CRITICAL - Blocks 1/33 tests, represents accessibility violation

**Files to Change:**
1. `dashboard/src/components/layout/Sidebar.tsx` (line 75-85)
2. `dashboard/src/components/charts/DateNavigation.tsx` (lines 65-71, 80-93)
3. `dashboard/src/components/layout/GlobalDatePicker.tsx` (lines 49-60, 66-72, 81-93, 96-102, 107-113, 121-133)
4. `dashboard/src/components/features/DataManagementBar.tsx` (lines 34-46, 50-56)
5. `dashboard/src/components/ui/CodeViewer.tsx` (lines 161-167, 169-176, 216-222)
6. `dashboard/src/components/ui/ImageContent.tsx` (lines 66-72, 73-79, 133-142, 143-149)

**Changes Required:**
Add `aria-label` attributes to ~15 icon-only buttons across 6 components.

**Acceptance Criteria:**
1. Accessibility test "interactive elements should have accessible labels" passes 100% of runs
2. All icon-only buttons have either text content OR aria-label attribute
3. aria-label values are descriptive and match button function
4. No regression - buttons remain functional after changes
5. Manual screen reader testing confirms labels are announced correctly

---

### P1: Update Test Helper Patterns
**Priority:** HIGH - Prevents future regressions

**Files to Change:**
- `dashboard/e2e/helpers.ts` (lines 10-14, add new helper)

**Changes Required:**
1. Update `waitForDashboardLoad()` to use `domcontentloaded`
2. Add new helper: `waitForAPIResponse(page, endpoint)`
3. Document when to use each wait strategy

**Acceptance Criteria:**
1. Helper functions provide clear, robust wait strategies
2. JSDoc comments explain when to use each helper
3. All existing helper usages remain functional
4. New helpers are used in at least 2 test files (demonstrate pattern)
5. Documentation in helpers.ts explains networkidle vs domcontentloaded trade-offs

---

### P1: Update Documentation
**Priority:** HIGH - Prevents knowledge loss

**Files to Change:**
- `dashboard/TESTING.md` (lines 34-49, 93-110)

**Changes Required:**
1. Update "Known Issues" section - remove resolved issues
2. Add "Test Patterns" section with wait strategy guidance
3. Document aria-label requirements for new components
4. Add troubleshooting section for common test failures

**Acceptance Criteria:**
1. TESTING.md accurately reflects current test status (33/33 passing)
2. Wait strategy guidance prevents future networkidle usage
3. Accessibility requirements documented for contributors
4. Troubleshooting section addresses common failure modes
5. Examples show correct patterns for common scenarios

---

## Dependencies

### External Dependencies
1. **Backend API must be running** (port 8000) - CRITICAL
2. **Port 5174 must be available** - MEDIUM
3. **Node dependencies installed** - HIGH

### Internal Dependencies
1. **P0 tasks are independent** - Can be completed in parallel
2. **P1 tasks depend on P0 completion** - Verify tests pass before documenting patterns
3. **Final verification requires all changes** - Run full test suite after all changes applied

---

## Risks

### Technical Risks

**Risk 1: Backend API Not Running During Tests**
- **Likelihood:** HIGH
- **Impact:** HIGH - All tests fail
- **Mitigation:** Add backend health check, document requirement prominently

**Risk 2: Race Conditions in domcontentloaded**
- **Likelihood:** LOW
- **Impact:** MEDIUM - Flaky tests
- **Mitigation:** Combine with explicit element waits

---

## Verification Strategy

### Unit Verification
```bash
cd dashboard
pnpm test e2e/accessibility.spec.ts  # Verify: 14/14 tests passing
pnpm test e2e/accessibility.spec.ts -g "interactive elements"  # Verify: 1/1 passing
```

### Integration Verification
```bash
cd dashboard
pnpm test  # GOAL: 33/33 tests passing

# Stability test (run 3 times)
for i in {1..3}; do
  echo "Run $i"
  pnpm test --reporter=line
done
```

### Manual Verification
1. Start dashboard: `pnpm dev`
2. Navigate to each page
3. Test each button with aria-label changes
4. Verify all buttons function correctly

---

## Success Metrics

**Primary Metrics:**
- Test pass rate: 79% → 100% (26/33 → 33/33)
- Average test execution time: <2 minutes
- Flakiness rate: 0% (consistent 3/3 runs)

**Secondary Metrics:**
- Accessibility violations: 1 → 0
- Test timeout failures: 6 → 0
- Components with aria-labels: ~60% → 100%
