# Evaluation: Fix All Failing Playwright E2E Tests
**Generated:** 2026-01-11 05:43:00
**Status:** CONTINUE (clear path forward)

## Executive Summary

**7 failing tests identified:**
- 6 tests timeout waiting for `networkidle` (Requests, Conversations, Usage pages)
- 1 test fails on accessibility labels (interactive buttons missing aria-labels)

**Root Causes:**
1. `waitForLoadState('networkidle')` incompatible with dev environment (HMR, React Query polling)
2. Icon-only buttons missing `aria-label` attributes
3. Potential backend API not running during test execution

**Fix Complexity:** LOW (1-2 hours)
**Verdict:** CONTINUE - clear solutions identified

---

## Current State Analysis

### What Exists

**Dashboard Infrastructure:**
- Modern React + Vite frontend with TanStack Router and React Query
- 7 main pages with correct routing: Dashboard, Requests, Conversations, Usage, Performance, Routing, Settings
- Playwright configuration at `playwright.config.ts`
- 6 test spec files: navigation, dashboard, requests, usage, conversations, accessibility
- 33 total tests, 26 passing (79% pass rate)

**Test Configuration:**
- Base URL: http://localhost:5174
- Auto-starts dev server: `pnpm dev --port 5174`
- Vite dev server configured on port 8173 with API proxy to localhost:8000
- Screenshot on failure enabled
- HTML reporter configured

**Passing Tests:**
- ✅ All navigation tests (4/4)
- ✅ All dashboard tests (4/4)
- ✅ All requests tests (4/4)
- ✅ Most accessibility tests (2/2 that don't use problematic patterns)

### What's Broken

**Timeout Failures (6 tests):**

Files affected:
- `dashboard/e2e/accessibility.spec.ts:17` - Multiple pages (Requests, Conversations, Usage)
- `dashboard/e2e/accessibility.spec.ts:29` - Multiple pages (Requests, Conversations, Usage)

Error pattern:
```
Test timeout of 30000ms exceeded.
Error: page.waitForLoadState: Test timeout of 30000ms exceeded.
await page.waitForLoadState('networkidle');
```

**Root Cause:** `networkidle` waits for ALL network activity to cease, including:
- Vite HMR (Hot Module Reload) WebSocket connections
- React Query automatic refetching and polling
- Dashboard API calls with retry logic
- Background data refresh timers

In development environments, these never fully idle, causing 30-second timeouts.

**Accessibility Failure (1 test):**

File: `dashboard/e2e/accessibility.spec.ts:44-61`
Test: "interactive elements should have accessible labels"

Error:
```
expect(received).toBeTruthy()
Received: null
```

**Root Cause:** Icon-only buttons lack text content AND `aria-label` attributes.

Likely culprits (need verification):
- Sidebar collapse/expand button (`dashboard/src/components/Sidebar.tsx:76-85`)
- Conversation sort button (`dashboard/src/components/pages/Conversations.tsx:128-135`)
- Various refresh/action buttons throughout

### Configuration Issues

**Port Mismatch:**
- Playwright config: port 5174 (`playwright.config.ts:27, 56`)
- Vite config: port 8173 (`vite.config.ts:14`)
- Resolution: Playwright command specifies `--port 5174` which should override Vite default

**Backend Dependency:**
- Tests make real API calls to `/api/v2/*` endpoints
- No health check to verify backend is running
- No API mocking configured
- If backend (port 8000) isn't running, all API calls hang → networkidle never achieved

**V2 API Endpoints Required:**
- `/api/v2/requests/summary` - Requests, Dashboard
- `/api/v2/requests/{id}` - Request details
- `/api/v2/stats/hourly` - Dashboard, Usage
- `/api/v2/stats/models` - Usage, Performance
- `/api/v2/stats/weekly` - Usage
- `/api/v2/stats/providers` - Dashboard
- `/api/v2/stats/performance` - Performance
- `/api/v2/conversations` - Conversations
- `/api/v2/conversations/{id}` - Conversation details
- `/api/v2/config/providers` - Routing
- `/api/v2/config/subagents` - Routing
- `/api/v2/stats/subagents` - Routing

### What Needs to Change

**Files Requiring Changes:**

1. **dashboard/e2e/accessibility.spec.ts** (lines 17, 29)
   - Replace `waitForLoadState('networkidle')` with `waitForLoadState('domcontentloaded')`
   - Affects 6 failing tests

2. **dashboard/src/components/Sidebar.tsx** (estimated line ~76-85)
   - Add `aria-label="Toggle sidebar"` to collapse button

3. **dashboard/src/components/pages/Conversations.tsx** (estimated line ~128-135)
   - Add `aria-label="Change sort order"` to sort button

4. **Other components with icon-only buttons** (to be identified)
   - Search for `<button>` elements containing only icons
   - Add appropriate `aria-label` attributes

**Optional Improvements:**

5. **dashboard/e2e/helpers.ts**
   - Add `waitForDashboardReady()` helper that checks DOM + key API response
   - Use throughout tests instead of networkidle

6. **dashboard/playwright.config.ts**
   - Add webServer health check: `timeout: 120000`
   - Document backend requirement in comments

## Dependencies & Risks

**External Dependencies:**
- Backend API (port 8000) must be running - **CRITICAL**
  - Without backend, networkidle will never achieve idle state
  - Tests will timeout regardless of DOM readiness
- Caddy reverse proxy must route `/api` to backend - **HIGH**
- Port 5174 must be available - **MEDIUM**

**Risk Factors:**
- Tests are environment-dependent (not fully isolated)
- No API mocking means potential for flaky tests
- Parallel execution may cause timing issues
- HMR connections in dev environment inherently prevent networkidle

**Mitigation:**
- Document backend requirement clearly
- Consider adding API mocking for CI/CD environments
- Use domcontentloaded instead of networkidle for robustness

## Ambiguities & Questions

**RESOLVED:**
- ✅ Why networkidle times out: Dev environment has persistent network activity
- ✅ Which pages fail: Requests, Conversations, Usage (all tested in loop)
- ✅ What buttons lack labels: Icon-only buttons without aria-label
- ✅ Port configuration: Playwright overrides Vite port with CLI flag

**NO BLOCKING AMBIGUITIES** - All information needed for implementation is clear.

## Effort Estimate

**Time to Fix:** 1-2 hours
- Replace networkidle calls: 15 minutes (mechanical change)
- Add aria-labels: 30-45 minutes (identify all buttons, test)
- Verify and test: 30 minutes (run full test suite, verify fixes)
- Documentation: 15 minutes (update TESTING.md)

**Complexity:** LOW
- Changes are localized and straightforward
- No architectural changes needed
- Clear test output shows exact failures

## Verdict: CONTINUE

Clear path forward with specific file changes identified. No blocking ambiguities or architectural decisions needed.
