# Sprint Plan: Date Navigation & Filtering

**Generated**: 2025-12-24-223454
**Source**: STATUS-2025-12-24-164500.md
**Epic**: brandon-fryslie_claude-code-proxy-kbm
**Sprint Goal**: Enable users to navigate through historical data by date and filter requests/stats by date ranges.

---

## Executive Summary

**Current State**: New dashboard hardcodes `getTodayDateRange()` and lacks date navigation UI. Users cannot view historical data.

**Target State**: Full date navigation with week-aware boundaries (Sunday-Saturday), persistent selected date, and efficient refetching logic matching old dashboard patterns.

**Total Items**: 5 work items (2 P0, 2 P1, 1 P2)

---

## Sprint Scope

### In Scope
- Date picker component for selecting arbitrary dates
- Week navigation (previous/next week buttons)
- Persist selected date in URL params or localStorage
- Smart refetching: same week = hourly only, new week = fetch all
- Filter requests API calls by date range
- Snap-to-latest-date feature

### Out of Scope
- Month/year navigation (can add later)
- Custom date range picker (single date + week boundaries only)
- Timezone handling beyond local timezone
- Calendar widget (simple date input is sufficient for MVP)

### Dependencies
- Backend `/api/stats`, `/api/stats/hourly`, `/api/stats/models` endpoints already support `start`/`end` params
- Backend `/api/requests/summary` already supports date filtering

---

## Work Items

### [P0] Implement Week Boundary Calculation Logic

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: CLAUDE.md "Date Navigation" pattern • **Status Reference**: STATUS-2025-12-24-164500.md Section "Data Flow Verification" (lines 246-254)

#### Description
Port the week boundary calculation logic from old dashboard to establish Sunday-Saturday week boundaries for any given date. This is the foundation for all date navigation features.

#### Acceptance Criteria
- [ ] `getWeekBoundaries(date: Date)` function returns `{ weekStart: Date, weekEnd: Date }` where weekStart is Sunday 00:00:00 and weekEnd is Saturday 23:59:59.999
- [ ] Function handles edge cases: month boundaries, year boundaries, leap years
- [ ] Unit tests verify correct week calculation for dates in different months/years
- [ ] Function exported from `lib/utils.ts` for reuse across components

#### Technical Notes
- Reference: `web/app/routes/_index.tsx` lines 217-229
- Use JavaScript Date methods: `getDay()`, `setDate()`, `setHours()`
- Ensure all times are in local timezone (not UTC) for user-facing display

---

### [P0] Add Date Picker Component

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: Week boundary calculation
**Spec Reference**: CLAUDE.md "Week-Aware Navigation" • **Status Reference**: STATUS-2025-12-24-164500.md Section "Feature Gap Analysis" line 121

#### Description
Create a date picker UI component that allows users to select a specific date and navigates to that date's week. Component should integrate with existing stats and requests pages.

#### Acceptance Criteria
- [ ] Date input component renders with current selected date
- [ ] Clicking date input opens native date picker (use `<input type="date">` for simplicity)
- [ ] Selecting a new date triggers data refetch with correct date boundaries
- [ ] Component displays selected date in readable format (e.g., "Dec 24, 2024")
- [ ] E2E test: User selects date → requests list updates to show that day's data

#### Technical Notes
- Use native `<input type="date">` for MVP (can replace with fancy calendar later)
- Place in `PageHeader` actions area alongside filters
- Emit date change event to parent component (Dashboard or Requests page)
- Consider Shadcn date picker component if native input UX is poor

---

### [P1] Build Week Navigation Controls

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: Week boundary calculation, Date picker component
**Spec Reference**: CLAUDE.md "Date Navigation" • **Status Reference**: STATUS-2025-12-24-164500.md Section "Data Flow Verification" line 239

#### Description
Add previous/next week navigation buttons that move the selected date by 7 days while maintaining week boundaries.

#### Acceptance Criteria
- [ ] "Previous Week" button decrements selected date by 7 days and refetches data
- [ ] "Next Week" button increments selected date by 7 days and refetches data
- [ ] Next button disabled if selected week contains today (cannot go into future)
- [ ] Keyboard shortcuts: Arrow left/right navigate weeks (stretch goal)
- [ ] Week range displayed: "Dec 22 - Dec 28" next to navigation buttons

#### Technical Notes
- Reference: `web/app/routes/_index.tsx` week navigation pattern
- Place chevron buttons (`ChevronLeft`, `ChevronRight` from lucide-react) next to date picker
- Use same `getWeekBoundaries()` logic to calculate week range display

---

### [P1] Implement Smart Refetching Logic

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: Week boundary calculation
**Spec Reference**: CLAUDE.md "Smart refetch: Same week? Only hourly. New week? Fetch all." • **Status Reference**: STATUS-2025-12-24-164500.md Section "Data Flow Verification" lines 232-313

#### Description
Optimize data fetching to avoid unnecessary API calls when navigating within the same week. Track current week and only refetch hourly stats if week hasn't changed.

#### Acceptance Criteria
- [ ] State variable tracks `currentWeekStart` (Sunday of current loaded week)
- [ ] Navigating to different day in same week: only fetch hourly + model stats (2 API calls)
- [ ] Navigating to different week: fetch weekly + hourly + model stats (3 API calls)
- [ ] TanStack Query cache configured to prevent redundant fetches within same session
- [ ] Performance test: Navigating same week completes <500ms, new week <1s

#### Technical Notes
- Reference: `web/app/routes/_index.tsx` lines 291-314
- Use TanStack Query's `queryKey` with week boundaries to auto-cache weekly data
- Consider using `keepPreviousData` option for smooth transitions
- Store `currentWeekStart` in component state or query cache metadata

---

### [P2] Persist Selected Date Across Sessions

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: Date picker component
**Spec Reference**: None (quality of life feature) • **Status Reference**: STATUS-2025-12-24-164500.md Section "Feature Gap Analysis" line 121

#### Description
Save user's selected date to localStorage or URL params so that returning to the dashboard shows the same date range they were viewing.

#### Acceptance Criteria
- [ ] Selected date persisted to localStorage on change
- [ ] On page load, read persisted date and use as initial selected date (if valid)
- [ ] If persisted date is >7 days old, default to "today" instead
- [ ] URL param `?date=YYYY-MM-DD` overrides localStorage (for sharing links)
- [ ] Clearing localStorage or invalid date falls back to today

#### Technical Notes
- Use `localStorage.setItem('dashboard.selectedDate', dateString)`
- Parse URL params with React Router's `useSearchParams`
- Validate persisted date: must parse to valid Date object and not be in future
- Consider "snap to latest date" button to quickly return to today

---

## Dependency Graph

```
Week Boundary Calculation (P0)
  ├── Date Picker Component (P0)
  │     ├── Week Navigation Controls (P1)
  │     └── Persist Selected Date (P2)
  └── Smart Refetching Logic (P1)
```

**Critical Path**: Week Boundary → Date Picker → Week Navigation → Smart Refetching

---

## Recommended Sprint Execution Order

1. **Day 1-2**: Implement week boundary calculation + unit tests
2. **Day 3-4**: Build date picker component + integration
3. **Day 5**: Add week navigation controls
4. **Day 6-7**: Implement smart refetching logic
5. **Day 8**: Add date persistence (polish)

**Total Sprint Duration**: 8 days (1-2 weeks)

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Week boundary logic has edge case bugs | Medium | High | Comprehensive unit tests, test across month/year boundaries |
| Smart refetching breaks TanStack Query cache | Medium | Medium | Test cache behavior, use query devtools to debug |
| Date picker UX poor on mobile | Low | Low | Use native input (good mobile support), can upgrade later |
| Timezone confusion (local vs UTC) | High | Medium | Document clearly, stick to local timezone for user-facing dates |

**Overall Risk**: MEDIUM - Straightforward porting of proven patterns, but date handling is notoriously tricky.

---

## Blockers and Questions

### Questions for User

1. **Timezone handling**: Should date navigation respect user's local timezone, or force UTC? (Recommend: local timezone for better UX)

2. **Default date on first load**: Show today, or last date with data? (Recommend: today for consistency)

3. **Future dates**: Allow navigating to future dates (empty data), or disable? (Recommend: disable, cannot go beyond today)

### Blockers

None - all backend APIs already support date filtering.

---

## Testing Strategy

### Unit Tests
- `getWeekBoundaries()` with various dates (month/year boundaries)
- Date picker component renders and emits events
- Week navigation increment/decrement logic

### Integration Tests
- Date selection triggers correct API calls with proper date params
- Smart refetching loads from cache when appropriate
- Persisted date restores on page reload

### E2E Tests
- User flow: Select date → see filtered requests → navigate week → see updated data
- Edge case: Select date at year boundary → verify correct week display

---

## Success Metrics

- Users can navigate to any historical date within 2 clicks (date picker + select)
- Week navigation feels instant (<500ms) when staying in same week
- Date selection persists across browser sessions
- Zero timezone-related bugs in first 2 weeks of usage

---

## Appendix: Code References

**Old Dashboard Files**:
- `web/app/routes/_index.tsx` lines 217-229 (week boundaries)
- `web/app/routes/_index.tsx` lines 231-244 (loadWeeklyStats)
- `web/app/routes/_index.tsx` lines 246-258 (getLocalDayBoundaries)
- `web/app/routes/_index.tsx` lines 291-314 (loadStats with smart refetch)

**New Dashboard Files to Modify**:
- `dashboard/src/lib/utils.ts` (add date utilities)
- `dashboard/src/pages/Dashboard.tsx` (integrate date picker)
- `dashboard/src/pages/Requests.tsx` (integrate date filtering)
- `dashboard/src/lib/api.ts` (update API hooks for date params)
