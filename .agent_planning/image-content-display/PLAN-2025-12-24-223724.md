# Sprint Plan: Image Content Display

**Generated**: 2025-12-24-223724
**Source**: STATUS-20251224.md (dashboard-parity evaluation)
**Epic**: brandon-fryslie_claude-code-proxy-asz
**Sprint Goal**: Implement inline base64 image rendering with download and fullscreen zoom capabilities for images in message content blocks.

---

## Executive Summary

**Current State** (from STATUS-20251224.md):
- New dashboard displays images as raw base64 strings or JSON objects
- Missing dedicated ImageContent component that old dashboard has (143 LOC)
- No inline image rendering in message content
- No download or fullscreen viewing capabilities
- No handling of different image content structures (Claude API format, alternative formats)

**Target State** (from web/app/components/ImageContent.tsx):
- Detect and render base64 images inline
- Support Claude API format (`source.data`, `source.media_type`)
- Support alternative format (`data`, `media_type`)
- Download button to save images locally
- Fullscreen zoom with lightbox modal
- Error handling for invalid/missing image data
- Proper data URI construction for various formats

**Gap**: New dashboard needs a complete ImageContent component to match old dashboard's image visualization.

---

## Scope

### In Scope
- Create ImageContent component in `dashboard/src/components/`
- Parse image content from `AnthropicContentBlock` type (type: "image")
- Handle Claude API format (`content.source.data`, `content.source.media_type`)
- Handle alternative format (`content.data`, `content.media_type`)
- Construct proper data URIs for base64 images
- Display images inline with responsive sizing
- Add download button to save images as files
- Add fullscreen zoom button with modal overlay
- Handle missing image data gracefully (show error state)
- Handle image load errors (show error state with raw data)
- Integrate with MessageContent component in Requests page

### Out of Scope
- Backend changes to image logging or storage
- Image compression or optimization
- Image format conversion (e.g., PNG to JPEG)
- Image editing or annotation
- Multiple image gallery view
- Image metadata extraction (EXIF, etc.)

### Deferred
- Image thumbnails in request list
- Image comparison between requests
- Image search/filtering
- Image lazy loading optimization
- Advanced zoom controls (pan, zoom levels)

---

## Work Items

### [P0] Create Base ImageContent Component

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None
**Spec Reference**: web/app/components/ImageContent.tsx • **Status Reference**: STATUS-20251224.md §2.2 (Advanced Features)

#### Description
Create the core ImageContent component that detects image content blocks, extracts data and media type, and displays images inline with controls.

#### Acceptance Criteria
- [ ] Component accepts content prop with image data structure
- [ ] Component extracts imageData from content.source.data (Claude API format)
- [ ] Component extracts imageData from content.data (alternative format)
- [ ] Component extracts mediaType from content.source.media_type or content.media_type
- [ ] Component defaults to 'image/png' if mediaType missing
- [ ] Component shows error state if imageData missing
- [ ] Component uses lucide-react icons: ImageIcon, Download, Maximize2, X
- [ ] Unit tests cover both content formats and missing data

#### Technical Notes
- Props type: `{ content: { source?: { type: string, media_type: string, data: string }, data?: string, media_type?: string } }`
- Extract pattern: `imageData = content.source?.data || content.data`
- Extract pattern: `mediaType = content.source?.media_type || content.media_type`
- Error state: `bg-amber-50 border border-amber-200` with warning message

---

### [P0] Implement Data URI Construction

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: Create Base ImageContent Component
**Spec Reference**: ImageContent.tsx lines 45-48 • **Status Reference**: STATUS-20251224.md §2.2

#### Description
Construct proper data URIs for base64 images, handling both pre-formatted URIs and raw base64 strings. Ensures images render correctly in <img> tags.

#### Acceptance Criteria
- [ ] Detects if imageData already has 'data:' prefix
- [ ] Passes through data URIs unchanged if already formatted
- [ ] Constructs data URI for raw base64: `data:{mediaType};base64,{imageData}`
- [ ] Uses extracted mediaType or defaults to 'image/png'
- [ ] Data URI works in <img> src attribute
- [ ] Unit tests verify URI construction for all cases

#### Technical Notes
- Check: `imageData.startsWith('data:') ? imageData : ...`
- Construct: `` `data:${mediaType || 'image/png'};base64,${imageData}` ``
- No validation of base64 encoding (browser handles invalid data)
- Media types: image/png, image/jpeg, image/gif, image/webp, etc.

---

### [P1] Add Download Functionality

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: Implement Data URI Construction
**Spec Reference**: ImageContent.tsx lines 50-57 • **Status Reference**: STATUS-20251224.md §2.2

#### Description
Add download button that saves images to user's local filesystem with appropriate filename and extension based on media type.

#### Acceptance Criteria
- [ ] Download button appears in image header (Download icon)
- [ ] Button creates temporary <a> element with download attribute
- [ ] Button sets href to data URI
- [ ] Button generates filename: `image-{timestamp}.{extension}`
- [ ] Extension extracted from mediaType (e.g., 'image/png' → 'png')
- [ ] Button removes <a> element after triggering download
- [ ] Button has hover state with gray accent
- [ ] Unit tests verify download behavior (mock DOM methods)

#### Technical Notes
- Create element: `const link = document.createElement('a')`
- Set properties: `link.href = dataUri; link.download = filename`
- Trigger: `document.body.appendChild(link); link.click(); document.body.removeChild(link)`
- Filename: `` `image-${Date.now()}.${mediaType?.split('/')[1] || 'png'}` ``
- Button position: image header, next to Maximize2 button

---

### [P1] Implement Inline Image Display

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: Implement Data URI Construction
**Spec Reference**: ImageContent.tsx lines 78-114 • **Status Reference**: STATUS-20251224.md §2.2

#### Description
Display images inline within message content with responsive sizing, rounded corners, and click-to-zoom functionality.

#### Acceptance Criteria
- [ ] Image renders in <img> tag with data URI as src
- [ ] Image has max-width: 100% for responsive sizing
- [ ] Image has auto height to maintain aspect ratio
- [ ] Image has rounded corners (rounded class)
- [ ] Image has pointer cursor to indicate clickability
- [ ] Image is wrapped in white background card with padding
- [ ] Image header shows media type and icon
- [ ] Image click triggers fullscreen view
- [ ] Image has onError handler to show error state

#### Technical Notes
- Container: `bg-gray-50 border border-gray-200 rounded-lg p-4`
- Image wrapper: `bg-white rounded border border-gray-200 p-2`
- Image: `<img src={dataUri} alt="Content image" className="max-w-full h-auto rounded cursor-pointer" onClick={() => setIsFullscreen(true)} onError={() => setImageError(true)} />`
- Header shows: ImageIcon + "Image ({mediaType})"

---

### [P1] Add Fullscreen Zoom Modal

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: Implement Inline Image Display
**Spec Reference**: ImageContent.tsx lines 116-142 • **Status Reference**: STATUS-20251224.md §2.2

#### Description
Implement fullscreen lightbox modal that displays image at maximum size with dark overlay, close button, and click-outside-to-close behavior.

#### Acceptance Criteria
- [ ] Maximize button in header triggers fullscreen modal
- [ ] Click on inline image triggers fullscreen modal
- [ ] Modal uses fixed positioning with z-50
- [ ] Modal has dark overlay (bg-black bg-opacity-90)
- [ ] Modal displays image centered with max-w-90vw max-h-90vh
- [ ] Close button appears above image (X icon)
- [ ] Click on overlay closes modal
- [ ] Click on image does not close modal (stopPropagation)
- [ ] Close button click closes modal
- [ ] Unit tests verify modal open/close behavior

#### Technical Notes
- State: `const [isFullscreen, setIsFullscreen] = useState(false)`
- Modal container: `fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center p-4`
- Image container: `relative max-w-[90vw] max-h-[90vh]`
- Close button: `absolute -top-10 right-0 p-2 text-white hover:text-gray-300`
- Overlay click: `onClick={() => setIsFullscreen(false)}`
- Image click: `onClick={(e) => e.stopPropagation()}`

---

### [P0] Implement Error Handling

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: Create Base ImageContent Component
**Spec Reference**: ImageContent.tsx lines 34-43, 59-76 • **Status Reference**: STATUS-20251224.md §2.2

#### Description
Add comprehensive error handling for missing image data, invalid data URIs, and image load failures with informative error states.

#### Acceptance Criteria
- [ ] Shows warning state if imageData is undefined/null
- [ ] Warning state displays amber background with ImageIcon
- [ ] Warning state shows "No image data available" message
- [ ] Shows error state if image fails to load (onError event)
- [ ] Error state displays red background with ImageIcon
- [ ] Error state shows "Failed to load image" message
- [ ] Error state includes collapsible raw data details
- [ ] Unit tests verify all error states

#### Technical Notes
- Missing data check: `if (!imageData) return <div className="bg-amber-50 border border-amber-200">...</div>`
- Load error state: `const [imageError, setImageError] = useState(false)`
- onError handler: `<img ... onError={() => setImageError(true)} />`
- Error view: `bg-red-50 border border-red-200` with details section
- Raw data: `<pre>{JSON.stringify(content, null, 2)}</pre>`

---

### [P0] Integrate ImageContent with MessageContent

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: Create Base ImageContent Component
**Spec Reference**: web/app/components/MessageContent.tsx line 93 • **Status Reference**: STATUS-20251224.md §2.2

#### Description
Update MessageContent component to use new ImageContent component when rendering content blocks of type "image". Ensures images appear in request detail view.

#### Acceptance Criteria
- [ ] MessageContent imports ImageContent component
- [ ] MessageContent renders ImageContent for content.type === 'image'
- [ ] Passes entire content object to ImageContent component
- [ ] Handles missing or malformed image content gracefully
- [ ] Integration tests verify image rendering in full request view
- [ ] Images appear correctly in Requests page detail panel
- [ ] Multiple images in single message render sequentially

#### Technical Notes
- MessageContent location: `dashboard/src/components/MessageContent.tsx` (create if missing)
- Content block type from AnthropicContentBlock: `{ type: 'image', source?: {...}, data?: string, media_type?: string }`
- Pattern: `case 'image': return <ImageContent content={content} />`
- MessageContent handles array of content blocks, so multiple images work automatically

---

## Dependencies

### Component Dependencies
```
ImageContent Component
├── lucide-react icons (ImageIcon, Download, Maximize2, X)
└── React.useState (for fullscreen modal state)

MessageContent Component
└── ImageContent Component
```

### Data Flow
```
AnthropicRequest (backend)
└── messages[].content[] (AnthropicContentBlock)
    └── { type: 'image', source: { data, media_type } }
        └── <ImageContent> component
            ├── Extract data URI
            ├── Render inline image
            └── Fullscreen modal on click
```

---

## Recommended Sprint Planning

### Sprint Breakdown (1 sprint = 1 week)

**Week 1: Complete Image Display**
1. Create Base ImageContent Component (P0)
2. Implement Data URI Construction (P0)
3. Implement Error Handling (P0)
4. Implement Inline Image Display (P1)
5. Add Download Functionality (P1)
6. Add Fullscreen Zoom Modal (P1)
7. Integrate ImageContent with MessageContent (P0)

**Note**: This is a smaller epic (143 LOC vs 200+ for ToolUse/ToolResult), so can be completed in a single sprint.

---

## Risk Assessment

### Low Risk
- **Browser Compatibility**: Data URIs are widely supported across all modern browsers
  - **Mitigation**: No special handling needed

- **Large Images**: Very large base64 strings might impact performance
  - **Mitigation**: Browser handles this naturally; no special optimization needed for MVP

- **Media Type Variations**: Some images might have unusual media types
  - **Mitigation**: Default to 'image/png' if unrecognized

### Very Low Risk
- **Download Feature**: Modern browsers fully support programmatic downloads
  - **Mitigation**: Standard implementation, no fallbacks needed

---

## Testing Strategy

### Unit Tests
- ImageContent component rendering (both content formats)
- Data URI construction (prefixed, raw, with/without mediaType)
- Error states (missing data, load failure)
- Download functionality (mock DOM methods)
- Fullscreen modal open/close behavior

### Integration Tests
- MessageContent → ImageContent integration
- Multiple images in single message
- Mixed content (text, images, tool calls)

### Manual Testing
- Verify images render inline in Requests page
- Test download with various image formats (PNG, JPEG, WebP)
- Test fullscreen zoom and close behaviors
- Test error states with malformed data
- Verify responsive sizing on different screen sizes

---

## Definition of Done

See DOD-2025-12-24-223724.md for detailed acceptance criteria.

**Sprint Complete When**:
- ✅ All P0 work items completed and tested
- ✅ All P1 work items completed and tested
- ✅ Images visible inline in new dashboard Requests page
- ✅ Download functionality working across browsers
- ✅ Fullscreen zoom working with proper close behavior
- ✅ Error states show appropriate messages
- ✅ Unit tests passing (>80% coverage)
- ✅ Integration tests passing
- ✅ Manual testing verified on real request data with images

---

## Blockers and Questions

### Blockers
None - this epic has no external dependencies.

### Questions
1. **Component Location**: Should ImageContent go in `components/` or `components/messages/` subdirectory?
2. **Image Optimization**: Should we implement lazy loading or thumbnails for performance? (Deferred to future sprint)
3. **Media Type Support**: Are there specific image formats we should test with or validate? (Current approach: accept all, let browser handle)
4. **Fullscreen Controls**: Should we add zoom controls (pan, zoom levels) or keep simple for MVP? (Currently simple click-to-view)

---

## Success Metrics

- **Feature Parity**: Images match old dashboard visualization quality
- **Download Success**: 100% success rate for download functionality
- **Load Performance**: Images load without blocking page render
- **Error Recovery**: Clear error messages for all failure cases
- **User Experience**: Fullscreen zoom feels natural and responsive
- **Code Quality**: Component is simple, reusable, well-tested
