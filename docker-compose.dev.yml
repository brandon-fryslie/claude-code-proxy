# Docker Compose for Claude Code Proxy - Full Development Stack
#
# Includes all services + web dashboards for development.
# HMR (Hot Module Reload) is configured for both frontends.
#
# Services:
# - caddy: Reverse proxy (port 3000)
# - proxy-core: API proxy (port 3001)
# - proxy-data: Dashboard APIs (port 3002)
# - web: Legacy web dashboard (port 5173) with HMR
# - dashboard: New dashboard (port 5174) with HMR
#
# Usage:
#   docker compose -f docker-compose.dev.yml up --build
#
# For best HMR performance, use docker compose -f docker-compose.backend.yml instead
# and run frontends locally.

version: '3.8'

services:
  # Caddy reverse proxy - unified entrypoint
  caddy:
    image: caddy:2-alpine
    container_name: claude-proxy-caddy
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./docker/Caddyfile.dev:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - proxy-core
      - proxy-data
    networks:
      - proxy-network

  # proxy-core - Lightweight API proxy
  proxy-core:
    build:
      context: .
      dockerfile: docker/Dockerfile.proxy-core
    container_name: claude-proxy-core
    restart: unless-stopped
    expose:
      - "3001"
    environment:
      - PROXY_CORE_PORT=3001
      - DB_PATH=/app/data/requests.db
    volumes:
      - ./data:/app/data
      - ./config.yaml:/app/config.yaml:ro
    networks:
      - proxy-network

  # proxy-data - Dashboard APIs and data processing
  proxy-data:
    build:
      context: .
      dockerfile: docker/Dockerfile.proxy-data
    container_name: claude-proxy-data
    restart: unless-stopped
    expose:
      - "3002"
    environment:
      - PROXY_DATA_PORT=3002
      - DB_PATH=/app/data/requests.db
    volumes:
      - ./data:/app/data
      - ./config.yaml:/app/config.yaml:ro
      - ~/.claude/projects:/root/.claude/projects:ro
    networks:
      - proxy-network

  # Legacy web dashboard with HMR
  web:
    image: node:20-alpine
    container_name: claude-proxy-web
    working_dir: /app
    command: sh -c "pnpm install && pnpm dev --host 0.0.0.0"
    ports:
      - "5173:5173"
      - "24678:24678"  # Vite HMR websocket port
    volumes:
      - ./web:/app
      - web_node_modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:3000
      - VITE_HMR_HOST=localhost
      - VITE_HMR_PORT=24678
    networks:
      - proxy-network
    stdin_open: true
    tty: true

  # New dashboard with HMR
  dashboard:
    image: node:20-alpine
    container_name: claude-proxy-dashboard
    working_dir: /app
    command: sh -c "pnpm install && pnpm dev --host 0.0.0.0 --port 5173"
    ports:
      - "5174:5173"
      - "24679:24679"  # Vite HMR websocket port
    volumes:
      - ./dashboard:/app
      - dashboard_node_modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:3000
      - VITE_HMR_HOST=localhost
      - VITE_HMR_PORT=24679
    networks:
      - proxy-network
    stdin_open: true
    tty: true

networks:
  proxy-network:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
  web_node_modules:
  dashboard_node_modules:
