# Claude Code Proxy - Caddy Reverse Proxy Configuration for Docker
#
# This Caddyfile routes requests to the appropriate backend service:
# - /v1/* routes to proxy-core - lightweight proxy
# - /api/* routes to proxy-data - dashboard APIs
# - /health routes to proxy-core for health checks
#
# Uses Docker service names for networking

{
	# Global options
	admin off  # Disable admin API in production
}

:8000 {
	# Enable gzip compression
	encode gzip

	# Logging
	log {
		output stdout
		format console
	}

	# Health check - route to proxy-core
	handle /health {
		reverse_proxy proxy-core:8001
	}

	# Proxy API routes - route to proxy-core
	handle /v1/* {
		reverse_proxy proxy-core:8001 {
			# Enable streaming for SSE responses
			flush_interval -1
		}
	}

	# Dashboard API routes - route to proxy-data
	handle /api/* {
		reverse_proxy proxy-data:8002
	}

	# UI routes - route to proxy-data
	handle /ui {
		reverse_proxy proxy-data:8002
	}

	# Root path - route to proxy-data for UI
	handle / {
		reverse_proxy proxy-data:8002
	}

	# Fallback - 404 for unmatched routes
	handle {
		respond "Not Found" 404
	}
}
